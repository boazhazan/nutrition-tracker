<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>××–×•×Ÿ ×—×›× - ××¢×§×‘ ×ª×–×•× ×”</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #22263a;
    --accent: #00d4aa;
    --accent2: #ff6b6b;
    --accent3: #ffd93d;
    --text: #e8eaf0;
    --text-dim: #8892a4;
    --border: rgba(255,255,255,0.08);
    --protein-color: #00d4aa;
    --carb-color: #ffd93d;
    --fat-color: #ff8c42;
    --sugar-color: #ff6b6b;
    --cal-color: #a78bfa;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Heebo', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; direction: rtl; }

  .header { background: linear-gradient(135deg, #0f1117 0%, #1a1d27 100%); border-bottom: 1px solid var(--border); padding: 16px 20px; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(20px); }
  .header-inner { max-width: 900px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
  .logo { font-size: 22px; font-weight: 900; background: linear-gradient(135deg, var(--accent), #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
  .profile-toggle { display: flex; gap: 8px; }
  .profile-btn { padding: 6px 16px; border-radius: 20px; border: 1px solid var(--border); background: transparent; color: var(--text-dim); cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 14px; transition: all 0.2s; }
  .profile-btn.active { background: var(--accent); color: #000; border-color: var(--accent); font-weight: 700; }

  .main { max-width: 900px; margin: 0 auto; padding: 20px; display: grid; gap: 20px; }

  .daily-summary { background: var(--surface); border-radius: 20px; padding: 20px; border: 1px solid var(--border); }
  .summary-title { font-size: 13px; color: var(--text-dim); margin-bottom: 16px; font-weight: 500; text-transform: uppercase; letter-spacing: 1px; }
  .macros-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px; }
  .macro-card { background: var(--surface2); border-radius: 14px; padding: 14px; text-align: center; position: relative; overflow: hidden; }
  .macro-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
  .macro-card.protein::before { background: var(--protein-color); }
  .macro-card.carbs::before { background: var(--carb-color); }
  .macro-card.fat::before { background: var(--fat-color); }
  .macro-card.sugar::before { background: var(--sugar-color); }
  .macro-value { font-size: 28px; font-weight: 900; line-height: 1; margin-bottom: 2px; }
  .macro-card.protein .macro-value { color: var(--protein-color); }
  .macro-card.carbs .macro-value { color: var(--carb-color); }
  .macro-card.fat .macro-value { color: var(--fat-color); }
  .macro-card.sugar .macro-value { color: var(--sugar-color); }
  .macro-label { font-size: 12px; color: var(--text-dim); margin-bottom: 6px; }
  .macro-target { font-size: 11px; color: var(--text-dim); }

  .calorie-section { background: var(--surface2); border-radius: 14px; padding: 14px; }
  .calorie-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .calorie-label { font-size: 14px; color: var(--text-dim); }
  .calorie-current { color: var(--cal-color); font-weight: 700; font-size: 20px; }
  .calorie-max { color: var(--text-dim); }
  .progress-bar { height: 10px; background: rgba(255,255,255,0.08); border-radius: 10px; overflow: hidden; }
  .progress-fill { height: 100%; border-radius: 10px; transition: width 0.5s ease; background: linear-gradient(90deg, var(--cal-color), #ec4899); }
  .progress-fill.over { background: linear-gradient(90deg, #ff6b6b, #ef4444); }

  .alerts { margin-top: 12px; display: flex; flex-direction: column; gap: 6px; }
  .alert { padding: 8px 12px; border-radius: 10px; font-size: 13px; display: flex; align-items: center; gap: 8px; }
  .alert.warning { background: rgba(255,107,107,0.15); border: 1px solid rgba(255,107,107,0.3); color: #ff9999; }
  .alert.success { background: rgba(0,212,170,0.15); border: 1px solid rgba(0,212,170,0.3); color: var(--accent); }
  .alert.info { background: rgba(255,217,61,0.15); border: 1px solid rgba(255,217,61,0.3); color: var(--accent3); }

  .protein-progress { margin-top: 12px; background: var(--surface2); border-radius: 14px; padding: 14px; }
  .protein-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }

  .settings-panel { background: var(--surface); border-radius: 20px; padding: 20px; border: 1px solid var(--border); display: none; }
  .settings-panel.open { display: block; }
  .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .settings-section h3 { font-size: 14px; color: var(--accent); margin-bottom: 12px; font-weight: 700; }
  .setting-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  .setting-label { font-size: 13px; color: var(--text-dim); }
  .setting-input { width: 90px; padding: 6px 10px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: 'Heebo', sans-serif; font-size: 14px; text-align: center; }
  .setting-input:focus { outline: none; border-color: var(--accent); }
  .settings-toggle-btn { display: flex; align-items: center; gap: 8px; background: transparent; border: 1px solid var(--border); color: var(--text-dim); padding: 8px 16px; border-radius: 10px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 13px; transition: all 0.2s; }
  .settings-toggle-btn:hover { border-color: var(--accent); color: var(--accent); }
  /* Toggle switch */
  .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; flex-shrink: 0; }
  .toggle-switch input { opacity: 0; width: 0; height: 0; }
  .toggle-slider { position: absolute; cursor: pointer; inset: 0; background: var(--surface2); border-radius: 26px; transition: 0.3s; border: 1px solid var(--border); }
  .toggle-slider::before { content: ''; position: absolute; height: 18px; width: 18px; right: 3px; bottom: 3px; background: var(--text-dim); border-radius: 50%; transition: 0.3s; }
  .toggle-switch input:checked + .toggle-slider { background: var(--accent); border-color: var(--accent); }
  .toggle-switch input:checked + .toggle-slider::before { background: #000; transform: translateX(-24px); }

  .save-settings-btn { background: var(--accent); color: #000; border: none; padding: 10px 24px; border-radius: 10px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 14px; font-weight: 700; margin-top: 16px; transition: all 0.2s; }
  .save-settings-btn:hover { opacity: 0.9; transform: translateY(-1px); }

  .input-area { background: var(--surface); border-radius: 20px; padding: 20px; border: 1px solid var(--border); }
  .input-area h2 { font-size: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
  .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
  .tab-btn { flex: 1; padding: 10px; border-radius: 12px; border: 1px solid var(--border); background: transparent; color: var(--text-dim); cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 14px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
  .tab-btn.active { background: var(--surface2); border-color: var(--accent); color: var(--accent); }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  textarea { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 14px; color: var(--text); font-family: 'Heebo', sans-serif; font-size: 15px; padding: 14px; resize: none; height: 100px; direction: rtl; line-height: 1.6; transition: border-color 0.2s; }
  textarea:focus { outline: none; border-color: var(--accent); }
  textarea::placeholder { color: var(--text-dim); }

  .image-drop { border: 2px dashed var(--border); border-radius: 14px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; }
  .image-drop:hover { border-color: var(--accent); background: rgba(0,212,170,0.05); }
  .image-drop input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
  .drop-icon { font-size: 40px; margin-bottom: 10px; }
  .drop-text { color: var(--text-dim); font-size: 14px; }
  .drop-text strong { color: var(--accent); }
  .image-preview { margin-top: 12px; position: relative; display: none; }
  .image-preview img { width: 100%; max-height: 250px; object-fit: contain; border-radius: 12px; }
  .remove-image { position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.7); border: none; color: white; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; }

  .analyze-btn { width: 100%; margin-top: 14px; padding: 14px; background: linear-gradient(135deg, var(--accent), #00b890); color: #000; border: none; border-radius: 14px; font-family: 'Heebo', sans-serif; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
  .analyze-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,212,170,0.3); }
  .analyze-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
  .spinner { width: 18px; height: 18px; border: 2px solid rgba(0,0,0,0.3); border-top-color: #000; border-radius: 50%; animation: spin 0.7s linear infinite; display: none; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .result-card { background: var(--surface); border-radius: 20px; border: 1px solid var(--border); overflow: hidden; display: none; }
  .result-card.visible { display: block; }
  .result-header { padding: 16px 20px; background: linear-gradient(135deg, rgba(0,212,170,0.1), rgba(167,139,250,0.1)); border-bottom: 1px solid var(--border); }
  .result-meal-name { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
  .result-portions { font-size: 13px; color: var(--text-dim); }
  .result-macros { display: grid; grid-template-columns: repeat(5, 1fr); border-bottom: 1px solid var(--border); }
  .result-macro { padding: 16px; text-align: center; border-left: 1px solid var(--border); }
  .result-macro:last-child { border-left: none; }
  .result-macro-val { font-size: 22px; font-weight: 900; display: block; margin-bottom: 2px; }
  .result-macro-lbl { font-size: 11px; color: var(--text-dim); }
  .result-macro.cal .result-macro-val { color: var(--cal-color); }
  .result-macro.prot .result-macro-val { color: var(--protein-color); }
  .result-macro.carb .result-macro-val { color: var(--carb-color); }
  .result-macro.fat .result-macro-val { color: var(--fat-color); }
  .result-macro.sug .result-macro-val { color: var(--sugar-color); }
  .result-notes { padding: 16px 20px; font-size: 14px; color: var(--text-dim); line-height: 1.7; }
  .result-actions { padding: 12px 20px; display: flex; gap: 10px; border-top: 1px solid var(--border); }
  .add-to-day-btn { flex: 1; padding: 10px; background: var(--accent); color: #000; border: none; border-radius: 10px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 14px; font-weight: 700; transition: all 0.2s; }
  .add-to-day-btn:hover { opacity: 0.9; }
  .discard-btn { padding: 10px 20px; background: transparent; color: var(--text-dim); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 14px; transition: all 0.2s; }
  .discard-btn:hover { border-color: var(--accent2); color: var(--accent2); }

  /* CHAT */
  .chat-section { background: var(--surface); border-radius: 20px; border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; }
  .chat-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, rgba(0,212,170,0.08), rgba(167,139,250,0.08)); }
  .chat-header h2 { font-size: 16px; display: flex; align-items: center; gap: 8px; }
  .chat-badge { font-size: 10px; background: var(--accent); color: #000; padding: 2px 8px; border-radius: 20px; font-weight: 700; }
  .chat-clear-btn { background: transparent; border: 1px solid var(--border); color: var(--text-dim); padding: 4px 12px; border-radius: 8px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 12px; transition: all 0.2s; }
  .chat-clear-btn:hover { border-color: var(--accent2); color: var(--accent2); }
  .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; min-height: 300px; max-height: 450px; }
  .chat-welcome { text-align: center; padding: 24px 20px; color: var(--text-dim); }
  .chat-welcome .welcome-icon { font-size: 44px; margin-bottom: 10px; }
  .chat-welcome h3 { font-size: 16px; color: var(--text); margin-bottom: 8px; }
  .chat-welcome p { font-size: 13px; line-height: 1.6; }
  .chat-suggestions { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 14px; }
  .suggestion-chip { background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim); padding: 6px 14px; border-radius: 20px; font-size: 12px; cursor: pointer; font-family: 'Heebo', sans-serif; transition: all 0.2s; }
  .suggestion-chip:hover { border-color: var(--accent); color: var(--accent); background: rgba(0,212,170,0.08); }
  .msg { display: flex; gap: 10px; animation: fadeUp 0.3s ease; }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .msg.user { flex-direction: row-reverse; }
  .msg-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; margin-top: 2px; }
  .msg.user .msg-avatar { background: var(--accent); }
  .msg.ai .msg-avatar { background: var(--surface2); border: 1px solid var(--border); }
  .msg-bubble { max-width: 80%; padding: 12px 16px; border-radius: 16px; font-size: 14px; line-height: 1.7; white-space: pre-wrap; }
  .msg.user .msg-bubble { background: var(--accent); color: #000; border-bottom-left-radius: 4px; }
  .msg.ai .msg-bubble { background: var(--surface2); color: var(--text); border-bottom-right-radius: 4px; }
  .msg-typing .msg-bubble { display: flex; gap: 4px; align-items: center; padding: 14px 18px; }
  .typing-dot { width: 8px; height: 8px; background: var(--text-dim); border-radius: 50%; animation: typingBounce 1.2s infinite; }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes typingBounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }
  .chat-input-row { padding: 14px 16px; border-top: 1px solid var(--border); display: flex; gap: 10px; align-items: flex-end; }
  .chat-input { flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 14px; color: var(--text); font-family: 'Heebo', sans-serif; font-size: 14px; padding: 10px 14px; resize: none; direction: rtl; line-height: 1.5; height: 42px; max-height: 100px; transition: border-color 0.2s; }
  .chat-input:focus { outline: none; border-color: var(--accent); }
  .chat-input::placeholder { color: var(--text-dim); }
  .chat-send-btn { width: 42px; height: 42px; background: var(--accent); border: none; border-radius: 12px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
  .chat-send-btn:hover { transform: scale(1.05); opacity: 0.9; }
  .chat-send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  /* Meal Log */
  .meal-log { background: var(--surface); border-radius: 20px; padding: 20px; border: 1px solid var(--border); }
  .meal-log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .meal-log-header h2 { font-size: 16px; }
  .reset-btn { padding: 6px 14px; background: transparent; color: var(--accent2); border: 1px solid rgba(255,107,107,0.3); border-radius: 8px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 12px; transition: all 0.2s; }
  .reset-btn:hover { background: rgba(255,107,107,0.1); }
  .meal-item { background: var(--surface2); border-radius: 14px; padding: 14px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; gap: 12px; animation: slideIn 0.3s ease; }
  @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
  .meal-info { flex: 1; }
  .meal-name { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
  .meal-macros-mini { font-size: 12px; color: var(--text-dim); display: flex; gap: 12px; flex-wrap: wrap; }
  .meal-cal { color: var(--cal-color); font-weight: 700; font-size: 16px; }
  .delete-meal { background: transparent; border: none; color: var(--text-dim); cursor: pointer; padding: 4px 8px; border-radius: 6px; font-size: 16px; transition: all 0.2s; }
  .delete-meal:hover { color: var(--accent2); background: rgba(255,107,107,0.1); }
  .empty-log { text-align: center; padding: 30px; color: var(--text-dim); font-size: 14px; }
  .empty-log .empty-icon { font-size: 40px; margin-bottom: 10px; }

  .loading-message { text-align: center; padding: 20px; color: var(--text-dim); font-size: 14px; display: none; }
  .loading-message.visible { display: block; }
  .loading-dots::after { content: ''; animation: dots 1.5s infinite; }
  @keyframes dots { 0% { content: '.'; } 33% { content: '..'; } 66% { content: '...'; } }

  /* Save day button */
  .save-day-btn { padding: 6px 14px; background: linear-gradient(135deg, var(--accent), #00b890); color: #000; border: none; border-radius: 8px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 12px; font-weight: 700; transition: all 0.2s; }
  .save-day-btn:hover { opacity: 0.9; transform: translateY(-1px); }
  .transfer-btn { padding: 6px 14px; background: linear-gradient(135deg, #a78bfa, #7c3aed); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 12px; font-weight: 700; transition: all 0.2s; }
  .transfer-btn:hover { opacity: 0.9; transform: translateY(-1px); }

  /* History */
  .history-section { background: var(--surface); border-radius: 20px; padding: 20px; border: 1px solid var(--border); }
  .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .history-header h2 { font-size: 16px; }
  .report-btn { padding: 7px 16px; background: #a78bfa; color: #000; border: none; border-radius: 8px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 13px; font-weight: 700; transition: all 0.2s; }
  .report-btn:hover { opacity: 0.9; }

  .history-day { background: var(--surface2); border-radius: 14px; padding: 16px; margin-bottom: 10px; }
  .history-day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .history-day-date { font-size: 14px; font-weight: 700; }
  .history-day-profile { font-size: 11px; color: var(--text-dim); background: var(--surface); padding: 2px 10px; border-radius: 10px; }
  .history-day-macros { display: flex; gap: 12px; flex-wrap: wrap; font-size: 12px; color: var(--text-dim); margin-bottom: 8px; }
  .history-day-macros span b { color: var(--text); }
  .history-meal-list { font-size: 12px; color: var(--text-dim); border-top: 1px solid var(--border); padding-top: 8px; }
  .history-meal-item { display: flex; justify-content: space-between; padding: 3px 0; }
  .history-day-actions { display: flex; gap: 8px; margin-top: 10px; }
  .delete-day-btn { padding: 4px 12px; background: transparent; color: var(--accent2); border: 1px solid rgba(255,107,107,0.3); border-radius: 8px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 11px; transition: all 0.2s; }
  .delete-day-btn:hover { background: rgba(255,107,107,0.1); }

  /* Modal */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9000; display: none; align-items: center; justify-content: center; padding: 20px; }
  .modal-overlay.open { display: flex; }
  .modal-box { background: var(--surface); border-radius: 20px; border: 1px solid var(--border); width: 100%; max-width: 700px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
  .modal-header { padding: 18px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, rgba(167,139,250,0.1), rgba(0,212,170,0.1)); }
  .modal-header h3 { font-size: 18px; }
  .modal-close { background: transparent; border: none; color: var(--text-dim); font-size: 20px; cursor: pointer; padding: 4px 8px; border-radius: 6px; }
  .modal-close:hover { color: var(--accent2); }
  .modal-profile-tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); }
  .modal-tab { flex: 1; padding: 10px; background: transparent; border: none; color: var(--text-dim); cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 14px; border-bottom: 2px solid transparent; transition: all 0.2s; }
  .modal-tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 700; }
  .modal-body { flex: 1; overflow-y: auto; padding: 20px; }
  .modal-footer { padding: 14px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }
  .print-btn { padding: 8px 18px; background: var(--accent); color: #000; border: none; border-radius: 10px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 14px; font-weight: 700; }
  .copy-btn { padding: 8px 18px; background: transparent; border: 1px solid var(--border); color: var(--text-dim); border-radius: 10px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 14px; }
  .copy-btn:hover { border-color: var(--accent); color: var(--accent); }
  .modal-close-btn { padding: 8px 18px; background: transparent; border: 1px solid var(--border); color: var(--text-dim); border-radius: 10px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 14px; }

  /* Report content */
  .report-profile-title { font-size: 22px; font-weight: 900; color: var(--accent); margin-bottom: 4px; }
  .report-period { font-size: 13px; color: var(--text-dim); margin-bottom: 20px; }
  .report-avg-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 24px; }
  .report-avg-card { background: var(--surface2); border-radius: 12px; padding: 12px; text-align: center; }
  .report-avg-val { font-size: 22px; font-weight: 900; display: block; }
  .report-avg-lbl { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
  .report-avg-card.cal .report-avg-val { color: var(--cal-color); }
  .report-avg-card.prot .report-avg-val { color: var(--protein-color); }
  .report-avg-card.carb .report-avg-val { color: var(--carb-color); }
  .report-avg-card.fat .report-avg-val { color: var(--fat-color); }
  .report-avg-card.sug .report-avg-val { color: var(--sugar-color); }
  .report-day-block { background: var(--surface2); border-radius: 12px; padding: 14px; margin-bottom: 12px; }
  .report-day-title { font-size: 13px; font-weight: 700; margin-bottom: 8px; color: var(--text); }
  .report-day-totals { font-size: 12px; color: var(--text-dim); margin-bottom: 8px; }
  .report-meal-row { font-size: 12px; color: var(--text-dim); padding: 3px 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
  .report-meal-row:last-child { border-bottom: none; }
  .report-empty { text-align: center; padding: 40px; color: var(--text-dim); }

  @media print {
    .header, .main > *:not(.history-section) { display: none !important; }
    .modal-overlay { position: static; background: white; display: block !important; }
    .modal-box { max-height: none; color: #000; background: white; }
    .modal-footer, .modal-close, .modal-profile-tabs { display: none !important; }
    .modal-body { color: #000; }
    * { color: #000 !important; background: white !important; }
  }

  @media (max-width: 600px) {
    .macros-grid { grid-template-columns: repeat(2, 1fr); }
    .result-macros { grid-template-columns: repeat(3, 1fr); }
    .settings-grid { grid-template-columns: 1fr; }
    .main { padding: 12px; }
    .msg-bubble { max-width: 90%; }
    .report-avg-grid { grid-template-columns: repeat(3, 1fr); }
  }
</style>
</head>
<body>

<header class="header">
  <div class="header-inner">
    <div class="logo">ğŸ¥— ××–×•×Ÿ ×—×›×</div>
    <div style="display:flex;gap:10px;align-items:center">
      <button class="settings-toggle-btn" onclick="toggleSettings()">âš™ï¸ ×”×’×“×¨×•×ª</button>
      <div class="profile-toggle">
        <button class="profile-btn active" onclick="switchProfile('me')">×‘×•×¢×–</button>
        <button class="profile-btn" onclick="switchProfile('wife')">×•×™×•×™××Ÿ</button>
      </div>
    </div>
  </div>
</header>

<div class="main">

  <!-- Settings Panel -->
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-grid">
      <div class="settings-section">
        <h3>ğŸ‘¤ ×‘×•×¢×– (×¡×›×¨×ª)</h3>
        <div class="setting-row"><span class="setting-label">×§×œ×•×¨×™×•×ª ××§×¡. ×œ×™×•×</span><input type="number" class="setting-input" id="me-cal" value="2000"></div>
        <div class="setting-row"><span class="setting-label">×—×œ×‘×•×Ÿ ××™× . ×œ×™×•× (×’×¨×)</span><input type="number" class="setting-input" id="me-protein" value="100"></div>
        <div class="setting-row"><span class="setting-label">×¤×—××™××•×ª ××§×¡. (×’×¨×)</span><input type="number" class="setting-input" id="me-carbs" value="160"></div>
        <div class="setting-row"><span class="setting-label">×¡×•×›×¨ ××•×¡×£ ××§×¡. (×’×¨×)</span><input type="number" class="setting-input" id="me-sugar" value="25"></div>
      </div>
      <div class="settings-section">
        <h3>ğŸ‘© ×•×™×•×™××Ÿ (×“×™××˜×”)</h3>
        <div class="setting-row"><span class="setting-label">×§×œ×•×¨×™×•×ª ××§×¡. ×œ×™×•×</span><input type="number" class="setting-input" id="wife-cal" value="1400"></div>
        <div class="setting-row"><span class="setting-label">×—×œ×‘×•×Ÿ ××™× . ×œ×™×•× (×’×¨×)</span><input type="number" class="setting-input" id="wife-protein" value="90"></div>
        <div class="setting-row"><span class="setting-label">×¤×—××™××•×ª ××§×¡. (×’×¨×)</span><input type="number" class="setting-input" id="wife-carbs" value="120"></div>
        <div class="setting-row"><span class="setting-label">×¡×•×›×¨ ××•×¡×£ ××§×¡. (×’×¨×)</span><input type="number" class="setting-input" id="wife-sugar" value="40"></div>
      </div>
    </div>
    <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;">
      <div>
        <div style="font-size:14px;font-weight:700;">×”×¦×’ ×¤×¨×•×¤×™×œ ×•×™×•×™××Ÿ</div>
        <div style="font-size:12px;color:var(--text-dim);margin-top:2px;">×›××©×¨ ×›×‘×•×™ â€” ×•×™×•×™××Ÿ ××•×¡×ª×¨×ª ×œ×—×œ×•×˜×™×Ÿ</div>
      </div>
      <label class="toggle-switch">
        <input type="checkbox" id="showWifeToggle" onchange="toggleWifeProfile(this.checked)">
        <span class="toggle-slider"></span>
      </label>
    </div>
    <button class="save-settings-btn" onclick="saveSettings()">ğŸ’¾ ×©××•×¨ ×”×’×“×¨×•×ª</button>
  </div>

  <!-- Daily Summary -->
  <div class="daily-summary">
    <div class="summary-title">ğŸ“Š ×¡×™×›×•× ×™×•××™ â€” <span id="profileName">×‘×•×¢×–</span></div>
    <div class="macros-grid">
      <div class="macro-card protein">
        <div class="macro-value" id="total-protein">0</div>
        <div class="macro-label">×—×œ×‘×•×Ÿ (×’×¨×)</div>
        <div class="macro-target">××™× . <span id="target-protein">97</span>×’×¨×</div>
      </div>
      <div class="macro-card carbs">
        <div class="macro-value" id="total-carbs">0</div>
        <div class="macro-label">×¤×—××™××•×ª (×’×¨×)</div>
        <div class="macro-target">××§×¡. <span id="target-carbs">150</span>×’×¨×</div>
      </div>
      <div class="macro-card fat">
        <div class="macro-value" id="total-fat">0</div>
        <div class="macro-label">×©×•××Ÿ (×’×¨×)</div>
        <div class="macro-target">×œ×œ× ××’×‘×œ×”</div>
      </div>
      <div class="macro-card sugar">
        <div class="macro-value" id="total-sugar">0</div>
        <div class="macro-label">×¡×•×›×¨ ××•×¡×£ (×’×¨×)</div>
        <div class="macro-target">××§×¡. <span id="target-sugar">30</span>×’×¨×</div>
      </div>
    </div>
    <div class="calorie-section">
      <div class="calorie-header">
        <span class="calorie-label">ğŸ”¥ ×§×œ×•×¨×™×•×ª ×”×™×•×</span>
        <span><span class="calorie-current" id="total-cal">0</span><span class="calorie-max"> / <span id="target-cal">2000</span> ×§×§"×œ</span></span>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="cal-progress" style="width:0%"></div></div>
    </div>
    <div class="protein-progress" style="margin-top:12px">
      <div class="protein-header">
        <span>ğŸ’ª ×—×œ×‘×•×Ÿ</span>
        <span style="color:var(--protein-color)"><span id="protein-pct">0</span>% ××”××˜×¨×”</span>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="protein-progress" style="width:0%;background:linear-gradient(90deg,var(--protein-color),#00ffcc)"></div></div>
    </div>
    <div class="alerts" id="alerts"></div>
  </div>

  <!-- Input Area -->
  <div class="input-area">
    <h2>â• ×”×•×¡×£ ××¨×•×—×”</h2>
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('text')">âœï¸ ×”×§×œ×“×”</button>
      <button class="tab-btn" onclick="switchTab('image')">ğŸ“¸ ×¦×™×œ×•× / ×ª××•× ×”</button>
    </div>
    <div class="tab-content active" id="tab-text">
      <textarea id="foodText" placeholder="×œ×“×•×’××”: 150 ×’×¨× ×—×–×” ×¢×•×£ ×¦×œ×•×™, 100 ×’×¨× ××•×¨×– ×œ×‘×Ÿ ××‘×•×©×œ, ×¡×œ×˜ ×™×¨×§×•×ª ×¢× ×›×¤×™×ª ×©××Ÿ ×–×™×ª..."></textarea>
    </div>
    <div class="tab-content" id="tab-image">
      <div class="image-drop" id="imageDrop">
        <input type="file" id="imageFile" accept="image/*" onchange="handleImageSelect(event)">
        <div class="drop-icon">ğŸ“·</div>
        <div class="drop-text"><strong>×’×¨×•×¨ ×ª××•× ×” ×œ×›××Ÿ</strong><br>××• ×œ×—×¥ ×œ×‘×—×™×¨×ª ×ª××•× ×” ××”×’×œ×¨×™×™×”<br><small style="color:var(--text-dim);margin-top:6px;display:block">JPEG, PNG, HEIC</small></div>
      </div>
      <div class="image-preview" id="imagePreview">
        <img id="previewImg" src="" alt="×ª×¦×•×’×” ××§×“×™××”">
        <button class="remove-image" onclick="removeImage()">âœ•</button>
      </div>
      <textarea id="imageNote" placeholder="(××•×¤×¦×™×•× ×œ×™) ×¤×¨×˜×™ ×›××•×™×•×ª × ×•×¡×¤×™×" style="margin-top:10px;height:60px"></textarea>
    </div>
    <button class="analyze-btn" onclick="analyzeFood()" id="analyzeBtn">
      <div class="spinner" id="spinner"></div>
      <span id="analyzeBtnText">ğŸ” × ×ª×— ×¢×¨×›×™× ×ª×–×•× ×ª×™×™×</span>
    </button>
    <div class="loading-message" id="loadingMsg">
      <div style="font-size:24px;margin-bottom:8px">ğŸ¤”</div>
      Claude ×× ×ª×— ××ª ×”×× ×” ×©×œ×š<span class="loading-dots"></span>
    </div>
  </div>

  <!-- Result Card -->
  <div class="result-card" id="resultCard">
    <div class="result-header">
      <div class="result-meal-name" id="resultMealName"></div>
      <div class="result-portions" id="resultPortions"></div>
    </div>
    <div class="result-macros">
      <div class="result-macro cal"><span class="result-macro-val" id="r-cal">-</span><span class="result-macro-lbl">×§×§"×œ</span></div>
      <div class="result-macro prot"><span class="result-macro-val" id="r-protein">-</span><span class="result-macro-lbl">×—×œ×‘×•×Ÿ (×’×¨×³)</span></div>
      <div class="result-macro carb"><span class="result-macro-val" id="r-carbs">-</span><span class="result-macro-lbl">×¤×—××™××•×ª (×’×¨×³)</span></div>
      <div class="result-macro fat"><span class="result-macro-val" id="r-fat">-</span><span class="result-macro-lbl">×©×•××Ÿ (×’×¨×³)</span></div>
      <div class="result-macro sug"><span class="result-macro-val" id="r-sugar">-</span><span class="result-macro-lbl">×¡×•×›×¨ ××•×¡×£ (×’×¨×³)</span></div>
    </div>
    <div class="result-notes" id="resultNotes"></div>
    <div class="result-actions">
      <button class="add-to-day-btn" onclick="addToDay()">âœ… ×”×•×¡×£ ×œ×™×•× ×©×œ×™</button>
      <button class="discard-btn" onclick="discardResult()">ğŸ—‘ï¸ ×‘×˜×œ</button>
    </div>
  </div>

  <!-- Chat Advisor -->
  <div class="chat-section">
    <div class="chat-header">
      <h2>ğŸ¤– ×™×•×¢×¥ ×ª×–×•× ×” <span class="chat-badge">AI</span></h2>
      <button class="chat-clear-btn" onclick="clearChat()">ğŸ—‘ï¸ × ×§×” ×©×™×—×”</button>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="chat-welcome" id="chatWelcome">
        <div class="welcome-icon">ğŸ¥‘</div>
        <h3>×©×œ×•×! ×× ×™ ×”×™×•×¢×¥ ×”×ª×–×•× ×ª×™ ×©×œ×š</h3>
        <p>×× ×™ ×™×•×“×¢ ××” ××›×œ×ª ×”×™×•× ×•××” ×”×™×¢×“×™× ×©×œ×š.<br>×©××œ ××•×ª×™ ×›×œ ×©××œ×” â€” ××” ×œ×‘×©×œ, ××” ×œ×”×•×¡×™×£, ××” ××ª××™× ×œ×¡×›×¨×ª ×•×¢×•×“.</p>
        <div class="chat-suggestions">
          <button class="suggestion-chip" onclick="sendSuggestion('××” ×›×“××™ ×œ×™ ×œ××›×•×œ ×œ××¨×•×—×ª ×¢×¨×‘ ×›×“×™ ×œ×”×’×™×¢ ×œ×™×¢×“ ×”×—×œ×‘×•×Ÿ?')">ğŸ’ª ××” ×œ××›×•×œ ×œ××¨×•×—×ª ×¢×¨×‘?</button>
          <button class="suggestion-chip" onclick="sendSuggestion('×›××” ×—×œ×‘×•×Ÿ × ×©××¨ ×œ×™ ×¢×“ ×”×™×¢×“ ×”×™×•××™?')">ğŸ“Š ×›××” ×—×œ×‘×•×Ÿ × ×©××¨ ×œ×™?</button>
          <button class="suggestion-chip" onclick="sendSuggestion('×”×¦×¢ ×œ×™ ××¨×•×—×ª ×‘×•×§×¨ ×¢×©×™×¨×” ×‘×—×œ×‘×•×Ÿ ×•×“×œ×ª ×¡×•×›×¨ ×œ×¡×›×¨×ª×™')">ğŸŒ… ××¨×•×—×ª ×‘×•×§×¨ ×œ×¡×›×¨×ª×™</button>
          <button class="suggestion-chip" onclick="sendSuggestion('×× ×™ ×¨×•×¦×” ×œ×”×›×™×Ÿ ×¢×•×£ ×¢× ×™×¨×§×•×ª, ××” ×”×›×™ ××•××œ×¥ ×œ×¡×›×¨×ª?')">ğŸ— ××ª×›×•×Ÿ ×œ×¢×•×£ ×¢× ×™×¨×§×•×ª</button>
          <button class="suggestion-chip" onclick="sendSuggestion('××” ×•×™×•×™××Ÿ ×™×›×•×œ×” ×œ××›×•×œ ×œ× ×©× ×•×© ×‘×œ×™ ×œ×—×¨×•×’ ××”×“×™××˜×”?')">ğŸ¥— × ×©× ×•×© ×œ×•×™×•×™××Ÿ</button>
          <button class="suggestion-chip" onclick="sendSuggestion('×ª×Ÿ ×œ×™ ×ª×¤×¨×™×˜ ×™×•××™ ×©×œ× ×¢× 97 ×’×¨× ×—×œ×‘×•×Ÿ ×œ×¡×›×¨×ª×™')">ğŸ“‹ ×ª×¤×¨×™×˜ ×™×•××™ ×©×œ×</button>
        </div>
      </div>
    </div>
    <div class="chat-input-row">
      <textarea class="chat-input" id="chatInput" placeholder="×©××œ ××•×ª×™ ×¢×œ ×ª×–×•× ×”, ××” ×œ×‘×©×œ, ××” ×œ×”×•×¡×™×£ ×œ×™×•×..." rows="1" onkeydown="handleChatKey(event)" oninput="autoResize(this)"></textarea>
      <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">â¤</button>
    </div>
  </div>

  <!-- Meal Log -->
  <div class="meal-log">
    <div class="meal-log-header">
      <h2>ğŸ“‹ ×™×•××Ÿ ××¨×•×—×•×ª</h2>
      <div style="display:flex;gap:8px;">
        <button class="save-day-btn" onclick="saveDay()">ğŸ’¾ ×©××•×¨ ×™×•×</button>
        <button class="transfer-btn" id="transferBtn" onclick="transferMeals()" title="×”×¢×‘×¨ ××¨×•×—×•×ª ×œ×¤×¨×•×¤×™×œ ×”×©× ×™">ğŸ”€ ×”×¢×‘×¨ ×œ×¤×¨×•×¤×™×œ ×”×©× ×™</button>
        <button class="reset-btn" onclick="resetDay()">ğŸ”„ ××¤×¡ ×™×•×</button>
      </div>
    </div>
    <div id="mealLog">
      <div class="empty-log">
        <div class="empty-icon">ğŸ½ï¸</div>
        <div>×¢×“×™×™×Ÿ ×œ× ×”×•×¡×¤×ª ××¨×•×—×•×ª ×”×™×•×</div>
        <div style="margin-top:4px;font-size:12px">× ×ª×— ×× ×” ×•×œ×—×¥ "×”×•×¡×£ ×œ×™×•× ×©×œ×™"</div>
      </div>
    </div>
  </div>

  <!-- History Section -->
  <div class="history-section" id="historySection">
    <div class="history-header">
      <h2>ğŸ“… ×”×™×¡×˜×•×¨×™×™×ª ×™××™×</h2>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="report-btn" onclick="openReport()">ğŸ“Š ×“×•×— ×œ×“×™××˜× ×™×ª</button>
      </div>
    </div>
    <div id="historyList">
      <div class="empty-log" style="padding:24px;">
        <div class="empty-icon">ğŸ“…</div>
        <div>×¢×“×™×™×Ÿ ×œ× ×©××¨×ª ×™××™×</div>
        <div style="margin-top:4px;font-size:12px">×œ×—×¥ "×©××•×¨ ×™×•×" ×‘×¡×•×£ ×”×™×•×</div>
      </div>
    </div>
  </div>

</div>

<!-- Report Modal -->
<div class="modal-overlay" id="reportModal" onclick="closeReportOnBg(event)">
  <div class="modal-box">
    <div class="modal-header">
      <h3>ğŸ“Š ×“×•×— ×ª×–×•× ×” ×œ×“×™××˜× ×™×ª</h3>
      <button class="modal-close" onclick="closeReport()">âœ•</button>
    </div>
    <div class="modal-profile-tabs">
      <button class="modal-tab active" onclick="switchReportProfile('me')">×‘×•×¢×–</button>
      <button class="modal-tab" onclick="switchReportProfile('wife')">×•×™×•×™××Ÿ</button>
    </div>
    <div class="modal-body" id="reportContent"></div>
    <div class="modal-footer">
      <button class="print-btn" onclick="printReport()">ğŸ–¨ï¸ ×”×“×¤×¡ / ×©××•×¨ PDF</button>
      <button class="copy-btn" onclick="copyReport()">ğŸ“‹ ×”×¢×ª×§ ×˜×§×¡×˜</button>
      <button class="modal-close-btn" onclick="closeReport()">×¡×’×•×¨</button>
    </div>
  </div>
</div>

<script>
// ===== STATE =====
const defaultSettings = {
  me: { name: '×‘×•×¢×–', cal: 2000, protein: 100, carbs: 160, sugar: 25 },
  wife: { name: '×•×™×•×™××Ÿ', cal: 1400, protein: 90, carbs: 120, sugar: 40 }
};

let settings = JSON.parse(localStorage.getItem('nutritionSettings')) || JSON.parse(JSON.stringify(defaultSettings));
// Force update Boaz's targets to the correct dietitian-approved values
if (!settings.me) settings.me = {};
settings.me.name = '×‘×•×¢×–';
settings.me.cal = 2000;
settings.me.protein = 100;
settings.me.carbs = 160;
settings.me.sugar = 25;
localStorage.setItem('nutritionSettings', JSON.stringify(settings));
let currentProfile = localStorage.getItem('currentProfile') || 'me';
let meals = JSON.parse(localStorage.getItem(`meals-${currentProfile}`)) || [];
let pendingResult = null;
let selectedImageBase64 = null;
let currentTab = 'text';
let chatHistory = [];

// ===== HISTORY =====
let dayHistory = JSON.parse(localStorage.getItem('dayHistory') || '[]');
let reportProfile = 'me';

function saveDay() {
  if (meals.length === 0) { showToast('âš ï¸ ××™×Ÿ ××¨×•×—×•×ª ×œ×©××™×¨×” ×”×™×•×'); return; }
  const s = settings[currentProfile] || defaultSettings[currentProfile];
  const totals = getTotals();
  const today = new Date();
  const dateStr = today.toLocaleDateString('he-IL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  const dateKey = today.toISOString().split('T')[0];

  const dayData = {
    id: Date.now(),
    date: dateStr,
    dateKey,
    profile: currentProfile,
    profileName: s.name,
    meals: JSON.parse(JSON.stringify(meals)),
    totals,
    targets: { cal: s.cal, protein: s.protein, carbs: s.carbs, sugar: s.sugar }
  };

  // Remove existing entry for same day+profile if exists
  dayHistory = dayHistory.filter(d => !(d.dateKey === dateKey && d.profile === currentProfile));
  dayHistory.unshift(dayData);
  localStorage.setItem('dayHistory', JSON.stringify(dayHistory));
  renderHistory();
  showToast('âœ… ×”×™×•× × ×©××¨ ×‘×”×™×¡×˜×•×¨×™×”!');
}

function renderHistory() {
  const list = document.getElementById('historyList');
  const filtered = dayHistory.filter(d => d.profile === currentProfile);
  if (filtered.length === 0) {
    list.innerHTML = '<div class="empty-log" style="padding:24px;"><div class="empty-icon">ğŸ“…</div><div>×¢×“×™×™×Ÿ ×œ× ×©××¨×ª ×™××™×</div><div style="margin-top:4px;font-size:12px">×œ×—×¥ "×©××•×¨ ×™×•×" ×‘×¡×•×£ ×”×™×•×</div></div>';
    return;
  }
  list.innerHTML = filtered.map((day, i) => {
    const hitProtein = day.totals.protein >= day.targets.protein;
    const overCal = day.totals.cal > day.targets.cal;
    return `<div class="history-day">
      <div class="history-day-header">
        <span class="history-day-date">${day.date}</span>
        <div style="display:flex;gap:6px;align-items:center;">
          ${hitProtein ? '<span style="font-size:11px;background:rgba(0,212,170,0.2);color:#00d4aa;padding:2px 8px;border-radius:10px;">âœ… ×—×œ×‘×•×Ÿ OK</span>' : '<span style="font-size:11px;background:rgba(255,107,107,0.15);color:#ff9999;padding:2px 8px;border-radius:10px;">âš ï¸ ×—×¡×¨ ×—×œ×‘×•×Ÿ</span>'}
          ${overCal ? '<span style="font-size:11px;background:rgba(255,107,107,0.15);color:#ff9999;padding:2px 8px;border-radius:10px;">âš ï¸ ×—×¨×™×’×” ×§×œ×•×¨×™×ª</span>' : ''}
        </div>
      </div>
      <div class="history-day-macros">
        <span>ğŸ”¥ <b>${day.totals.cal}</b> ×§×§"×œ</span>
        <span>ğŸ¥© ×—×œ×‘×•×Ÿ: <b>${day.totals.protein}×’×¨×</b></span>
        <span>ğŸŒ¾ ×¤×—××™××•×ª: <b>${day.totals.carbs}×’×¨×</b></span>
        <span>ğŸ¬ ×¡×•×›×¨: <b>${day.totals.sugar}×’×¨×</b></span>
        <span>ğŸ§ˆ ×©×•××Ÿ: <b>${day.totals.fat}×’×¨×</b></span>
      </div>
      <div class="history-meal-list">
        ${day.meals.map(m => `<div class="history-meal-item"><span>${m.name}</span><span>${m.calories} ×§×§"×œ Â· ${m.protein}×’×¨× ×—×œ×‘×•×Ÿ</span></div>`).join('')}
      </div>
      <div class="history-day-actions">
        <button class="delete-day-btn" onclick="deleteDay(${day.id})">ğŸ—‘ï¸ ××—×§ ×™×•×</button>
      </div>
    </div>`;
  }).join('');
}

function deleteDay(id) {
  showConfirm('×œ××—×•×§ ××ª ×”×™×•× ×”×–×” ××”×”×™×¡×˜×•×¨×™×”?', () => {
    dayHistory = dayHistory.filter(d => d.id !== id);
    localStorage.setItem('dayHistory', JSON.stringify(dayHistory));
    renderHistory();
    showToast('ğŸ—‘ï¸ ×”×™×•× × ××—×§');
  });
}

// ===== REPORT =====
function openReport() {
  document.getElementById('reportModal').classList.add('open');
  renderReport();
}

function closeReport() {
  document.getElementById('reportModal').classList.remove('open');
}

function closeReportOnBg(e) {
  if (e.target === document.getElementById('reportModal')) closeReport();
}

function switchReportProfile(profile) {
  reportProfile = profile;
  document.querySelectorAll('.modal-tab').forEach((t, i) => t.classList.toggle('active', (i === 0 && profile === 'me') || (i === 1 && profile === 'wife')));
  renderReport();
}

function renderReport() {
  const s = settings[reportProfile] || defaultSettings[reportProfile];
  const filtered = dayHistory.filter(d => d.profile === reportProfile);
  const content = document.getElementById('reportContent');

  if (filtered.length === 0) {
    content.innerHTML = `<div class="report-empty"><div style="font-size:40px;margin-bottom:12px;">ğŸ“…</div><div>××™×Ÿ × ×ª×•× ×™× ×œ${s.name} ×¢×“×™×™×Ÿ</div><div style="font-size:13px;margin-top:8px;color:var(--text-dim)">×©××•×¨ ×™××™× ×‘×××¦×¢×•×ª "×©××•×¨ ×™×•×" ×›×“×™ ×œ×¨××•×ª ×“×•×—</div></div>`;
    return;
  }

  // Averages
  const avg = filtered.reduce((acc, d) => ({
    cal: acc.cal + d.totals.cal,
    protein: acc.protein + d.totals.protein,
    carbs: acc.carbs + d.totals.carbs,
    fat: acc.fat + d.totals.fat,
    sugar: acc.sugar + d.totals.sugar,
  }), { cal: 0, protein: 0, carbs: 0, fat: 0, sugar: 0 });
  const n = filtered.length;
  const firstDate = filtered[filtered.length - 1].date;
  const lastDate = filtered[0].date;

  content.innerHTML = `
    <div class="report-profile-title">${s.name}</div>
    <div class="report-period">ğŸ“† ${firstDate} â€” ${lastDate} Â· ${n} ×™××™× ×©× ×©××¨×•</div>
    <div style="font-size:13px;font-weight:700;margin-bottom:10px;color:var(--text-dim);">×××•×¦×¢ ×™×•××™</div>
    <div class="report-avg-grid">
      <div class="report-avg-card cal"><span class="report-avg-val">${Math.round(avg.cal/n)}</span><span class="report-avg-lbl">×§×§"×œ</span></div>
      <div class="report-avg-card prot"><span class="report-avg-val">${Math.round(avg.protein/n)}</span><span class="report-avg-lbl">×—×œ×‘×•×Ÿ (×’×¨×)</span></div>
      <div class="report-avg-card carb"><span class="report-avg-val">${Math.round(avg.carbs/n)}</span><span class="report-avg-lbl">×¤×—××™××•×ª (×’×¨×)</span></div>
      <div class="report-avg-card fat"><span class="report-avg-val">${Math.round(avg.fat/n)}</span><span class="report-avg-lbl">×©×•××Ÿ (×’×¨×)</span></div>
      <div class="report-avg-card sug"><span class="report-avg-val">${Math.round(avg.sugar/n)}</span><span class="report-avg-lbl">×¡×•×›×¨ (×’×¨×)</span></div>
    </div>
    <div style="font-size:13px;font-weight:700;margin-bottom:10px;color:var(--text-dim);">×¤×™×¨×•×˜ ×œ×¤×™ ×™××™×</div>
    ${filtered.map(day => `
      <div class="report-day-block">
        <div class="report-day-title">${day.date}</div>
        <div class="report-day-totals">ğŸ”¥ ${day.totals.cal} ×§×§"×œ &nbsp;|&nbsp; ğŸ¥© ${day.totals.protein}×’×¨× ×—×œ×‘×•×Ÿ &nbsp;|&nbsp; ğŸŒ¾ ${day.totals.carbs}×’×¨× ×¤×—××™××•×ª &nbsp;|&nbsp; ğŸ¬ ${day.totals.sugar}×’×¨× ×¡×•×›×¨ &nbsp;|&nbsp; ğŸ§ˆ ${day.totals.fat}×’×¨× ×©×•××Ÿ</div>
        ${day.meals.map(m => `<div class="report-meal-row"><span>${m.name}</span><span>${m.calories} ×§×§"×œ Â· ×—×œ×‘×•×Ÿ ${m.protein}×’×¨× Â· ×¤×—×' ${m.carbs}×’×¨× Â· ×¡×•×›×¨ ${m.sugar}×’×¨×</span></div>`).join('')}
      </div>
    `).join('')}
  `;
}

function printReport() {
  window.print();
}

function copyReport() {
  const s = settings[reportProfile] || defaultSettings[reportProfile];
  const filtered = dayHistory.filter(d => d.profile === reportProfile);
  if (filtered.length === 0) { showToast('××™×Ÿ × ×ª×•× ×™× ×œ×”×¢×ª×§×”'); return; }

  const n = filtered.length;
  const avg = filtered.reduce((acc, d) => ({
    cal: acc.cal + d.totals.cal, protein: acc.protein + d.totals.protein,
    carbs: acc.carbs + d.totals.carbs, fat: acc.fat + d.totals.fat, sugar: acc.sugar + d.totals.sugar,
  }), { cal: 0, protein: 0, carbs: 0, fat: 0, sugar: 0 });

  let text = `×“×•×— ×ª×–×•× ×” â€” ${s.name}\n`;
  text += `×¡×”"×› ${n} ×™××™×\n\n`;
  text += `×××•×¦×¢ ×™×•××™:\n`;
  text += `×§×œ×•×¨×™×•×ª: ${Math.round(avg.cal/n)} ×§×§"×œ\n`;
  text += `×—×œ×‘×•×Ÿ: ${Math.round(avg.protein/n)} ×’×¨×\n`;
  text += `×¤×—××™××•×ª: ${Math.round(avg.carbs/n)} ×’×¨×\n`;
  text += `×¡×•×›×¨: ${Math.round(avg.sugar/n)} ×’×¨×\n`;
  text += `×©×•××Ÿ: ${Math.round(avg.fat/n)} ×’×¨×\n\n`;
  text += `×¤×™×¨×•×˜ ×™××™×:\n`;
  filtered.forEach(day => {
    text += `\n${day.date}\n`;
    text += `×¡×”"×›: ${day.totals.cal} ×§×§"×œ | ×—×œ×‘×•×Ÿ ${day.totals.protein}×’×¨× | ×¤×—××™××•×ª ${day.totals.carbs}×’×¨× | ×¡×•×›×¨ ${day.totals.sugar}×’×¨×\n`;
    day.meals.forEach(m => { text += `  â€¢ ${m.name}: ${m.calories} ×§×§"×œ, ${m.protein}×’×¨× ×—×œ×‘×•×Ÿ\n`; });
  });

  navigator.clipboard.writeText(text).then(() => showToast('ğŸ“‹ ×”×“×•×— ×”×•×¢×ª×§!')).catch(() => showToast('âŒ ×œ× ×”×¦×œ×—×ª×™ ×œ×”×¢×ª×™×§'));
}

// ===== INIT =====
function init() {
  updateProfileUI();
  renderMeals();
  updateDailySummary();
  loadSettingsInputs();
  renderHistory();
  initWifeVisibility();
}

// ===== SETTINGS =====
function toggleSettings() { document.getElementById('settingsPanel').classList.toggle('open'); }

function loadSettingsInputs() {
  ['me', 'wife'].forEach(p => {
    document.getElementById(`${p}-cal`).value = settings[p]?.cal ?? defaultSettings[p].cal;
    document.getElementById(`${p}-protein`).value = settings[p]?.protein ?? defaultSettings[p].protein;
    document.getElementById(`${p}-carbs`).value = settings[p]?.carbs ?? defaultSettings[p].carbs;
    document.getElementById(`${p}-sugar`).value = settings[p]?.sugar ?? defaultSettings[p].sugar;
  });
}

function saveSettings() {
  ['me', 'wife'].forEach(p => {
    settings[p] = { ...settings[p], cal: +document.getElementById(`${p}-cal`).value, protein: +document.getElementById(`${p}-protein`).value, carbs: +document.getElementById(`${p}-carbs`).value, sugar: +document.getElementById(`${p}-sugar`).value };
  });
  localStorage.setItem('nutritionSettings', JSON.stringify(settings));
  updateDailySummary();
  toggleSettings();
  showToast('âœ… ×”×’×“×¨×•×ª × ×©××¨×•!');
}

function toggleWifeProfile(show) {
  localStorage.setItem('showWife', show ? '1' : '0');
  applyWifeVisibility(show);
}

function applyWifeVisibility(show) {
  // Profile button
  const wifeBtns = document.querySelectorAll('.profile-btn');
  if (wifeBtns[1]) wifeBtns[1].style.display = show ? '' : 'none';
  // Wife settings section
  const wifeSections = document.querySelectorAll('.settings-section');
  if (wifeSections[1]) wifeSections[1].style.display = show ? '' : 'none';
  // If currently on wife profile and hiding, switch to me
  if (!show && currentProfile === 'wife') switchProfile('me');
  // Update toggle checkbox state
  const toggle = document.getElementById('showWifeToggle');
  if (toggle) toggle.checked = show;
}

function initWifeVisibility() {
  const show = localStorage.getItem('showWife') !== '0'; // default = show
  applyWifeVisibility(show);
}

// ===== PROFILE =====
function switchProfile(profile) {
  currentProfile = profile;
  localStorage.setItem('currentProfile', profile);
  meals = JSON.parse(localStorage.getItem(`meals-${profile}`)) || [];
  document.querySelectorAll('.profile-btn').forEach((btn, i) => {
    btn.classList.toggle('active', (i === 0 && profile === 'me') || (i === 1 && profile === 'wife'));
  });
  updateProfileUI();
  renderMeals();
  updateDailySummary();
}

function updateProfileUI() {
  const s = settings[currentProfile] || defaultSettings[currentProfile];
  document.getElementById('profileName').textContent = s.name || (currentProfile === 'me' ? '×‘×•×¢×–' : '×•×™×•×™××Ÿ');
  document.getElementById('target-cal').textContent = s.cal;
  document.getElementById('target-protein').textContent = s.protein;
  document.getElementById('target-carbs').textContent = s.carbs;
  document.getElementById('target-sugar').textContent = s.sugar;
}

// ===== TABS =====
function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab-btn').forEach((btn, i) => btn.classList.toggle('active', (i === 0 && tab === 'text') || (i === 1 && tab === 'image')));
  document.querySelectorAll('.tab-content').forEach((c, i) => c.classList.toggle('active', (i === 0 && tab === 'text') || (i === 1 && tab === 'image')));
}

// ===== IMAGE =====
function handleImageSelect(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    selectedImageBase64 = e.target.result.split(',')[1];
    document.getElementById('previewImg').src = e.target.result;
    document.getElementById('imagePreview').style.display = 'block';
    document.getElementById('imageDrop').style.display = 'none';
  };
  reader.readAsDataURL(file);
}

function removeImage() {
  selectedImageBase64 = null;
  document.getElementById('imageFile').value = '';
  document.getElementById('imagePreview').style.display = 'none';
  document.getElementById('imageDrop').style.display = 'block';
}

// ===== ANALYZE =====
async function analyzeFood() {
  const btn = document.getElementById('analyzeBtn');
  const spinner = document.getElementById('spinner');
  const btnText = document.getElementById('analyzeBtnText');
  const loadingMsg = document.getElementById('loadingMsg');
  let userDescription = '';
  let hasImage = false;

  if (currentTab === 'text') {
    userDescription = document.getElementById('foodText').value.trim();
    if (!userDescription) { showToast('âš ï¸ ×× × ×”×›× ×¡ ×ª×™××•×¨ ×©×œ ×”×× ×”'); return; }
  } else {
    if (!selectedImageBase64) { showToast('âš ï¸ ×× × ×‘×—×¨ ×ª××•× ×”'); return; }
    hasImage = true;
    userDescription = document.getElementById('imageNote').value.trim();
  }

  btn.disabled = true;
  spinner.style.display = 'block';
  btnText.textContent = '×× ×ª×—...';
  loadingMsg.classList.add('visible');
  document.getElementById('resultCard').classList.remove('visible');

  const systemPrompt = `××ª×” ××•××—×” ×ª×–×•× ×” ×™×©×¨××œ×™. ×¢× ×” ×‘×¤×•×¨××˜ JSON ×‘×œ×‘×“ (×œ×œ× markdown):
{"name":"×©× ×”×× ×”","portions":"×ª×™××•×¨ ×›××•×™×•×ª","calories":××¡×¤×¨,"protein":××¡×¤×¨,"carbs":××¡×¤×¨,"fat":××¡×¤×¨,"sugar":××¡×¤×¨,"notes":"×”×¢×¨×•×ª ×§×¦×¨×•×ª ×‘×¢×‘×¨×™×ª"}
×›×œ ×¢×¨×›×™× ×‘×’×¨××™×. ×§×œ×•×¨×™×•×ª ×‘×§×§"×œ.
×—×©×•×‘ ×××•×“: ×©×“×” "sugar" ××™×™×¦×’ ×¡×•×›×¨ ××•×¡×£ ×‘×œ×‘×“ (added sugar) â€” ×œ× ×¡×•×›×¨ ×˜×‘×¢×™ ××¤×™×¨×•×ª, ×™×¨×§×•×ª, ××• ×—×œ×‘. ×œ×“×•×’××”: ×ª×¤×•×–, ×ª×¤×•×—, ×‘× × ×”, ×¢× ×‘×™×, ×—×œ×‘ â€” sugar=0. ×“×‘×©, ×¡×•×›×¨ ×œ×‘×Ÿ, ×¨×™×‘×”, ×©×•×§×•×œ×“, ××™×¦×™× ××ª×•×§×™× â€” sugar ×œ×¤×™ ×”×›××•×ª ×”×××™×ª×™×ª.`;

  try {
    const messages = [];
    if (hasImage) {
      messages.push({ role: 'user', content: [{ type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: selectedImageBase64 } }, { type: 'text', text: `× ×ª×— ×¢×¨×›×™× ×ª×–×•× ×ª×™×™× ×©×œ ×”××•×›×œ ×‘×ª××•× ×”.${userDescription ? ' ×”×¢×¨×•×ª: ' + userDescription : ''}` }] });
    } else {
      messages.push({ role: 'user', content: `× ×ª×— ×¢×¨×›×™× ×ª×–×•× ×ª×™×™×: ${userDescription}` });
    }

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 1000, system: systemPrompt, messages })
    });

    const data = await response.json();
    const text = data.content?.[0]?.text || '';
    const jsonMatch = text.match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error('×œ× ×”×¦×œ×—×ª×™ ×œ× ×ª×— ××ª ×”×ª×©×•×‘×”');
    pendingResult = JSON.parse(jsonMatch[0]);
    showResult(pendingResult);
  } catch (err) {
    showToast('âŒ ×©×’×™××”: ' + err.message);
  } finally {
    btn.disabled = false;
    spinner.style.display = 'none';
    btnText.textContent = 'ğŸ” × ×ª×— ×¢×¨×›×™× ×ª×–×•× ×ª×™×™×';
    loadingMsg.classList.remove('visible');
  }
}

function showResult(result) {
  document.getElementById('resultMealName').textContent = result.name || '××¨×•×—×”';
  document.getElementById('resultPortions').textContent = result.portions || '';
  document.getElementById('r-cal').textContent = result.calories || 0;
  document.getElementById('r-protein').textContent = result.protein || 0;
  document.getElementById('r-carbs').textContent = result.carbs || 0;
  document.getElementById('r-fat').textContent = result.fat || 0;
  document.getElementById('r-sugar').textContent = result.sugar || 0;
  document.getElementById('resultNotes').textContent = result.notes || '';
  document.getElementById('resultCard').classList.add('visible');
  document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function addToDay() {
  if (!pendingResult) return;
  meals.push({ ...pendingResult, id: Date.now(), time: new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }) });
  localStorage.setItem(`meals-${currentProfile}`, JSON.stringify(meals));
  renderMeals();
  updateDailySummary();
  discardResult();
  document.getElementById('foodText').value = '';
  removeImage();
  document.getElementById('imageNote').value = '';
  showToast('âœ… ×”××¨×•×—×” × ×•×¡×¤×” ×œ×™×•××Ÿ!');
}

function discardResult() {
  pendingResult = null;
  document.getElementById('resultCard').classList.remove('visible');
}

// ===== MEALS LOG =====
function renderMeals() {
  const log = document.getElementById('mealLog');
  if (meals.length === 0) {
    log.innerHTML = `<div class="empty-log"><div class="empty-icon">ğŸ½ï¸</div><div>×¢×“×™×™×Ÿ ×œ× ×”×•×¡×¤×ª ××¨×•×—×•×ª ×”×™×•×</div><div style="margin-top:4px;font-size:12px">× ×ª×— ×× ×” ×•×œ×—×¥ "×”×•×¡×£ ×œ×™×•× ×©×œ×™"</div></div>`;
    return;
  }
  log.innerHTML = meals.map((meal, i) => `
    <div class="meal-item">
      <div class="meal-info">
        <div class="meal-name">${meal.name} <span style="color:var(--text-dim);font-size:11px;font-weight:400">${meal.time}</span></div>
        <div class="meal-macros-mini">
          <span>ğŸ¥© ${meal.protein}×’×¨× ×—×œ×‘×•×Ÿ</span>
          <span>ğŸŒ¾ ${meal.carbs}×’×¨× ×¤×—×'</span>
          <span>ğŸ¬ ${meal.sugar}×’×¨× ×¡×•×›×¨</span>
          <span>ğŸ§ˆ ${meal.fat}×’×¨× ×©×•××Ÿ</span>
        </div>
      </div>
      <div class="meal-cal">${meal.calories} ×§×§"×œ</div>
      <button class="delete-meal" onclick="deleteMeal(${i})">ğŸ—‘ï¸</button>
    </div>
  `).join('');
}

function deleteMeal(index) {
  meals.splice(index, 1);
  localStorage.setItem(`meals-${currentProfile}`, JSON.stringify(meals));
  renderMeals();
  updateDailySummary();
}

function transferMeals() {
  if (meals.length === 0) { showToast('âš ï¸ ××™×Ÿ ××¨×•×—×•×ª ×œ×”×¢×‘×¨×”'); return; }
  const targetProfile = currentProfile === 'me' ? 'wife' : 'me';
  const targetName = (settings[targetProfile] || defaultSettings[targetProfile]).name;
  const sourceName = (settings[currentProfile] || defaultSettings[currentProfile]).name;

  showConfirm(`×œ×”×¢×‘×™×¨ ××ª ×›×œ ×”××¨×•×—×•×ª ×${sourceName} ××œ ${targetName}?`, () => {
    // Load target meals
    const targetMeals = JSON.parse(localStorage.getItem(`meals-${targetProfile}`) || '[]');
    // Add current meals to target (merge)
    const merged = [...targetMeals, ...meals];
    localStorage.setItem(`meals-${targetProfile}`, JSON.stringify(merged));
    // Clear current profile
    meals = [];
    localStorage.setItem(`meals-${currentProfile}`, JSON.stringify(meals));
    renderMeals();
    updateDailySummary();
    showToast(`âœ… ×”××¨×•×—×•×ª ×”×•×¢×‘×¨×• ×œ${targetName}!`);
  });
}

function resetDay() {
  showConfirm("×”×× ×œ××¤×¡ ××ª ×›×œ ×”××¨×•×—×•×ª ×©×œ ×”×™×•×?", () => {
    meals = [];
    localStorage.setItem(`meals-${currentProfile}`, JSON.stringify(meals));
    renderMeals();
    updateDailySummary();
    showToast("ğŸ”„ ×”××¨×•×—×•×ª ××•×¤×¡×•!");
  });
}


// ===== DAILY SUMMARY =====
function getTotals() {
  return meals.reduce((acc, meal) => ({
    cal: acc.cal + (meal.calories || 0),
    protein: acc.protein + (meal.protein || 0),
    carbs: acc.carbs + (meal.carbs || 0),
    fat: acc.fat + (meal.fat || 0),
    sugar: acc.sugar + (meal.sugar || 0),
  }), { cal: 0, protein: 0, carbs: 0, fat: 0, sugar: 0 });
}

function updateDailySummary() {
  const s = settings[currentProfile] || defaultSettings[currentProfile];
  const totals = getTotals();

  document.getElementById('total-cal').textContent = totals.cal;
  document.getElementById('total-protein').textContent = totals.protein;
  document.getElementById('total-carbs').textContent = totals.carbs;
  document.getElementById('total-fat').textContent = totals.fat;
  document.getElementById('total-sugar').textContent = totals.sugar;

  const calPct = Math.min((totals.cal / s.cal) * 100, 100);
  const calProgress = document.getElementById('cal-progress');
  calProgress.style.width = calPct + '%';
  calProgress.classList.toggle('over', totals.cal > s.cal);

  const proteinPct = Math.min((totals.protein / s.protein) * 100, 100);
  document.getElementById('protein-progress').style.width = proteinPct + '%';
  document.getElementById('protein-pct').textContent = Math.round(proteinPct);

  document.getElementById('target-cal').textContent = s.cal;
  document.getElementById('target-protein').textContent = s.protein;
  document.getElementById('target-carbs').textContent = s.carbs;
  document.getElementById('target-sugar').textContent = s.sugar;

  const alertsList = [];
  if (totals.cal > s.cal) alertsList.push(`<div class="alert warning">âš ï¸ ×—×¨×’×ª ××”××›×¡×” ×”×§×œ×•×¨×™×ª! (${totals.cal - s.cal} ×§×§"×œ ××¢×œ)</div>`);
  else if (totals.cal >= s.cal * 0.9) alertsList.push(`<div class="alert info">âš¡ ×§×¨×•×‘ ×œ××›×¡×” â€” × ×©××¨×• ${s.cal - totals.cal} ×§×§"×œ</div>`);
  if (totals.protein >= s.protein) alertsList.push(`<div class="alert success">âœ… ×”×’×¢×ª ×œ×™×¢×“ ×”×—×œ×‘×•×Ÿ! (${totals.protein}/${s.protein}×’×¨×)</div>`);
  else if (meals.length > 0) alertsList.push(`<div class="alert info">ğŸ’ª ×¢×•×“ ${s.protein - totals.protein}×’×¨× ×—×œ×‘×•×Ÿ ×œ×™×¢×“</div>`);
  if (totals.sugar > s.sugar) alertsList.push(`<div class="alert warning">ğŸ¬ ×—×¨×’×ª ××¡×•×›×¨ ×™×•××™! (${totals.sugar}/${s.sugar}×’×¨×)</div>`);
  if (totals.carbs > s.carbs) alertsList.push(`<div class="alert warning">ğŸŒ¾ ×—×¨×’×ª ××¤×—××™××•×ª ×™×•××™×•×ª! (${totals.carbs}/${s.carbs}×’×¨×)</div>`);
  document.getElementById('alerts').innerHTML = alertsList.join('');
}

// ===== CHAT =====
function buildContextForChat() {
  const s = settings[currentProfile] || defaultSettings[currentProfile];
  const totals = getTotals();
  const profileName = s.name;
  const isMe = currentProfile === 'me';

  let context = `××ª×” ×™×•×¢×¥ ×ª×–×•× ×” ×—×›× ×•××™×©×™. ×”××©×ª××© ×”×¤×¢×™×œ ×”×•× ${profileName}.`;
  if (isMe) context += ` ${profileName} ×—×•×œ×” ×‘×¡×›×¨×ª ×¡×•×’ 2, ×—×©×•×‘ ×××•×“ ×œ×”×ª×™×™×—×¡ ×œ×¨××•×ª ×¡×•×›×¨ × ××•×›×•×ª ×‘×“×.`;
  else context += ` ${profileName} ×¢×•×©×” ×“×™××˜×” ×œ×™×¨×™×“×” ×‘××©×§×œ.`;

  context += `\n\n×™×¢×“×™× ×™×•××™×™× ×©×œ ${profileName}:
- ×§×œ×•×¨×™×•×ª ××§×¡×™××•×: ${s.cal} ×§×§"×œ
- ×—×œ×‘×•×Ÿ ××™× ×™××•×: ${s.protein} ×’×¨×
- ×¤×—××™××•×ª ××§×¡×™××•×: ${s.carbs} ×’×¨×
- ×¡×•×›×¨ ××§×¡×™××•×: ${s.sugar} ×’×¨×`;

  context += `\n\n××” ${profileName} ×›×‘×¨ ××›×œ/×” ×”×™×•×:`;
  if (meals.length === 0) {
    context += '\n×¢×“×™×™×Ÿ ×œ× ××›×œ/×” ×›×œ×•× ×”×™×•×.';
  } else {
    meals.forEach(m => { context += `\n- ${m.name}: ${m.calories} ×§×§"×œ, ${m.protein}×’×¨× ×—×œ×‘×•×Ÿ, ${m.carbs}×’×¨× ×¤×—××™××•×ª, ${m.sugar}×’×¨× ×¡×•×›×¨`; });
    context += `\n\n×¡×”"×› ×¢×“ ×¢×›×©×™×•: ${totals.cal} ×§×§"×œ, ${totals.protein}×’×¨× ×—×œ×‘×•×Ÿ, ${totals.carbs}×’×¨× ×¤×—××™××•×ª, ${totals.sugar}×’×¨× ×¡×•×›×¨`;
    context += `\n× ×©××¨ ×¢×“ ×™×¢×“ ×—×œ×‘×•×Ÿ: ${Math.max(0, s.protein - totals.protein)} ×’×¨×`;
    context += `\n× ×©××¨ ×¢×“ ××›×¡×ª ×§×œ×•×¨×™×•×ª: ${Math.max(0, s.cal - totals.cal)} ×§×§"×œ`;
  }

  context += '\n\n×¢× ×” ×ª××™×“ ×‘×¢×‘×¨×™×ª, ×‘×¦×•×¨×” ×™×“×™×“×•×ª×™×ª ×•××¢×©×™×ª. ×ª×Ÿ ×”××œ×¦×•×ª ×¡×¤×¦×™×¤×™×•×ª ×¢× ×›××•×™×•×ª ×•××¨×›×™×‘×™×.';
  return context;
}

async function sendChatMessage() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  input.style.height = '42px';
  await processChat(msg);
}

async function sendSuggestion(text) {
  await processChat(text);
}

async function processChat(userMsg) {
  const sendBtn = document.getElementById('chatSendBtn');
  sendBtn.disabled = true;

  // Hide welcome
  const welcome = document.getElementById('chatWelcome');
  if (welcome) welcome.style.display = 'none';

  // Add user message
  appendMessage('user', userMsg);
  chatHistory.push({ role: 'user', content: userMsg });

  // Show typing
  const typingEl = appendTyping();

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        system: buildContextForChat(),
        messages: chatHistory
      })
    });

    const data = await response.json();
    const reply = data.content?.[0]?.text || '××¦×˜×¢×¨, ×œ× ×”×¦×œ×—×ª×™ ×œ×¢× ×•×ª.';

    typingEl.remove();
    appendMessage('ai', reply);
    chatHistory.push({ role: 'assistant', content: reply });

    // Keep history manageable
    if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);

  } catch (err) {
    typingEl.remove();
    appendMessage('ai', 'âŒ ×©×’×™××” ×‘×—×™×‘×•×¨. ×× × × ×¡×” ×©×•×‘.');
  } finally {
    sendBtn.disabled = false;
  }
}

function appendMessage(role, text) {
  const chatMessages = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  div.innerHTML = `
    <div class="msg-avatar">${role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'}</div>
    <div class="msg-bubble">${escapeHtml(text)}</div>
  `;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return div;
}

function appendTyping() {
  const chatMessages = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'msg ai msg-typing';
  div.innerHTML = `<div class="msg-avatar">ğŸ¤–</div><div class="msg-bubble"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return div;
}

function escapeHtml(text) {
  return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}

function clearChat() {
  chatHistory = [];
  const chatMessages = document.getElementById('chatMessages');
  chatMessages.innerHTML = `<div class="chat-welcome" id="chatWelcome">
    <div class="welcome-icon">ğŸ¥‘</div>
    <h3>×©×œ×•×! ×× ×™ ×”×™×•×¢×¥ ×”×ª×–×•× ×ª×™ ×©×œ×š</h3>
    <p>×× ×™ ×™×•×“×¢ ××” ××›×œ×ª ×”×™×•× ×•××” ×”×™×¢×“×™× ×©×œ×š.<br>×©××œ ××•×ª×™ ×›×œ ×©××œ×” â€” ××” ×œ×‘×©×œ, ××” ×œ×”×•×¡×™×£, ××” ××ª××™× ×œ×¡×›×¨×ª ×•×¢×•×“.</p>
    <div class="chat-suggestions">
      <button class="suggestion-chip" onclick="sendSuggestion('××” ×›×“××™ ×œ×™ ×œ××›×•×œ ×œ××¨×•×—×ª ×¢×¨×‘ ×›×“×™ ×œ×”×’×™×¢ ×œ×™×¢×“ ×”×—×œ×‘×•×Ÿ?')">ğŸ’ª ××” ×œ××›×•×œ ×œ××¨×•×—×ª ×¢×¨×‘?</button>
      <button class="suggestion-chip" onclick="sendSuggestion('×›××” ×—×œ×‘×•×Ÿ × ×©××¨ ×œ×™ ×¢×“ ×”×™×¢×“ ×”×™×•××™?')">ğŸ“Š ×›××” ×—×œ×‘×•×Ÿ × ×©××¨ ×œ×™?</button>
      <button class="suggestion-chip" onclick="sendSuggestion('×”×¦×¢ ×œ×™ ××¨×•×—×ª ×‘×•×§×¨ ×¢×©×™×¨×” ×‘×—×œ×‘×•×Ÿ ×•×“×œ×ª ×¡×•×›×¨ ×œ×¡×›×¨×ª×™')">ğŸŒ… ××¨×•×—×ª ×‘×•×§×¨ ×œ×¡×›×¨×ª×™</button>
      <button class="suggestion-chip" onclick="sendSuggestion('×× ×™ ×¨×•×¦×” ×œ×”×›×™×Ÿ ×¢×•×£ ×¢× ×™×¨×§×•×ª, ××” ×”×›×™ ××•××œ×¥ ×œ×¡×›×¨×ª?')">ğŸ— ××ª×›×•×Ÿ ×œ×¢×•×£ ×¢× ×™×¨×§×•×ª</button>
      <button class="suggestion-chip" onclick="sendSuggestion('××” ×•×™×•×™××Ÿ ×™×›×•×œ×” ×œ××›×•×œ ×œ× ×©× ×•×© ×‘×œ×™ ×œ×—×¨×•×’ ××”×“×™××˜×”?')">ğŸ¥— × ×©× ×•×© ×œ×•×™×•×™××Ÿ</button>
      <button class="suggestion-chip" onclick="sendSuggestion('×ª×Ÿ ×œ×™ ×ª×¤×¨×™×˜ ×™×•××™ ×©×œ× ×¢× 97 ×’×¨× ×—×œ×‘×•×Ÿ ×œ×¡×›×¨×ª×™')">ğŸ“‹ ×ª×¤×¨×™×˜ ×™×•××™ ×©×œ×</button>
    </div>
  </div>`;
}

function handleChatKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChatMessage(); }
}

function autoResize(el) {
  el.style.height = '42px';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}


// ===== CONFIRM DIALOG =====
function showConfirm(message, onConfirm) {
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9998;display:flex;align-items:center;justify-content:center;';
  overlay.innerHTML = `
    <div style="background:#1a1d27;border:1px solid rgba(255,255,255,0.1);border-radius:20px;padding:28px;max-width:320px;width:90%;text-align:center;font-family:Heebo,sans-serif;">
      <div style="font-size:32px;margin-bottom:12px;">ğŸ—‘ï¸</div>
      <div style="font-size:16px;color:#e8eaf0;margin-bottom:8px;font-weight:700;">××™×©×•×¨</div>
      <div style="font-size:14px;color:#8892a4;margin-bottom:24px;">${message}</div>
      <div style="display:flex;gap:10px;">
        <button onclick="this.closest('[style]').remove()" style="flex:1;padding:10px;background:transparent;border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#8892a4;cursor:pointer;font-family:Heebo,sans-serif;font-size:14px;">×‘×™×˜×•×œ</button>
        <button id="confirmOkBtn" style="flex:1;padding:10px;background:#ff6b6b;border:none;border-radius:10px;color:#000;font-weight:700;cursor:pointer;font-family:Heebo,sans-serif;font-size:14px;">××¤×¡</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  overlay.querySelector('#confirmOkBtn').onclick = () => { overlay.remove(); onConfirm(); };
  overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
}

// ===== TOAST =====
function showToast(msg) {
  const toast = document.createElement('div');
  toast.style.cssText = `position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--accent);color:var(--text);padding:12px 24px;border-radius:12px;font-size:14px;z-index:9999;box-shadow:0 8px 30px rgba(0,0,0,0.4);font-family:'Heebo',sans-serif;`;
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

init();
</script>
</body>
</html>
