<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content=" ">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0f1117">
<meta name="description" content="注拽 转  注 AI - 注 ">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>  - 注拽 转</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #22263a;
    --accent: #00d4aa;
    --accent2: #ff6b6b;
    --accent3: #ffd93d;
    --text: #e8eaf0;
    --text-dim: #8892a4;
    --border: rgba(255,255,255,0.08);
    --protein-color: #00d4aa;
    --carb-color: #ffd93d;
    --fat-color: #ff8c42;
    --sugar-color: #ff6b6b;
    --cal-color: #a78bfa;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Heebo', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; direction: rtl; }

  .header { background: linear-gradient(135deg, #0f1117 0%, #1a1d27 100%); border-bottom: 1px solid var(--border); padding: 16px 20px; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(20px); }
  .header-inner { max-width: 900px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
  .logo { font-size: 22px; font-weight: 900; background: linear-gradient(135deg, var(--accent), #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
  .profile-toggle { display: flex; gap: 8px; }
  .profile-btn { padding: 6px 16px; border-radius: 20px; border: 1px solid var(--border); background: transparent; color: var(--text-dim); cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 14px; transition: all 0.2s; }
  .profile-btn.active { background: var(--accent); color: #000; border-color: var(--accent); font-weight: 700; }

  .main { max-width: 900px; margin: 0 auto; padding: 20px; display: grid; gap: 20px; }

  .daily-summary { background: var(--surface); border-radius: 20px; padding: 20px; border: 1px solid var(--border); }
  .summary-title { font-size: 13px; color: var(--text-dim); margin-bottom: 16px; font-weight: 500; text-transform: uppercase; letter-spacing: 1px; }
  .macros-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px; }
  .macro-card { background: var(--surface2); border-radius: 14px; padding: 14px; text-align: center; position: relative; overflow: hidden; }
  .macro-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
  .macro-card.protein::before { background: var(--protein-color); }
  .macro-card.carbs::before { background: var(--carb-color); }
  .macro-card.fat::before { background: var(--fat-color); }
  .macro-card.sugar::before { background: var(--sugar-color); }
  .macro-value { font-size: 28px; font-weight: 900; line-height: 1; margin-bottom: 2px; }
  .macro-card.protein .macro-value { color: var(--protein-color); }
  .macro-card.carbs .macro-value { color: var(--carb-color); }
  .macro-card.fat .macro-value { color: var(--fat-color); }
  .macro-card.sugar .macro-value { color: var(--sugar-color); }
  .macro-label { font-size: 12px; color: var(--text-dim); margin-bottom: 6px; }
  .macro-target { font-size: 11px; color: var(--text-dim); }

  .calorie-section { background: var(--surface2); border-radius: 14px; padding: 14px; }
  .calorie-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .calorie-label { font-size: 14px; color: var(--text-dim); }
  .calorie-current { color: var(--cal-color); font-weight: 700; font-size: 20px; }
  .calorie-max { color: var(--text-dim); }
  .progress-bar { height: 10px; background: rgba(255,255,255,0.08); border-radius: 10px; overflow: hidden; }
  .progress-fill { height: 100%; border-radius: 10px; transition: width 0.5s ease; background: linear-gradient(90deg, var(--cal-color), #ec4899); }
  .progress-fill.over { background: linear-gradient(90deg, #ff6b6b, #ef4444); }

  .alerts { margin-top: 12px; display: flex; flex-direction: column; gap: 6px; }
  .alert { padding: 8px 12px; border-radius: 10px; font-size: 13px; display: flex; align-items: center; gap: 8px; }
  .alert.warning { background: rgba(255,107,107,0.15); border: 1px solid rgba(255,107,107,0.3); color: #ff9999; }
  .alert.success { background: rgba(0,212,170,0.15); border: 1px solid rgba(0,212,170,0.3); color: var(--accent); }
  .alert.info { background: rgba(255,217,61,0.15); border: 1px solid rgba(255,217,61,0.3); color: var(--accent3); }

  .protein-progress { margin-top: 12px; background: var(--surface2); border-radius: 14px; padding: 14px; }
  .protein-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }

  .settings-panel { background: var(--surface); border-radius: 20px; padding: 20px; border: 1px solid var(--border); display: none; }
  .settings-panel.open { display: block; }
  .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .settings-section h3 { font-size: 14px; color: var(--accent); margin-bottom: 12px; font-weight: 700; }
  .setting-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  .setting-label { font-size: 13px; color: var(--text-dim); }
  .setting-input { width: 90px; padding: 6px 10px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: 'Heebo', sans-serif; font-size: 14px; text-align: center; }
  .setting-input:focus { outline: none; border-color: var(--accent); }
  .settings-toggle-btn { display: flex; align-items: center; gap: 8px; background: transparent; border: 1px solid var(--border); color: var(--text-dim); padding: 8px 16px; border-radius: 10px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 13px; transition: all 0.2s; }
  .settings-toggle-btn:hover { border-color: var(--accent); color: var(--accent); }
  /* Toggle switch */
  .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; flex-shrink: 0; }
  .toggle-switch input { opacity: 0; width: 0; height: 0; }
  .toggle-slider { position: absolute; cursor: pointer; inset: 0; background: var(--surface2); border-radius: 26px; transition: 0.3s; border: 1px solid var(--border); }
  .toggle-slider::before { content: ''; position: absolute; height: 18px; width: 18px; right: 3px; bottom: 3px; background: var(--text-dim); border-radius: 50%; transition: 0.3s; }
  .toggle-switch input:checked + .toggle-slider { background: var(--accent); border-color: var(--accent); }
  .toggle-switch input:checked + .toggle-slider::before { background: #000; transform: translateX(-24px); }

  .save-settings-btn { background: var(--accent); color: #000; border: none; padding: 10px 24px; border-radius: 10px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 14px; font-weight: 700; margin-top: 16px; transition: all 0.2s; }
  .save-settings-btn:hover { opacity: 0.9; transform: translateY(-1px); }

  .input-area { background: var(--surface); border-radius: 20px; padding: 20px; border: 1px solid var(--border); }
  .input-area h2 { font-size: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
  .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
  .tab-btn { flex: 1; padding: 10px; border-radius: 12px; border: 1px solid var(--border); background: transparent; color: var(--text-dim); cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 14px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
  .tab-btn.active { background: var(--surface2); border-color: var(--accent); color: var(--accent); }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  textarea { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 14px; color: var(--text); font-family: 'Heebo', sans-serif; font-size: 15px; padding: 14px; resize: none; height: 100px; direction: rtl; line-height: 1.6; transition: border-color 0.2s; }
  textarea:focus { outline: none; border-color: var(--accent); }
  textarea::placeholder { color: var(--text-dim); }

  .image-drop { border: 2px dashed var(--border); border-radius: 14px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; }
  .image-drop:hover { border-color: var(--accent); background: rgba(0,212,170,0.05); }
  .image-drop input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
  .drop-icon { font-size: 40px; margin-bottom: 10px; }
  .img-source-btn { padding: 12px 20px; border-radius: 12px; border: none; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 15px; font-weight: 700; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
  .camera-btn { background: var(--accent); color: #000; }
  .camera-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,212,170,0.3); }
  .gallery-btn { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .gallery-btn:hover { border-color: var(--accent); color: var(--accent); }
  .drop-text { color: var(--text-dim); font-size: 14px; }
  .drop-text strong { color: var(--accent); }
  .image-preview { margin-top: 12px; position: relative; display: none; }
  .image-preview img { width: 100%; max-height: 250px; object-fit: contain; border-radius: 12px; }
  .remove-image { position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.7); border: none; color: white; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; }

  .analyze-btn { width: 100%; margin-top: 14px; padding: 14px; background: linear-gradient(135deg, var(--accent), #00b890); color: #000; border: none; border-radius: 14px; font-family: 'Heebo', sans-serif; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
  .analyze-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,212,170,0.3); }
  .analyze-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
  .spinner { width: 18px; height: 18px; border: 2px solid rgba(0,0,0,0.3); border-top-color: #000; border-radius: 50%; animation: spin 0.7s linear infinite; display: none; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .result-card { background: var(--surface); border-radius: 20px; border: 1px solid var(--border); overflow: hidden; display: none; }
  .result-card.visible { display: block; }
  .result-header { padding: 16px 20px; background: linear-gradient(135deg, rgba(0,212,170,0.1), rgba(167,139,250,0.1)); border-bottom: 1px solid var(--border); }
  .result-meal-name { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
  .result-portions { font-size: 13px; color: var(--text-dim); }
  .result-macros { display: grid; grid-template-columns: repeat(5, 1fr); border-bottom: 1px solid var(--border); }
  .result-macro { padding: 16px; text-align: center; border-left: 1px solid var(--border); }
  .result-macro:last-child { border-left: none; }
  .result-macro-val { font-size: 22px; font-weight: 900; display: block; margin-bottom: 2px; }
  .result-macro-lbl { font-size: 11px; color: var(--text-dim); }
  .result-macro.cal .result-macro-val { color: var(--cal-color); }
  .result-macro.prot .result-macro-val { color: var(--protein-color); }
  .result-macro.carb .result-macro-val { color: var(--carb-color); }
  .result-macro.fat .result-macro-val { color: var(--fat-color); }
  .result-macro.sug .result-macro-val { color: var(--sugar-color); }
  .result-notes { padding: 16px 20px; font-size: 14px; color: var(--text-dim); line-height: 1.7; }
  .result-actions { padding: 12px 20px; display: flex; gap: 10px; border-top: 1px solid var(--border); }
  .add-to-day-btn { flex: 1; padding: 10px; background: var(--accent); color: #000; border: none; border-radius: 10px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 14px; font-weight: 700; transition: all 0.2s; }
  .add-to-day-btn:hover { opacity: 0.9; }
  .discard-btn { padding: 10px 20px; background: transparent; color: var(--text-dim); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 14px; transition: all 0.2s; }
  .discard-btn:hover { border-color: var(--accent2); color: var(--accent2); }

  /* CHAT */
  .chat-section { background: var(--surface); border-radius: 20px; border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; }
  .chat-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, rgba(0,212,170,0.08), rgba(167,139,250,0.08)); }
  .chat-header h2 { font-size: 16px; display: flex; align-items: center; gap: 8px; }
  .chat-badge { font-size: 10px; background: var(--accent); color: #000; padding: 2px 8px; border-radius: 20px; font-weight: 700; }
  .chat-clear-btn { background: transparent; border: 1px solid var(--border); color: var(--text-dim); padding: 4px 12px; border-radius: 8px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 12px; transition: all 0.2s; }
  .chat-clear-btn:hover { border-color: var(--accent2); color: var(--accent2); }
  .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; min-height: 300px; max-height: 450px; }
  .chat-welcome { text-align: center; padding: 24px 20px; color: var(--text-dim); }
  .chat-welcome .welcome-icon { font-size: 44px; margin-bottom: 10px; }
  .chat-welcome h3 { font-size: 16px; color: var(--text); margin-bottom: 8px; }
  .chat-welcome p { font-size: 13px; line-height: 1.6; }
  .chat-suggestions { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 14px; }
  .suggestion-chip { background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim); padding: 6px 14px; border-radius: 20px; font-size: 12px; cursor: pointer; font-family: 'Heebo', sans-serif; transition: all 0.2s; }
  .suggestion-chip:hover { border-color: var(--accent); color: var(--accent); background: rgba(0,212,170,0.08); }
  .msg { display: flex; gap: 10px; animation: fadeUp 0.3s ease; }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .msg.user { flex-direction: row-reverse; }
  .msg-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; margin-top: 2px; }
  .msg.user .msg-avatar { background: var(--accent); }
  .msg.ai .msg-avatar { background: var(--surface2); border: 1px solid var(--border); }
  .msg-bubble { max-width: 80%; padding: 12px 16px; border-radius: 16px; font-size: 14px; line-height: 1.7; white-space: pre-wrap; }
  .msg.user .msg-bubble { background: var(--accent); color: #000; border-bottom-left-radius: 4px; }
  .msg.ai .msg-bubble { background: var(--surface2); color: var(--text); border-bottom-right-radius: 4px; }
  .msg-typing .msg-bubble { display: flex; gap: 4px; align-items: center; padding: 14px 18px; }
  .typing-dot { width: 8px; height: 8px; background: var(--text-dim); border-radius: 50%; animation: typingBounce 1.2s infinite; }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes typingBounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }
  .chat-input-row { padding: 14px 16px; border-top: 1px solid var(--border); display: flex; gap: 10px; align-items: flex-end; }
  .chat-input { flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 14px; color: var(--text); font-family: 'Heebo', sans-serif; font-size: 14px; padding: 10px 14px; resize: none; direction: rtl; line-height: 1.5; height: 42px; max-height: 100px; transition: border-color 0.2s; }
  .chat-input:focus { outline: none; border-color: var(--accent); }
  .chat-input::placeholder { color: var(--text-dim); }
  .chat-send-btn { width: 42px; height: 42px; background: var(--accent); border: none; border-radius: 12px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
  .chat-send-btn:hover { transform: scale(1.05); opacity: 0.9; }
  .chat-send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  /* Meal Log */
  .meal-log { background: var(--surface); border-radius: 20px; padding: 20px; border: 1px solid var(--border); }
  .meal-log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .meal-log-header h2 { font-size: 16px; }
  .reset-btn { padding: 6px 14px; background: transparent; color: var(--accent2); border: 1px solid rgba(255,107,107,0.3); border-radius: 8px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 12px; transition: all 0.2s; }
  .reset-btn:hover { background: rgba(255,107,107,0.1); }
  .meal-item { background: var(--surface2); border-radius: 14px; padding: 14px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; gap: 12px; animation: slideIn 0.3s ease; }
  @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
  .meal-info { flex: 1; }
  .meal-name { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
  .meal-macros-mini { font-size: 12px; color: var(--text-dim); display: flex; gap: 12px; flex-wrap: wrap; }
  .meal-cal { color: var(--cal-color); font-weight: 700; font-size: 16px; }
  .delete-meal { background: transparent; border: none; color: var(--text-dim); cursor: pointer; padding: 4px 8px; border-radius: 6px; font-size: 16px; transition: all 0.2s; }
  .delete-meal:hover { color: var(--accent2); background: rgba(255,107,107,0.1); }
  .empty-log { text-align: center; padding: 30px; color: var(--text-dim); font-size: 14px; }
  .empty-log .empty-icon { font-size: 40px; margin-bottom: 10px; }

  .loading-message { text-align: center; padding: 20px; color: var(--text-dim); font-size: 14px; display: none; }
  .loading-message.visible { display: block; }
  .loading-dots::after { content: ''; animation: dots 1.5s infinite; }
  @keyframes dots { 0% { content: '.'; } 33% { content: '..'; } 66% { content: '...'; } }

  /* Save day button */
  .save-day-btn { padding: 6px 14px; background: linear-gradient(135deg, var(--accent), #00b890); color: #000; border: none; border-radius: 8px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 12px; font-weight: 700; transition: all 0.2s; }
  .save-day-btn:hover { opacity: 0.9; transform: translateY(-1px); }
  .transfer-btn { padding: 6px 14px; background: linear-gradient(135deg, #a78bfa, #7c3aed); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 12px; font-weight: 700; transition: all 0.2s; }
  .transfer-btn:hover { opacity: 0.9; transform: translateY(-1px); }

  /* History */
  .history-section { background: var(--surface); border-radius: 20px; padding: 20px; border: 1px solid var(--border); }
  .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .history-header h2 { font-size: 16px; }
  .report-btn { padding: 7px 16px; background: #a78bfa; color: #000; border: none; border-radius: 8px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 13px; font-weight: 700; transition: all 0.2s; }
  .report-btn:hover { opacity: 0.9; }

  .history-day { background: var(--surface2); border-radius: 14px; padding: 16px; margin-bottom: 10px; }
  .history-day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .history-day-date { font-size: 14px; font-weight: 700; }
  .history-day-profile { font-size: 11px; color: var(--text-dim); background: var(--surface); padding: 2px 10px; border-radius: 10px; }
  .history-day-macros { display: flex; gap: 12px; flex-wrap: wrap; font-size: 12px; color: var(--text-dim); margin-bottom: 8px; }
  .history-day-macros span b { color: var(--text); }
  .history-meal-list { font-size: 12px; color: var(--text-dim); border-top: 1px solid var(--border); padding-top: 8px; }
  .history-meal-item { display: flex; justify-content: space-between; padding: 3px 0; }
  .history-day-actions { display: flex; gap: 8px; margin-top: 10px; }
  .delete-day-btn { padding: 4px 12px; background: transparent; color: var(--accent2); border: 1px solid rgba(255,107,107,0.3); border-radius: 8px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 11px; transition: all 0.2s; }
  .delete-day-btn:hover { background: rgba(255,107,107,0.1); }
  .edit-day-btn { padding: 4px 12px; background: transparent; color: var(--accent); border: 1px solid rgba(0,212,170,0.3); border-radius: 8px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 11px; transition: all 0.2s; }
  .edit-day-btn:hover { background: rgba(0,212,170,0.1); }

  /* Edit Day Modal */
  .edit-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9500; display: none; align-items: center; justify-content: center; padding: 16px; }
  .edit-modal-overlay.open { display: flex; }
  .edit-modal-box { background: var(--surface); border-radius: 20px; border: 1px solid var(--border); width: 100%; max-width: 560px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
  .edit-modal-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, rgba(0,212,170,0.08), rgba(167,139,250,0.08)); }
  .edit-modal-header h3 { font-size: 16px; }
  .edit-modal-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
  .edit-modal-footer { padding: 14px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }

  .edit-date-row { display: flex; flex-direction: column; gap: 6px; }
  .edit-date-row label { font-size: 13px; color: var(--text-dim); }
  .edit-date-input { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-family: 'Heebo', sans-serif; font-size: 14px; padding: 10px 14px; width: 100%; }
  .edit-date-input:focus { outline: none; border-color: var(--accent); }

  .edit-meals-title { font-size: 14px; font-weight: 700; color: var(--text-dim); margin-bottom: 4px; }
  .edit-meal-row { background: var(--surface2); border-radius: 12px; padding: 12px 14px; display: flex; align-items: center; gap: 10px; }
  .edit-meal-name { flex: 1; font-size: 14px; }
  .edit-meal-cal { font-size: 12px; color: var(--cal-color); white-space: nowrap; }
  .edit-meal-delete { background: transparent; border: none; color: var(--text-dim); cursor: pointer; font-size: 16px; padding: 2px 6px; border-radius: 6px; transition: all 0.2s; }
  .edit-meal-delete:hover { color: var(--accent2); background: rgba(255,107,107,0.1); }

  .save-edit-btn { padding: 10px 24px; background: var(--accent); color: #000; border: none; border-radius: 10px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 14px; font-weight: 700; }
  .cancel-edit-btn { padding: 10px 20px; background: transparent; border: 1px solid var(--border); color: var(--text-dim); border-radius: 10px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 14px; }

  /* Modal */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9000; display: none; align-items: center; justify-content: center; padding: 20px; }
  .modal-overlay.open { display: flex; }
  .modal-box { background: var(--surface); border-radius: 20px; border: 1px solid var(--border); width: 100%; max-width: 700px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
  .modal-header { padding: 18px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, rgba(167,139,250,0.1), rgba(0,212,170,0.1)); }
  .modal-header h3 { font-size: 18px; }
  .modal-close { background: transparent; border: none; color: var(--text-dim); font-size: 20px; cursor: pointer; padding: 4px 8px; border-radius: 6px; }
  .modal-close:hover { color: var(--accent2); }
  .modal-profile-tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); }
  .modal-tab { flex: 1; padding: 10px; background: transparent; border: none; color: var(--text-dim); cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 14px; border-bottom: 2px solid transparent; transition: all 0.2s; }
  .modal-tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 700; }
  .modal-body { flex: 1; overflow-y: auto; padding: 20px; }
  .modal-footer { padding: 14px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }
  .print-btn { padding: 8px 18px; background: var(--accent); color: #000; border: none; border-radius: 10px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 14px; font-weight: 700; }
  .copy-btn { padding: 8px 18px; background: transparent; border: 1px solid var(--border); color: var(--text-dim); border-radius: 10px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 14px; }
  .copy-btn:hover { border-color: var(--accent); color: var(--accent); }
  .modal-close-btn { padding: 8px 18px; background: transparent; border: 1px solid var(--border); color: var(--text-dim); border-radius: 10px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 14px; }

  /* Report content */
  .report-profile-title { font-size: 22px; font-weight: 900; color: var(--accent); margin-bottom: 4px; }
  .report-period { font-size: 13px; color: var(--text-dim); margin-bottom: 20px; }
  .report-avg-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 24px; }
  .report-avg-card { background: var(--surface2); border-radius: 12px; padding: 12px; text-align: center; }
  .report-avg-val { font-size: 22px; font-weight: 900; display: block; }
  .report-avg-lbl { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
  .report-avg-card.cal .report-avg-val { color: var(--cal-color); }
  .report-avg-card.prot .report-avg-val { color: var(--protein-color); }
  .report-avg-card.carb .report-avg-val { color: var(--carb-color); }
  .report-avg-card.fat .report-avg-val { color: var(--fat-color); }
  .report-avg-card.sug .report-avg-val { color: var(--sugar-color); }
  .report-day-block { background: var(--surface2); border-radius: 12px; padding: 14px; margin-bottom: 12px; }
  .report-day-title { font-size: 13px; font-weight: 700; margin-bottom: 8px; color: var(--text); }
  .report-day-totals { font-size: 12px; color: var(--text-dim); margin-bottom: 8px; }
  .report-meal-row { font-size: 12px; color: var(--text-dim); padding: 3px 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
  .report-meal-row:last-child { border-bottom: none; }
  /* Copy workout btn */
  .copy-workout-btn { padding: 7px 14px; background: var(--surface2); color: var(--text-dim); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 13px; font-weight: 700; transition: all 0.2s; }
  .copy-workout-btn:hover { border-color: var(--accent); color: var(--accent); }
  .past-workout-item { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 10px 14px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
  .past-workout-item:hover { border-color: #f97316; background: rgba(249,115,22,0.08); }
  .past-workout-item-name { font-weight: 700; }
  .past-workout-item-detail { font-size: 11px; color: var(--text-dim); margin-top: 2px; }

  /* Weight section */
  .weight-section { background: var(--surface); border-radius: 20px; padding: 18px 20px; border: 1px solid var(--border); }
  .weight-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
  .weight-header h2 { font-size: 16px; }
  .add-weight-btn { padding: 7px 16px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: #fff; border: none; border-radius: 10px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 13px; font-weight: 700; transition: all 0.2s; }
  .add-weight-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(59,130,246,0.35); }
  .weight-empty { text-align: center; padding: 20px; }
  .weight-current { display: flex; align-items: center; gap: 16px; margin-bottom: 14px; }
  .weight-current-val { font-size: 42px; font-weight: 900; color: #60a5fa; line-height: 1; }
  .weight-current-unit { font-size: 14px; color: var(--text-dim); }
  .weight-change { font-size: 13px; font-weight: 700; padding: 4px 10px; border-radius: 10px; }
  .weight-change.down { background: rgba(0,212,170,0.15); color: var(--accent); }
  .weight-change.up { background: rgba(255,107,107,0.15); color: var(--accent2); }
  .weight-change.same { background: var(--surface2); color: var(--text-dim); }
  .weight-log { display: flex; flex-direction: column; gap: 6px; max-height: 200px; overflow-y: auto; }
  .weight-log-item { display: flex; align-items: center; justify-content: space-between; background: var(--surface2); border-radius: 10px; padding: 8px 12px; font-size: 13px; }
  .weight-log-date { color: var(--text-dim); font-size: 12px; }
  .weight-log-val { font-weight: 700; color: #60a5fa; }
  .weight-log-change { font-size: 11px; font-weight: 700; }
  .weight-log-del { background: transparent; border: none; color: var(--text-dim); cursor: pointer; font-size: 13px; padding: 2px 4px; }
  .weight-log-del:hover { color: var(--accent2); }
  .weight-chart { display: flex; align-items: flex-end; gap: 4px; height: 60px; margin-bottom: 12px; }
  .weight-bar-col { display: flex; flex-direction: column; align-items: center; gap: 3px; flex: 1; }
  .weight-bar-inner { width: 100%; background: rgba(59,130,246,0.6); border-radius: 4px 4px 0 0; min-height: 4px; transition: all 0.3s; }
  .weight-bar-label { font-size: 9px; color: var(--text-dim); white-space: nowrap; }

  /* Weight modal */
  .weight-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9700; display: none; align-items: center; justify-content: center; padding: 16px; }
  .weight-modal-overlay.open { display: flex; }
  .weight-modal-box { background: var(--surface); border-radius: 20px; border: 1px solid var(--border); width: 100%; max-width: 400px; overflow: hidden; }
  .weight-modal-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(29,78,216,0.08)); }
  .weight-modal-header h3 { font-size: 16px; }
  .weight-modal-body { padding: 20px; display: flex; flex-direction: column; gap: 14px; }
  .weight-modal-footer { padding: 14px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }
  .weight-big-input { font-size: 36px; font-weight: 900; color: #60a5fa; background: var(--surface2); border: 2px solid var(--border); border-radius: 14px; text-align: center; width: 140px; padding: 12px; font-family: 'Heebo', sans-serif; }
  .weight-big-input:focus { outline: none; border-color: #3b82f6; }
  .weight-adj-btn { width: 44px; height: 44px; border-radius: 50%; border: 1px solid var(--border); background: var(--surface2); color: var(--text); font-size: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
  .weight-adj-btn:hover { border-color: #3b82f6; color: #60a5fa; }

  .report-empty { text-align: center; padding: 40px; color: var(--text-dim); }

  /* Weekly block */
  .weekly-block { background: var(--surface2); border-radius: 14px; padding: 14px; margin-bottom: 12px; border: 1px solid var(--border); }
  .weekly-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .weekly-label { font-size: 13px; font-weight: 700; }
  .weekly-days { font-size: 11px; color: var(--text-dim); background: var(--surface); padding: 2px 8px; border-radius: 10px; }
  .weekly-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
  .weekly-stat { background: var(--surface); border-radius: 10px; padding: 10px 6px; text-align: center; }
  .ws-val { display: block; font-size: 18px; font-weight: 900; color: var(--text); }
  .ws-lbl { display: block; font-size: 10px; color: var(--text-dim); margin-top: 2px; }
  .weekly-diff { font-size: 13px; font-weight: 700; text-align: center; }

  /* Calorie rows in report */
  .report-cal-rows { display: flex; flex-direction: column; gap: 4px; margin-bottom: 4px; }
  .report-cal-row { display: flex; align-items: center; gap: 8px; font-size: 13px; padding: 4px 8px; border-radius: 8px; }
  .report-cal-row.eaten { background: rgba(0,212,170,0.06); }
  .report-cal-row.burned { background: rgba(249,115,22,0.06); }
  .report-cal-row.net { background: rgba(96,165,250,0.06); }
  .rcr-icon { font-size: 16px; flex-shrink: 0; }
  .rcr-label { color: var(--text-dim); flex: 1; }
  .rcr-val { font-weight: 700; white-space: nowrap; }

  @media print {
    .header, .main > *:not(.history-section) { display: none !important; }
    .modal-overlay { position: static; background: white; display: block !important; }
    .modal-box { max-height: none; color: #000; background: white; }
    .modal-footer, .modal-close, .modal-profile-tabs { display: none !important; }
    .modal-body { color: #000; }
    * { color: #000 !important; background: white !important; }
  }

  /* Water tracker */
  .water-section { background: var(--surface); border-radius: 20px; padding: 18px 20px; border: 1px solid var(--border); }
  .water-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; flex-wrap: wrap; gap: 10px; }
  .water-status { margin-right: 10px; font-size: 12px; padding: 2px 10px; border-radius: 20px; font-weight: 700; }
  .water-status.ok { background: rgba(0,212,170,0.15); color: var(--accent); border: 1px solid rgba(0,212,170,0.3); }
  .water-status.low { background: rgba(255,217,61,0.15); color: var(--accent3); border: 1px solid rgba(255,217,61,0.3); }
  .water-status.great { background: rgba(167,139,250,0.15); color: #a78bfa; border: 1px solid rgba(167,139,250,0.3); }
  .water-controls { display: flex; align-items: center; gap: 12px; }
  .water-minus-btn, .water-plus-btn { width: 36px; height: 36px; border-radius: 50%; border: none; font-size: 20px; line-height: 1; cursor: pointer; font-family: 'Heebo', sans-serif; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
  .water-plus-btn { background: #3b82f6; color: #fff; }
  .water-plus-btn:hover { transform: scale(1.1); background: #2563eb; }
  .water-minus-btn { background: var(--surface2); color: var(--text-dim); border: 1px solid var(--border); }
  .water-minus-btn:hover { border-color: var(--accent2); color: var(--accent2); }
  .water-count-wrap { text-align: center; min-width: 56px; }
  .water-count { font-size: 28px; font-weight: 900; color: #60a5fa; display: block; line-height: 1; }
  .water-unit { font-size: 11px; color: var(--text-dim); }
  .water-bar-wrap { margin-bottom: 12px; }
  .water-bar { height: 10px; background: rgba(255,255,255,0.07); border-radius: 10px; overflow: hidden; margin-bottom: 6px; }
  .water-bar-fill { height: 100%; border-radius: 10px; background: linear-gradient(90deg, #3b82f6, #60a5fa); transition: width 0.4s ease; }
  .water-bar-fill.great { background: linear-gradient(90deg, #a78bfa, #3b82f6); }
  .water-ml { font-size: 12px; color: var(--text-dim); }
  .water-cups { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px; }
  .water-cup { font-size: 22px; transition: all 0.2s; cursor: default; }
  .water-cup.empty { opacity: 0.2; filter: grayscale(1); }

  /* Coffee tracker */
  .coffee-section { background: var(--surface); border-radius: 20px; padding: 18px 20px; border: 1px solid var(--border); }
  .coffee-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 10px; }
  .coffee-status { font-size: 12px; padding: 2px 10px; border-radius: 20px; font-weight: 700; }
  .coffee-status.ok { background: rgba(180,120,60,0.15); color: #c87941; border: 1px solid rgba(180,120,60,0.3); }
  .coffee-status.limit { background: rgba(255,107,107,0.15); color: var(--accent2); border: 1px solid rgba(255,107,107,0.3); }
  .coffee-controls { display: flex; align-items: center; gap: 10px; }
  .coffee-minus-btn { width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--border); background: var(--surface2); color: var(--text-dim); font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
  .coffee-minus-btn:hover { border-color: var(--accent2); color: var(--accent2); }
  .coffee-plus-btn { padding: 7px 14px; background: linear-gradient(135deg, #92400e, #c87941); color: #fff; border: none; border-radius: 10px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 13px; font-weight: 700; transition: all 0.2s; }
  .coffee-plus-btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(200,121,65,0.35); }
  .coffee-plus-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }
  .coffee-count-wrap { display: flex; align-items: baseline; gap: 4px; min-width: 60px; }
  .coffee-count { font-size: 26px; font-weight: 900; color: #c87941; line-height: 1; }
  .coffee-unit { font-size: 12px; color: var(--text-dim); }
  .coffee-cups { display: flex; gap: 8px; margin-bottom: 10px; }
  .coffee-cup { font-size: 22px; transition: all 0.2s; }
  .coffee-cup.empty { opacity: 0.2; filter: grayscale(1); }
  .coffee-info { font-size: 11px; color: var(--text-dim); }

  /* Workout section */
  .workout-section { background: var(--surface); border-radius: 20px; padding: 18px 20px; border: 1px solid var(--border); }
  .workout-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
  .workout-section-header h2 { font-size: 16px; }
  .add-workout-btn { padding: 7px 16px; background: linear-gradient(135deg, #f97316, #ef4444); color: #fff; border: none; border-radius: 10px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 13px; font-weight: 700; transition: all 0.2s; }
  .add-workout-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(249,115,22,0.35); }
  .workout-empty { text-align: center; padding: 24px; }
  .workout-item { background: var(--surface2); border-radius: 12px; padding: 12px 14px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; }
  .workout-item-icon { font-size: 26px; flex-shrink: 0; }
  .workout-item-info { flex: 1; }
  .workout-item-name { font-size: 14px; font-weight: 700; }
  .workout-item-details { font-size: 12px; color: var(--text-dim); margin-top: 2px; }
  .workout-item-burn { color: #f97316; font-weight: 900; font-size: 16px; white-space: nowrap; }
  .workout-item-delete { background: transparent; border: none; color: var(--text-dim); cursor: pointer; font-size: 16px; padding: 4px 6px; border-radius: 6px; transition: all 0.2s; }
  .workout-item-delete:hover { color: var(--accent2); background: rgba(255,107,107,0.1); }
  .workout-item-edit { background: transparent; border: none; color: var(--text-dim); cursor: pointer; font-size: 16px; padding: 4px 6px; border-radius: 6px; transition: all 0.2s; }
  .workout-item-edit:hover { color: var(--accent); background: rgba(0,212,170,0.1); }
  .workout-totals { display: flex; gap: 20px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 13px; color: var(--text-dim); }
  .workout-totals b { color: #f97316; }

  /* Workout modal */
  .workout-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9600; display: none; align-items: center; justify-content: center; padding: 16px; }
  .workout-modal-overlay.open { display: flex; }
  .workout-modal-box { background: var(--surface); border-radius: 20px; border: 1px solid var(--border); width: 100%; max-width: 520px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
  .workout-modal-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, rgba(249,115,22,0.1), rgba(239,68,68,0.08)); }
  .workout-modal-header h3 { font-size: 16px; }
  .workout-modal-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 18px; }
  .workout-modal-footer { padding: 14px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }
  .workout-field { display: flex; flex-direction: column; gap: 8px; }
  .workout-field label { font-size: 13px; color: var(--text-dim); font-weight: 500; }
  .workout-type-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
  .workout-type-btn { background: var(--surface2); border: 2px solid transparent; border-radius: 12px; padding: 10px 6px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 12px; color: var(--text-dim); display: flex; flex-direction: column; align-items: center; gap: 4px; transition: all 0.2s; }
  .workout-type-btn:hover { border-color: rgba(249,115,22,0.4); color: var(--text); }
  .workout-type-btn.selected { border-color: #f97316; background: rgba(249,115,22,0.1); color: #f97316; font-weight: 700; }
  .duration-btns { display: flex; flex-wrap: wrap; gap: 8px; }
  .dur-btn { padding: 6px 14px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 13px; color: var(--text-dim); transition: all 0.2s; }
  .dur-btn:hover, .dur-btn.active { border-color: #f97316; color: #f97316; background: rgba(249,115,22,0.1); }
  .intensity-btns { display: flex; gap: 8px; }
  .intensity-btn { flex: 1; padding: 8px; background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 13px; color: var(--text-dim); transition: all 0.2s; }
  .intensity-btn.active { border-color: #f97316; background: rgba(249,115,22,0.1); color: #f97316; font-weight: 700; }
  .workout-input { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-family: 'Heebo', sans-serif; font-size: 14px; padding: 10px 14px; width: 100%; margin-top: 4px; }
  .workout-input:focus { outline: none; border-color: #f97316; }
  .workout-burn-preview { background: rgba(249,115,22,0.1); border: 1px solid rgba(249,115,22,0.3); border-radius: 14px; padding: 16px; text-align: center; }
  .burn-icon { font-size: 32px; margin-bottom: 4px; }
  .burn-val { font-size: 36px; font-weight: 900; color: #f97316; line-height: 1; }
  .burn-lbl { font-size: 12px; color: var(--text-dim); margin-top: 4px; }

  /* Exercises/sets tracking */
  .add-exercise-btn { padding: 5px 12px; background: rgba(249,115,22,0.15); color: #f97316; border: 1px solid rgba(249,115,22,0.3); border-radius: 8px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 12px; font-weight: 700; transition: all 0.2s; }
  .add-exercise-btn:hover { background: rgba(249,115,22,0.25); }
  .exercise-row { background: var(--surface2); border-radius: 12px; padding: 12px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px; }
  .exercise-top { display: flex; gap: 8px; align-items: center; }
  .muscle-chips { display: flex; flex-wrap: wrap; gap: 6px; }
  .muscle-chip { padding: 3px 10px; background: var(--surface); border: 1px solid var(--border); border-radius: 20px; font-size: 11px; color: var(--text-dim); cursor: pointer; transition: all 0.2s; }
  .muscle-chip.selected { background: rgba(249,115,22,0.15); border-color: #f97316; color: #f97316; font-weight: 700; }
  .exercise-sets { display: flex; flex-direction: column; gap: 6px; }
  .set-row { display: flex; align-items: center; gap: 8px; font-size: 13px; }
  .set-num { width: 24px; height: 24px; background: rgba(249,115,22,0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: #f97316; flex-shrink: 0; }
  .set-input { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: 'Heebo', sans-serif; font-size: 13px; padding: 5px 8px; width: 60px; text-align: center; }
  .set-input:focus { outline: none; border-color: #f97316; }
  .set-label { color: var(--text-dim); font-size: 12px; flex-shrink: 0; }
  .set-delete { background: transparent; border: none; color: var(--text-dim); cursor: pointer; font-size: 14px; padding: 2px 5px; }
  .set-delete:hover { color: var(--accent2); }
  .exercise-actions { display: flex; gap: 8px; align-items: center; }
  .add-set-btn { padding: 4px 10px; background: transparent; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 11px; color: var(--text-dim); transition: all 0.2s; }
  .add-set-btn:hover { border-color: #f97316; color: #f97316; }
  .remove-exercise-btn { padding: 4px 10px; background: transparent; border: 1px solid rgba(255,107,107,0.3); border-radius: 8px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 11px; color: var(--accent2); transition: all 0.2s; }
  .remove-exercise-btn:hover { background: rgba(255,107,107,0.1); }
  .exercise-name-input { flex: 1; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: 'Heebo', sans-serif; font-size: 13px; padding: 6px 10px; }
  .exercise-name-input:focus { outline: none; border-color: #f97316; }

  /* Workout detail in history */
  .workout-exercises-detail { margin-top: 8px; border-top: 1px solid var(--border); padding-top: 8px; }
  .exercise-detail-item { font-size: 12px; color: var(--text-dim); padding: 3px 0; }

  @media (max-width: 600px) {
    .workout-type-grid { grid-template-columns: repeat(4, 1fr); }
    .macros-grid { grid-template-columns: repeat(2, 1fr); }
    .result-macros { grid-template-columns: repeat(3, 1fr); }
    .settings-grid { grid-template-columns: 1fr; }
    .main { padding: 12px; }
    .msg-bubble { max-width: 90%; }
    .report-avg-grid { grid-template-columns: repeat(3, 1fr); }
  }
</style>
</head>
<body>

<header class="header">
  <div class="header-inner">
    <div class="logo">  </div>
    <div style="display:flex;gap:10px;align-items:center">
      <button class="settings-toggle-btn" onclick="toggleSettings()">锔 专转</button>
      <div class="profile-toggle">
        <button class="profile-btn active" onclick="switchProfile('me')">注</button>
        <button class="profile-btn" onclick="switchProfile('wife')"></button>
      </div>
    </div>
  </div>
</header>

<div class="main">

  <!-- Settings Panel -->
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-grid">
      <div class="settings-section">
        <h3> 注 (住专转)</h3>
        <div class="setting-row"><span class="setting-label">拽专转 拽住. </span><input type="number" class="setting-input" id="me-cal" value="2000"></div>
        <div class="setting-row"><span class="setting-label"> .  (专)</span><input type="number" class="setting-input" id="me-protein" value="100"></div>
        <div class="setting-row"><span class="setting-label">驻转 拽住. (专)</span><input type="number" class="setting-input" id="me-carbs" value="160"></div>
        <div class="setting-row"><span class="setting-label">住专 住祝 拽住. (专)</span><input type="number" class="setting-input" id="me-sugar" value="25"></div>
      </div>
      <div class="settings-section">
        <h3>  ()</h3>
        <div class="setting-row"><span class="setting-label">拽专转 拽住. </span><input type="number" class="setting-input" id="wife-cal" value="1400"></div>
        <div class="setting-row"><span class="setting-label"> .  (专)</span><input type="number" class="setting-input" id="wife-protein" value="90"></div>
        <div class="setting-row"><span class="setting-label">驻转 拽住. (专)</span><input type="number" class="setting-input" id="wife-carbs" value="120"></div>
        <div class="setting-row"><span class="setting-label">住专 住祝 拽住. (专)</span><input type="number" class="setting-input" id="wife-sugar" value="40"></div>
      </div>
    </div>
    <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;">
      <div>
        <div style="font-size:14px;font-weight:700;">爪 驻专驻 </div>
        <div style="font-size:12px;color:var(--text-dim);margin-top:2px;">砖专    住转专转 </div>
      </div>
      <label class="toggle-switch">
        <input type="checkbox" id="showWifeToggle" onchange="toggleWifeProfile(this.checked)">
        <span class="toggle-slider"></span>
      </label>
    </div>

    <button class="save-settings-btn" onclick="saveSettings()"> 砖专 专转</button>
    <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);">
      <div style="font-size:13px;font-weight:700;margin-bottom:10px;"> 注专转 转</div>
      <div style="display:flex;gap:10px;margin-bottom:10px;">
        <button onclick="exportData()" style="flex:1;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;cursor:pointer;font-family:'Heebo',sans-serif;font-size:13px;font-weight:700;color:var(--accent);"> 注转拽 转</button>
        <button onclick="openImportModal()" style="flex:1;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;cursor:pointer;font-family:'Heebo',sans-serif;font-size:13px;font-weight:700;color:var(--accent3);"> 拽 转</button>
      </div>
      <div style="font-size:11px;color:var(--text-dim);">  注转拽  砖 注爪  拽 驻拽爪 砖</div>
    </div>
  </div>

  <!-- Daily Summary -->
  <div class="daily-summary">
    <div class="summary-title"> 住   <span id="profileName">注</span></div>
    <div class="macros-grid">
      <div class="macro-card protein">
        <div class="macro-value" id="total-protein">0</div>
        <div class="macro-label"> (专)</div>
        <div class="macro-target">. <span id="target-protein">97</span> 专</div>
      </div>
      <div class="macro-card carbs">
        <div class="macro-value" id="total-carbs">0</div>
        <div class="macro-label">驻转 (专)</div>
        <div class="macro-target">拽住. <span id="target-carbs">150</span> 专</div>
      </div>
      <div class="macro-card fat">
        <div class="macro-value" id="total-fat">0</div>
        <div class="macro-label">砖 (专)</div>
        <div class="macro-target"> </div>
      </div>
      <div class="macro-card sugar">
        <div class="macro-value" id="total-sugar">0</div>
        <div class="macro-label">住专 住祝 (专)</div>
        <div class="macro-target">拽住. <span id="target-sugar">30</span> 专</div>
      </div>
    </div>
    <div class="calorie-section">
      <div class="calorie-header">
        <span class="calorie-label">斤 拽专转 砖转</span>
        <span><span class="calorie-current" id="total-cal">0</span><span class="calorie-max"> / <span id="target-cal">2000</span> 拽拽"</span></span>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="cal-progress" style="width:0%"></div></div>
    </div>
    <div class="calorie-section" id="workout-cal-section" style="display:none;">
      <div class="calorie-header">
        <span class="calorie-label" style="color:#f97316;"> 砖专驻转 </span>
        <span style="color:#f97316;"><span id="summary-burned">0</span> 拽拽"</span>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;padding:8px 12px;background:rgba(249,115,22,0.08);border-radius:10px;border:1px solid rgba(249,115,22,0.2);">
        <span style="font-size:13px;color:var(--text-dim);">锔  (转  砖专驻转)</span>
        <span style="font-size:15px;font-weight:700;" id="summary-net">0</span>
        <span style="font-size:12px;color:var(--text-dim);" id="summary-net-diff"></span>
      </div>
    </div>
    <div class="protein-progress" style="margin-top:12px">
      <div class="protein-header">
        <span> </span>
        <span style="color:var(--protein-color)"><span id="protein-pct">0</span>% 专</span>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="protein-progress" style="width:0%;background:linear-gradient(90deg,var(--protein-color),#00ffcc)"></div></div>
    </div>
    <div class="alerts" id="alerts"></div>
  </div>

  <!-- Water Tracker -->
  <div class="water-section">
    <div class="water-header">
      <div>
        <span style="font-size:15px;font-weight:700;"> 砖转转 </span>
        <span class="water-status" id="waterStatus"></span>
      </div>
      <div class="water-controls">
        <button class="water-minus-btn" onclick="changeWater(-1)">锛</button>
        <div class="water-count-wrap">
          <span class="water-count" id="waterCount">0</span>
          <span class="water-unit">住转</span>
        </div>
        <button class="water-plus-btn" onclick="changeWater(1)">锛</button>
      </div>
    </div>
    <div class="water-bar-wrap">
      <div class="water-bar"><div class="water-bar-fill" id="waterBarFill" style="width:0%"></div></div>
      <div class="water-ml" id="waterMl">0 " 转 15002000 "</div>
    </div>
    <div class="water-cups" id="waterCups"></div>
  </div>

  <!-- Coffee Tracker -->
  <div class="coffee-section">
    <div class="coffee-header">
      <div style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:15px;font-weight:700;"> 拽驻 </span>
        <span class="coffee-status" id="coffeeStatus"></span>
      </div>
      <div class="coffee-controls">
        <button class="coffee-minus-btn" onclick="changeCoffee(-1)">锛</button>
        <div class="coffee-count-wrap">
          <span class="coffee-count" id="coffeeCount">0</span>
          <span class="coffee-unit">/ 5 住转</span>
        </div>
        <button class="coffee-plus-btn" id="coffeePlusBtn" onclick="changeCoffee(1)">锛 住祝 拽驻</button>
      </div>
    </div>
    <div class="coffee-cups" id="coffeeCups"></div>
    <div class="coffee-info">住驻专住 + 240 "  3% 路 156 拽拽" 路 8 专  路 12 专 驻转</div>
  </div>

  <!-- Workout Tracker -->
  <div class="workout-section">
    <div class="workout-section-header">
      <h2>  砖专</h2>
      <div style="display:flex;gap:8px;">
        <button class="copy-workout-btn" onclick="openAddWorkout(true)" title="注转拽  拽"> 注转拽</button>
        <button class="add-workout-btn" onclick="openAddWorkout()">锛 住祝 </button>
      </div>
    </div>
    <div id="workoutList">
      <div class="workout-empty" id="workoutEmpty">
        <span style="font-size:32px"></span>
        <div style="margin-top:8px;font-size:13px;color:var(--text-dim)"> 转注转  </div>
      </div>
    </div>
    <div class="workout-totals" id="workoutTotals" style="display:none">
      <span> 砖专驻转 住": <b id="totalBurned">0</b> 拽拽"</span>
      <span>憋 <b id="totalMins">0</b> 拽转</span>
    </div>
  </div>

  <!-- Add Workout Modal -->
  <div class="workout-modal-overlay" id="workoutModal" onclick="closeWorkoutOnBg(event)">
    <div class="workout-modal-box">
      <div class="workout-modal-header">
        <h3 id="workoutModalTitle"> 住祝 </h3>
        <button class="modal-close" onclick="closeAddWorkout()"></button>
      </div>
      <div class="workout-modal-body">
        <!-- Copy from past workouts -->
        <div id="copyPastSection" style="display:none;">
          <div style="font-size:13px;color:var(--text-dim);font-weight:500;margin-bottom:8px;"> 注转拽  拽</div>
          <div id="pastWorkoutsList" style="display:flex;flex-direction:column;gap:6px;max-height:160px;overflow-y:auto;"></div>
          <div style="border-bottom:1px solid var(--border);margin:14px 0;"></div>
        </div>
        <div class="workout-field">
          <label>住 </label>
          <div class="workout-type-grid" id="workoutTypeGrid"></div>
        </div>
        <div class="workout-field">
          <label>砖  (拽转)</label>
          <div class="duration-btns">
            <button class="dur-btn" onclick="setDuration(15)">15'</button>
            <button class="dur-btn" onclick="setDuration(20)">20'</button>
            <button class="dur-btn" onclick="setDuration(30)">30'</button>
            <button class="dur-btn" onclick="setDuration(45)">45'</button>
            <button class="dur-btn" onclick="setDuration(60)">60'</button>
            <button class="dur-btn" onclick="setDuration(90)">90'</button>
          </div>
          <input type="number" class="workout-input" id="durationInput" placeholder=" 住 转..." min="1" max="300" oninput="calcBurn()">
        </div>
        <div class="workout-field">
          <label>注爪转</label>
          <div class="intensity-btns">
            <button class="intensity-btn active" data-val="0.8" onclick="setIntensity(this, 0.8)"> 拽</button>
            <button class="intensity-btn" data-val="1.0" onclick="setIntensity(this, 1.0)"> 转</button>
            <button class="intensity-btn" data-val="1.25" onclick="setIntensity(this, 1.25)"> </button>
          </div>
        </div>
        <div class="workout-burn-preview" id="burnPreview" style="display:none">
          <div class="burn-icon"></div>
          <div class="burn-val" id="burnVal">0</div>
          <div class="burn-lbl">拽拽" 砖专驻 (注专)</div>
        </div>
        <div class="workout-field">
          <label>注专 (驻爪)</label>
          <input type="text" class="workout-input" id="workoutNote" placeholder="': 驻专拽 专拽, 专 砖专...">
        </div>

        <!-- Sets tracking - only shown for gym/relevant workout -->
        <div id="setsSection" style="display:none;">
          <div style="border-top:1px solid var(--border);padding-top:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
              <span style="font-size:14px;font-weight:700;"> 转注 转专</span>
              <button class="add-exercise-btn" onclick="addExerciseRow()">锛 住祝 转专</button>
            </div>
            <div id="exerciseRows"></div>
          </div>
        </div>

      </div>
      <div class="workout-modal-footer">
        <button class="cancel-edit-btn" onclick="closeAddWorkout()"></button>
        <button class="save-edit-btn" id="workoutSaveBtn" onclick="saveWorkout()"> 砖专 </button>
      </div>
    </div>
  </div>

  <!-- Input Area -->
  <div class="input-area">
    <h2> 住祝 专</h2>
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('text')">锔 拽</button>
      <button class="tab-btn" onclick="switchTab('image')"> 爪 / 转</button>
    </div>
    <div class="tab-content active" id="tab-text">
      <textarea id="foodText" placeholder=": 150 专  注祝 爪, 100 专 专  砖, 住 专拽转 注 驻转 砖 转..."></textarea>
    </div>
    <div class="tab-content" id="tab-image">
      <div class="image-drop" id="imageDrop">
        <div class="drop-icon"></div>
        <div class="drop-text" style="margin-bottom:16px;">爪 转 爪转  专 专</div>
        <div style="display:flex;gap:12px;justify-content:center;">
          <button class="img-source-btn camera-btn" onclick="openCamera()">
             驻转 爪
          </button>
          <button class="img-source-btn gallery-btn" onclick="openGallery()">
            硷 专 专
          </button>
        </div>
        <input type="file" id="imageFile" accept="image/*" onchange="handleImageSelect(event)" style="display:none;">
        <input type="file" id="cameraFile" accept="image/*" capture="environment" onchange="handleImageSelect(event)" style="display:none;">
      </div>
      <div class="image-preview" id="imagePreview">
        <img id="previewImg" src="" alt="转爪 拽">
        <button class="remove-image" onclick="removeImage()"></button>
      </div>
      <textarea id="imageNote" placeholder="(驻爪) 驻专 转 住驻" style="margin-top:10px;height:60px"></textarea>
    </div>
    <button class="analyze-btn" onclick="analyzeFood()" id="analyzeBtn">
      <div class="spinner" id="spinner"></div>
      <span id="analyzeBtnText"> 转 注专 转转</span>
    </button>
    <div class="loading-message" id="loadingMsg">
      <div style="font-size:24px;margin-bottom:8px"></div>
      Claude 转 转  砖<span class="loading-dots"></span>
    </div>
  </div>

  <!-- Result Card -->
  <div class="result-card" id="resultCard">
    <div class="result-header">
      <div class="result-meal-name" id="resultMealName"></div>
      <div class="result-portions" id="resultPortions"></div>
    </div>
    <div class="result-macros">
      <div class="result-macro cal"><span class="result-macro-val" id="r-cal">-</span><span class="result-macro-lbl">拽拽"</span></div>
      <div class="result-macro prot"><span class="result-macro-val" id="r-protein">-</span><span class="result-macro-lbl"> (专壮)</span></div>
      <div class="result-macro carb"><span class="result-macro-val" id="r-carbs">-</span><span class="result-macro-lbl">驻转 (专壮)</span></div>
      <div class="result-macro fat"><span class="result-macro-val" id="r-fat">-</span><span class="result-macro-lbl">砖 (专壮)</span></div>
      <div class="result-macro sug"><span class="result-macro-val" id="r-sugar">-</span><span class="result-macro-lbl">住专 住祝 (专壮)</span></div>
    </div>
    <div class="result-notes" id="resultNotes"></div>
    <div class="result-actions">
      <button class="add-to-day-btn" onclick="addToDay()"> 住祝  砖</button>
      <button class="discard-btn" onclick="discardResult()">锔 </button>
    </div>
  </div>

  <!-- Chat Advisor -->
  <div class="chat-section">
    <div class="chat-header">
      <h2> 注抓 转 <span class="chat-badge">AI</span></h2>
      <button class="chat-clear-btn" onclick="clearChat()">锔 拽 砖</button>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="chat-welcome" id="chatWelcome">
        <div class="welcome-icon"></div>
        <h3>砖!  注抓 转转 砖</h3>
        <p> 注  转   注 砖.<br>砖 转  砖   砖,  住祝,  转 住专转 注.</p>
        <div class="chat-suggestions">
          <button class="suggestion-chip" onclick="sendSuggestion('    专转 注专  注 注 ?')">   专转 注专?</button>
          <button class="suggestion-chip" onclick="sendSuggestion('  砖专  注 注 ?')">   砖专 ?</button>
          <button class="suggestion-chip" onclick="sendSuggestion('爪注  专转 拽专 注砖专  转 住专 住专转')"> 专转 拽专 住专转</button>
          <button class="suggestion-chip" onclick="sendSuggestion(' 专爪  注祝 注 专拽转,   抓 住专转?')"> 转 注祝 注 专拽转</button>
          <button class="suggestion-chip" onclick="sendSuggestion('    砖砖  专 ?')"> 砖砖 </button>
          <button class="suggestion-chip" onclick="sendSuggestion('转  转驻专  砖 注 97 专  住专转')"> 转驻专  砖</button>
        </div>
      </div>
    </div>
    <div class="chat-input-row">
      <textarea class="chat-input" id="chatInput" placeholder="砖 转 注 转,  砖,  住祝 ..." rows="1" onkeydown="handleChatKey(event)" oninput="autoResize(this)"></textarea>
      <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()"></button>
    </div>
  </div>

  <!-- Meal Log -->
  <div class="meal-log">
    <div class="meal-log-header">
      <h2>  专转</h2>
      <div style="display:flex;gap:8px;">
        <button class="save-day-btn" onclick="saveDay()"> 砖专 </button>
        <button class="transfer-btn" id="transferBtn" onclick="transferMeals()" title="注专 专转 驻专驻 砖"> 注专 驻专驻 砖</button>
        <button class="reset-btn" onclick="resetDay()"> 驻住 </button>
      </div>
    </div>
    <div id="mealLog">
      <div class="empty-log">
        <div class="empty-icon">斤</div>
        <div>注  住驻转 专转 </div>
        <div style="margin-top:4px;font-size:12px">转  抓 "住祝  砖"</div>
      </div>
    </div>
  </div>

  <!-- Weight Tracker -->
  <div class="weight-section">
    <div class="weight-header">
      <h2>锔 注拽 砖拽</h2>
      <button class="add-weight-btn" onclick="openWeightEntry()">锛 注 砖拽</button>
    </div>
    <div id="weightDisplay">
      <div class="weight-empty" id="weightEmpty">
        <span style="font-size:28px">锔</span>
        <div style="font-size:13px;color:var(--text-dim);margin-top:6px;">注  转 砖拽</div>
      </div>
    </div>
  </div>

  <!-- Weight Entry Modal -->
  <div class="weight-modal-overlay" id="weightModal" onclick="closeWeightOnBg(event)">
    <div class="weight-modal-box">
      <div class="weight-modal-header">
        <h3>锔 注 砖拽</h3>
        <button class="modal-close" onclick="closeWeightModal()"></button>
      </div>
      <div class="weight-modal-body">
        <div style="text-align:center;margin-bottom:16px;">
          <div style="font-size:13px;color:var(--text-dim);margin-bottom:12px;">住 砖拽 </div>
          <div style="display:flex;align-items:center;justify-content:center;gap:10px;">
            <button class="weight-adj-btn" onclick="adjustWeight(-0.1)"></button>
            <input type="number" id="weightInput" class="weight-big-input" step="0.1" min="30" max="300" placeholder="81.0">
            <button class="weight-adj-btn" onclick="adjustWeight(0.1)">锛</button>
          </div>
          <div style="font-size:13px;color:var(--text-dim);margin-top:8px;">拽"</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;">
          <label style="font-size:12px;color:var(--text-dim);"> 转专</label>
          <input type="date" id="weightDate" class="edit-date-input">
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;">
          <label style="font-size:12px;color:var(--text-dim);">注专 (驻爪)</label>
          <input type="text" id="weightNote" class="workout-input" placeholder="': 专 , 拽专...">
        </div>
      </div>
      <div class="weight-modal-footer">
        <button class="cancel-edit-btn" onclick="closeWeightModal()"></button>
        <button class="save-edit-btn" onclick="saveWeight()"> 砖专</button>
      </div>
    </div>
  </div>

  <!-- History Section -->
  <div class="history-section" id="historySection">
    <div class="history-header">
      <h2> 住专转 </h2>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="report-btn" onclick="openReport()">  转</button>
      </div>
    </div>
    <div id="historyList">
      <div class="empty-log" style="padding:24px;">
        <div class="empty-icon"></div>
        <div>注  砖专转 </div>
        <div style="margin-top:4px;font-size:12px">抓 "砖专 " 住祝 </div>
      </div>
    </div>
  </div>

</div>

<!-- Edit Day Modal -->
<div class="edit-modal-overlay" id="editDayModal" onclick="closeEditOnBg(event)">
  <div class="edit-modal-box">
    <div class="edit-modal-header">
      <h3>锔 注专转 </h3>
      <button class="modal-close" onclick="closeEditDay()"></button>
    </div>
    <div class="edit-modal-body">
      <div class="edit-date-row">
        <label> 转专</label>
        <input type="date" class="edit-date-input" id="editDateInput">
      </div>
      <div>
        <div class="edit-meals-title">斤 专转</div>
        <div id="editMealsList" style="display:flex;flex-direction:column;gap:8px;margin-top:8px;"></div>
      </div>
    </div>
    <div class="edit-modal-footer">
      <button class="cancel-edit-btn" onclick="closeEditDay()"></button>
      <button class="save-edit-btn" onclick="saveEditDay()"> 砖专 砖</button>
    </div>
  </div>
</div>

<!-- Report Modal -->
<div class="modal-overlay" id="reportModal" onclick="closeReportOnBg(event)">
  <div class="modal-box">
    <div class="modal-header">
      <h3>  转 转</h3>
      <button class="modal-close" onclick="closeReport()"></button>
    </div>
    <div class="modal-profile-tabs">
      <button class="modal-tab active" onclick="switchReportProfile('me')">注</button>
      <button class="modal-tab" onclick="switchReportProfile('wife')"></button>
    </div>
    <div class="modal-body" id="reportContent"></div>
    <div class="modal-footer">
      <button class="print-btn" onclick="printReport()">锔 驻住 / 砖专 PDF</button>
      <button class="copy-btn" onclick="copyReport()"> 注转拽 拽住</button>
      <button class="modal-close-btn" onclick="closeReport()">住专</button>
    </div>
  </div>
</div>

<script>
// ===== STATE =====
const defaultSettings = {
  me: { name: '注', cal: 2000, protein: 100, carbs: 160, sugar: 25 },
  wife: { name: '', cal: 1400, protein: 90, carbs: 120, sugar: 40 }
};

let settings = JSON.parse(localStorage.getItem('nutritionSettings')) || JSON.parse(JSON.stringify(defaultSettings));
const WORKER_URL = 'https://nutrition-proxy.theamazingduckboaz.workers.dev';

// Force update Boaz's targets to the correct dietitian-approved values
if (!settings.me) settings.me = {};
settings.me.name = '注';
settings.me.cal = 2000;
settings.me.protein = 100;
settings.me.carbs = 160;
settings.me.sugar = 25;
localStorage.setItem('nutritionSettings', JSON.stringify(settings));
let currentProfile = localStorage.getItem('currentProfile') || 'me';
let meals = JSON.parse(localStorage.getItem(`meals-${currentProfile}`)) || [];
let pendingResult = null;
let selectedImageBase64 = null;
let currentTab = 'text';
let chatHistory = [];
let waterCups = parseInt(localStorage.getItem(`water-${currentProfile}`) || '0');
let coffeeCups = parseInt(localStorage.getItem(`coffee-${currentProfile}`) || '0');
let workouts = JSON.parse(localStorage.getItem(`workouts-${currentProfile}`) || '[]');

const WORKOUT_TYPES = {
  walk:        { name: '',        icon: '', met: 3.5 },
  run:         { name: '专爪',         icon: '', met: 9.0 },
  bike:        { name: '驻',      icon: '', met: 7.5 },
  swim:        { name: '砖',        icon: '', met: 8.0 },
  gym:         { name: '专 砖专',     icon: '锔', met: 6.0 },
  basketball:  { name: '专住',       icon: '', met: 8.0 },
  hiit:        { name: 'HIIT',         icon: '', met: 10.0 },
  yoga:        { name: ' / 转转', icon: '', met: 2.5 },
  other:       { name: '专',          icon: '', met: 5.0 },
};
const USER_WEIGHT_KG = 81;
const MAX_COFFEE = 5;
const COFFEE_MEAL = { name: '住驻专住 注  3%', portions: '住驻专住 + 240 " ', calories: 156, protein: 8, carbs: 12, fat: 7, sugar: 0, notes: '拽驻  拽注' };

// ===== HISTORY =====
let dayHistory = JSON.parse(localStorage.getItem('dayHistory') || '[]');
let reportProfile = 'me';

function saveDay() {
  if (meals.length === 0) { showToast('锔  专转 砖专 '); return; }
  const s = settings[currentProfile] || defaultSettings[currentProfile];
  const totals = getTotals();
  const today = new Date();
  const dateStr = today.toLocaleDateString('he-IL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  // Use local date (Israel time) not UTC
  const dateKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

  const waterMl = waterCups * 160;
  const dayData = {
    id: Date.now(),
    date: dateStr,
    dateKey,
    profile: currentProfile,
    profileName: s.name,
    meals: JSON.parse(JSON.stringify(meals)),
    totals,
    targets: { cal: s.cal, protein: s.protein, carbs: s.carbs, sugar: s.sugar },
    waterCups,
    waterMl,
    coffeeCups,
    workouts: JSON.parse(JSON.stringify(workouts)),
    totalBurned: workouts.reduce((s,w) => s + w.burned, 0),
    totalWorkoutMins: workouts.reduce((s,w) => s + w.duration, 0),
  };

  // Remove existing entry for same day+profile if exists
  dayHistory = dayHistory.filter(d => !(d.dateKey === dateKey && d.profile === currentProfile));
  dayHistory.unshift(dayData);
  localStorage.setItem('dayHistory', JSON.stringify(dayHistory));
  renderHistory();
  showToast('  砖专 住专!');
}

function renderHistory() {
  const list = document.getElementById('historyList');
  const filtered = dayHistory.filter(d => d.profile === currentProfile);
  if (filtered.length === 0) {
    list.innerHTML = '<div class="empty-log" style="padding:24px;"><div class="empty-icon"></div><div>注  砖专转 </div><div style="margin-top:4px;font-size:12px">抓 "砖专 " 住祝 </div></div>';
    return;
  }
  list.innerHTML = filtered.map((day, i) => {
    const hitProtein = day.totals.protein >= day.targets.protein;
    const overCal = day.totals.cal > day.targets.cal;
    return `<div class="history-day">
      <div class="history-day-header">
        <span class="history-day-date">${day.date}</span>
        <div style="display:flex;gap:6px;align-items:center;">
          ${hitProtein ? '<span style="font-size:11px;background:rgba(0,212,170,0.2);color:#00d4aa;padding:2px 8px;border-radius:10px;">  OK</span>' : '<span style="font-size:11px;background:rgba(255,107,107,0.15);color:#ff9999;padding:2px 8px;border-radius:10px;">锔 住专 </span>'}
          ${overCal ? '<span style="font-size:11px;background:rgba(255,107,107,0.15);color:#ff9999;padding:2px 8px;border-radius:10px;">锔 专 拽专转</span>' : ''}
        </div>
      </div>
      <div class="history-day-macros">
        <span> <b>${fmt(day.totals.cal)}</b> 拽拽"</span>
        <span>ォ : <b>${fmt(day.totals.protein)} 专</b></span>
        <span> 驻转: <b>${fmt(day.totals.carbs)} 专</b></span>
        <span> 住专: <b>${fmt(day.totals.sugar)} 专</b></span>
        <span> 砖: <b>${fmt(day.totals.fat)} 专</b></span>
        <span> : <b>${day.waterMl ? (day.waterMl/1000).toFixed(2) + ' 专' : ' 专砖'}</b></span>
        <span> 拽驻: <b>${day.coffeeCups !== undefined ? day.coffeeCups + ' 住转' : ' 专砖'}</b></span>
        ${day.totalBurned ? `<span> 砖专驻转: <b>${day.totalBurned} 拽拽"</b> (${day.totalWorkoutMins} 拽转)</span>` : ''}
      </div>
      <div class="history-meal-list">
        ${day.meals.map(m => `<div class="history-meal-item"><span>${m.name}</span><span>${fmt(m.calories)} 拽拽" 路 ${fmt(m.protein)} 专 </span></div>`).join('')}
      </div>
      <div class="history-day-actions">
        <button class="edit-day-btn" onclick="openEditDay(${day.id})">锔 注专 </button>
        <button class="delete-day-btn" onclick="deleteDay(${day.id})">锔 拽 </button>
      </div>
    </div>`;
  }).join('');
}

let editingDayId = null;
let editingMeals = [];

function openEditDay(id) {
  const day = dayHistory.find(d => d.id === id);
  if (!day) return;
  editingDayId = id;
  editingMeals = JSON.parse(JSON.stringify(day.meals));

  // Set date input
  document.getElementById('editDateInput').value = day.dateKey;

  // Render meals list
  renderEditMeals();

  document.getElementById('editDayModal').classList.add('open');
}

function renderEditMeals() {
  const list = document.getElementById('editMealsList');
  if (editingMeals.length === 0) {
    list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-dim);font-size:13px;"> 专转  </div>';
    return;
  }
  list.innerHTML = editingMeals.map((m, i) => `
    <div class="edit-meal-row">
      <div class="edit-meal-name">${m.name}</div>
      <div class="edit-meal-cal">${fmt(m.calories)} 拽拽" 路 ${fmt(m.protein)} 专 </div>
      <button class="edit-meal-delete" onclick="removeEditMeal(${i})" title="住专 专"></button>
    </div>
  `).join('');
}

function removeEditMeal(index) {
  editingMeals.splice(index, 1);
  renderEditMeals();
}

function saveEditDay() {
  const dateKey = document.getElementById('editDateInput').value;
  if (!dateKey) { showToast('锔  专 转专'); return; }

  const idx = dayHistory.findIndex(d => d.id === editingDayId);
  if (idx === -1) return;

  // Recalculate totals from remaining meals
  const totals = editingMeals.reduce((acc, m) => ({
    cal: acc.cal + (m.calories || 0),
    protein: acc.protein + (m.protein || 0),
    carbs: acc.carbs + (m.carbs || 0),
    fat: acc.fat + (m.fat || 0),
    sugar: acc.sugar + (m.sugar || 0),
  }), { cal: 0, protein: 0, carbs: 0, fat: 0, sugar: 0 });

  // Build new date string
  const d = new Date(dateKey + 'T12:00:00');
  const dateStr = d.toLocaleDateString('he-IL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

  dayHistory[idx] = {
    ...dayHistory[idx],
    dateKey,
    date: dateStr,
    meals: editingMeals,
    totals,
  };

  localStorage.setItem('dayHistory', JSON.stringify(dayHistory));
  renderHistory();
  closeEditDay();
  showToast('  注!');
}

function closeEditDay() {
  document.getElementById('editDayModal').classList.remove('open');
  editingDayId = null;
  editingMeals = [];
}

function closeEditOnBg(e) {
  if (e.target === document.getElementById('editDayModal')) closeEditDay();
}

function deleteDay(id) {
  showConfirm('拽 转   住专?', () => {
    dayHistory = dayHistory.filter(d => d.id !== id);
    localStorage.setItem('dayHistory', JSON.stringify(dayHistory));
    renderHistory();
    showToast('锔  拽');
  });
}

// ===== REPORT =====
function openReport() {
  document.getElementById('reportModal').classList.add('open');
  renderReport();
}

function closeReport() {
  document.getElementById('reportModal').classList.remove('open');
}

function closeReportOnBg(e) {
  if (e.target === document.getElementById('reportModal')) closeReport();
}

function switchReportProfile(profile) {
  reportProfile = profile;
  document.querySelectorAll('.modal-tab').forEach((t, i) => t.classList.toggle('active', (i === 0 && profile === 'me') || (i === 1 && profile === 'wife')));
  renderReport();
}

function groupByWeek(days) {
  const weeks = {};
  days.forEach(day => {
    const d = new Date(day.dateKey + 'T12:00:00');
    // Get Monday of this week
    const dow = d.getDay(); // 0=sun
    const diff = (dow === 0 ? -6 : 1 - dow);
    const mon = new Date(d);
    mon.setDate(d.getDate() + diff);
    const weekKey = mon.toISOString().split('T')[0];
    if (!weeks[weekKey]) weeks[weekKey] = [];
    weeks[weekKey].push(day);
  });
  return weeks;
}

function renderReport() {
  const s = settings[reportProfile] || defaultSettings[reportProfile];
  const filtered = dayHistory.filter(d => d.profile === reportProfile);
  const el = document.getElementById('reportContent');

  if (filtered.length === 0) {
    el.innerHTML = `<div class="report-empty"><div style="font-size:40px;margin-bottom:12px;"></div><div> 转 ${s.name} 注</div><div style="font-size:13px;margin-top:8px;color:var(--text-dim)">砖专  爪注转 "砖专 "  专转 </div></div>`;
    return;
  }

  const n = filtered.length;
  const avg = filtered.reduce((acc, d) => ({
    cal: acc.cal + d.totals.cal,
    protein: acc.protein + d.totals.protein,
    carbs: acc.carbs + d.totals.carbs,
    fat: acc.fat + d.totals.fat,
    sugar: acc.sugar + d.totals.sugar,
  }), { cal: 0, protein: 0, carbs: 0, fat: 0, sugar: 0 });
  const firstDate = filtered[filtered.length - 1].date;
  const lastDate = filtered[0].date;

  // Weekly groups
  const weeks = groupByWeek(filtered);
  const weeklyHTML = Object.entries(weeks).sort((a,b) => b[0].localeCompare(a[0])).map(([weekKey, days]) => {
    const weekStart = new Date(weekKey + 'T12:00:00');
    const weekEnd = new Date(weekKey + 'T12:00:00');
    weekEnd.setDate(weekEnd.getDate() + 6);
    const weekLabel = `${weekStart.toLocaleDateString('he-IL', {day:'numeric',month:'long'})}  ${weekEnd.toLocaleDateString('he-IL', {day:'numeric',month:'long'})}`;

    const weekTotals = days.reduce((a, d) => ({
      eaten: a.eaten + d.totals.cal,
      burned: a.burned + (d.totalBurned || 0),
      protein: a.protein + d.totals.protein,
      target: a.target + s.cal,
    }), { eaten: 0, burned: 0, protein: 0, target: 0 });

    const net = weekTotals.eaten - weekTotals.burned;
    const diff = net - weekTotals.target;
    const diffLabel = diff > 0
      ? `<span style="color:var(--accent2);">+${Math.round(diff)} 拽拽" 注 注</span>`
      : `<span style="color:var(--accent);">${Math.round(Math.abs(diff))} 拽拽" 转转 注 </span>`;

    return `<div class="weekly-block">
      <div class="weekly-header">
        <span class="weekly-label"> 砖注 ${weekLabel}</span>
        <span class="weekly-days">${days.length} </span>
      </div>
      <div class="weekly-row">
        <div class="weekly-stat"><span class="ws-val">${Math.round(weekTotals.eaten)}</span><span class="ws-lbl">斤 </span></div>
        <div class="weekly-stat"><span class="ws-val" style="color:#f97316;">${Math.round(weekTotals.burned)}</span><span class="ws-lbl"> 砖专祝</span></div>
        <div class="weekly-stat"><span class="ws-val" style="color:#60a5fa;">${Math.round(net)}</span><span class="ws-lbl">锔 </span></div>
        <div class="weekly-stat"><span class="ws-val">${Math.round(weekTotals.target)}</span><span class="ws-lbl"> 注</span></div>
      </div>
      <div class="weekly-diff">${diffLabel}</div>
    </div>`;
  }).join('');

  // Days detail
  const daysHTML = filtered.map(day => {
    const hasBurned = day.totalBurned > 0;
    const net = day.totals.cal - (day.totalBurned || 0);
    const diff = net - s.cal;
    const diffStr = diff > 0 ? `<span style="color:var(--accent2);font-size:11px;">+${Math.round(diff)} 注 注</span>` : `<span style="color:var(--accent);font-size:11px;">${Math.round(Math.abs(diff))} 转转 </span>`;

    return `<div class="report-day-block">
      <div class="report-day-title">${day.date}</div>
      <div class="report-cal-rows">
        <div class="report-cal-row eaten">
          <span class="rcr-icon">斤</span>
          <span class="rcr-label">转</span>
          <span class="rcr-val">${fmt(day.totals.cal)} 拽拽"</span>
        </div>
        ${hasBurned ? `<div class="report-cal-row burned">
          <span class="rcr-icon"></span>
          <span class="rcr-label">砖专驻转 </span>
          <span class="rcr-val" style="color:#f97316;">${fmt(day.totalBurned)} 拽拽"</span>
        </div>
        <div class="report-cal-row net">
          <span class="rcr-icon">锔</span>
          <span class="rcr-label"></span>
          <span class="rcr-val">${fmt(net)} 拽拽" &nbsp; ${diffStr}</span>
        </div>` : ''}
      </div>
      <div class="report-day-totals" style="margin-top:8px;">ォ ${fmt(day.totals.protein)} 专  &nbsp;|&nbsp;  ${fmt(day.totals.carbs)} 专 驻转 &nbsp;|&nbsp;  ${fmt(day.totals.sugar)} 专 住专 &nbsp;|&nbsp;  ${day.waterMl ? (day.waterMl/1000).toFixed(2) + ' ' : ''} &nbsp;|&nbsp;  ${day.coffeeCups !== undefined ? day.coffeeCups + ' 住转' : ''}</div>
      ${day.meals.map(m => `<div class="report-meal-row"><span>${m.name}</span><span>${fmt(m.calories)} 拽拽" 路  ${fmt(m.protein)} 专 路 驻' ${fmt(m.carbs)} 专 路 住专 ${fmt(m.sugar)} 专</span></div>`).join('')}
      ${hasBurned && day.workouts ? `<div style="margin-top:8px;padding-top:6px;border-top:1px solid var(--border);">${day.workouts.map(w => `<div class="report-meal-row" style="color:#f97316;"><span>${w.icon} ${w.name} 路 ${w.duration} 拽转 路 ${w.intensity}</span><span>${w.burned} 拽拽"</span></div>`).join('')}</div>` : ''}
    </div>`;
  }).join('');

  el.innerHTML = `
    <div class="report-profile-title">${s.name}</div>
    <div class="report-period"> ${firstDate}  ${lastDate} 路 ${n}  砖砖专</div>
    <div style="font-size:13px;font-weight:700;margin-bottom:10px;color:var(--text-dim);">爪注 </div>
    <div class="report-avg-grid">
      <div class="report-avg-card cal"><span class="report-avg-val">${Math.round(avg.cal/n)}</span><span class="report-avg-lbl">拽拽" </span></div>
      <div class="report-avg-card prot"><span class="report-avg-val">${Math.round(avg.protein/n)}</span><span class="report-avg-lbl"> (专)</span></div>
      <div class="report-avg-card carb"><span class="report-avg-val">${Math.round(avg.carbs/n)}</span><span class="report-avg-lbl">驻转 (专)</span></div>
      <div class="report-avg-card fat"><span class="report-avg-val">${Math.round(avg.fat/n)}</span><span class="report-avg-lbl">砖 (专)</span></div>
      <div class="report-avg-card sug"><span class="report-avg-val">${Math.round(avg.sugar/n)}</span><span class="report-avg-lbl">住专 (专)</span></div>
    </div>
    <div style="font-size:13px;font-weight:700;margin-bottom:10px;color:var(--text-dim);">住 砖注</div>
    ${weeklyHTML}
    <div style="font-size:13px;font-weight:700;margin:16px 0 10px;color:var(--text-dim);">驻专 驻 </div>
    ${daysHTML}
  `;
}

function printReport() {
  window.print();
}

function copyReport() {
  const s = settings[reportProfile] || defaultSettings[reportProfile];
  const filtered = dayHistory.filter(d => d.profile === reportProfile);
  if (filtered.length === 0) { showToast(' 转 注转拽'); return; }

  const n = filtered.length;
  const avg = filtered.reduce((acc, d) => ({
    cal: acc.cal + d.totals.cal, protein: acc.protein + d.totals.protein,
    carbs: acc.carbs + d.totals.carbs, fat: acc.fat + d.totals.fat, sugar: acc.sugar + d.totals.sugar,
  }), { cal: 0, protein: 0, carbs: 0, fat: 0, sugar: 0 });

  let text = ` 转  ${s.name}\n`;
  text += `住" ${n} \n\n`;
  text += `爪注 :\n`;
  text += `拽专转: ${fmt(Math.round(avg.cal/n))} 拽拽"\n`;
  text += `: ${fmt(Math.round(avg.protein/n))} 专\n`;
  text += `驻转: ${fmt(Math.round(avg.carbs/n))} 专\n`;
  text += `住专: ${fmt(Math.round(avg.sugar/n))} 专\n`;
  text += `砖: ${fmt(Math.round(avg.fat/n))} 专\n\n`;
  text += `驻专 :\n`;
  filtered.forEach(day => {
    text += `\n${day.date}\n`;
    text += `住": ${fmt(day.totals.cal)} 拽拽" |  ${fmt(day.totals.protein)} 专 | 驻转 ${fmt(day.totals.carbs)} 专 | 住专 ${fmt(day.totals.sugar)} 专 |  ${day.waterMl ? (day.waterMl/1000).toFixed(2) + ' 专' : ' 专砖'} | 拽驻 ${day.coffeeCups !== undefined ? day.coffeeCups + ' 住转' : ' 专砖'}\n`;
    day.meals.forEach(m => { text += `   ${m.name}: ${fmt(m.calories)} 拽拽", ${fmt(m.protein)} 专 \n`; });
    if (day.workouts && day.workouts.length > 0) {
      text += `:\n`;
      day.workouts.forEach(w => {
        text += `   ${w.name} ${w.duration} 拽转 (${w.intensity})  砖专驻转 ${w.burned} 拽拽"\n`;
        if (w.exercises && w.exercises.length > 0) {
          w.exercises.forEach(ex => {
            text += `     ${ex.name}`;
            if (ex.muscles && ex.muscles.length > 0) text += ` [${ex.muscles.join(', ')}]`;
            if (ex.sets && ex.sets.length > 0) text += `: ${ex.sets.map((s,i) => `住 ${i+1}: ${s.reps} '${s.weight ? '  ' + s.weight + '拽"' : ''}`).join(' | ')}`;
            text += `\n`;
          });
        }
      });
    }
  });

  navigator.clipboard.writeText(text).then(() => showToast('  注转拽!')).catch(() => showToast('  爪转 注转拽'));
}

// ===== WORKOUT =====
let selectedWorkoutType = null;
let selectedIntensity = 0.8;
let selectedDuration = null;



function closeAddWorkout() {
  document.getElementById('workoutModal').classList.remove('open');
}

function closeWorkoutOnBg(e) {
  if (e.target === document.getElementById('workoutModal')) closeAddWorkout();
}

function selectWorkoutType(key) {
  selectedWorkoutType = key;
  document.querySelectorAll('.workout-type-btn').forEach(b => b.classList.toggle('selected', b.dataset.key === key));
  calcBurn();
  showSetsSection(key);
}

function setDuration(mins) {
  selectedDuration = mins;
  document.getElementById('durationInput').value = mins;
  document.querySelectorAll('.dur-btn').forEach(b => b.classList.toggle('active', parseInt(b.textContent) === mins));
  calcBurn();
}

function setIntensity(btn, val) {
  selectedIntensity = val;
  document.querySelectorAll('.intensity-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  calcBurn();
}

function calcBurn() {
  const dur = parseInt(document.getElementById('durationInput').value) || selectedDuration;
  if (!selectedWorkoutType || !dur) { document.getElementById('burnPreview').style.display = 'none'; return; }
  const met = WORKOUT_TYPES[selectedWorkoutType].met * selectedIntensity;
  const burned = Math.round((met * USER_WEIGHT_KG * dur) / 60);
  document.getElementById('burnVal').textContent = burned;
  document.getElementById('burnPreview').style.display = 'block';
}

function saveWorkout() {
  if (!selectedWorkoutType) { showToast('锔 专 住 '); return; }
  const dur = parseInt(document.getElementById('durationInput').value);
  if (!dur || dur < 1) { showToast('锔 住 砖 '); return; }
  const wt = WORKOUT_TYPES[selectedWorkoutType];
  const met = wt.met * selectedIntensity;
  const burned = Math.round((met * USER_WEIGHT_KG * dur) / 60);
  const note = document.getElementById('workoutNote').value.trim();
  const intensityLabel = selectedIntensity === 0.8 ? '拽' : selectedIntensity === 1.0 ? '转' : '';

  const exercises = collectExercises();
  const workout = {
    id: Date.now(),
    type: selectedWorkoutType,
    name: wt.name,
    icon: wt.icon,
    duration: dur,
    intensity: intensityLabel,
    burned,
    note,
    exercises,
    time: new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' })
  };

  if (editingWorkoutId !== null) {
    // Edit mode  replace existing
    const idx = workouts.findIndex(x => x.id === editingWorkoutId);
    if (idx !== -1) workouts[idx] = { ...workout, id: editingWorkoutId };
    showToast(`  注!`);
  } else {
    // Add mode
    workouts.push(workout);
    showToast(` ${wt.icon} ${wt.name} ${dur} 拽转  砖专驻转 ${burned} 拽拽"!`);
  }
  localStorage.setItem(`workouts-${currentProfile}`, JSON.stringify(workouts));
  renderWorkouts();
  updateDailySummary();
  closeAddWorkout();
}

function deleteWorkout(id) {
  workouts = workouts.filter(w => w.id !== id);
  localStorage.setItem(`workouts-${currentProfile}`, JSON.stringify(workouts));
  renderWorkouts();
  updateDailySummary();
}

function renderWorkouts() {
  const list = document.getElementById('workoutList');
  const empty = document.getElementById('workoutEmpty');
  const totalsEl = document.getElementById('workoutTotals');

  if (workouts.length === 0) {
    list.innerHTML = '<div class="workout-empty" id="workoutEmpty"><span style="font-size:32px"></span><div style="margin-top:8px;font-size:13px;color:var(--text-dim)"> 转注转  </div></div>';
    totalsEl.style.display = 'none';
    return;
  }

  const totalBurned = workouts.reduce((s, w) => s + w.burned, 0);
  const totalMins = workouts.reduce((s, w) => s + w.duration, 0);

  list.innerHTML = workouts.map(w => `
    <div class="workout-item" style="flex-direction:column;align-items:stretch;">
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="workout-item-icon">${w.icon}</div>
        <div class="workout-item-info">
          <div class="workout-item-name">${w.name}${w.note ? ' 路 ' + w.note : ''}</div>
          <div class="workout-item-details">憋 ${w.duration} 拽转 路 注爪转 ${w.intensity} 路 ${w.time}</div>
        </div>
        <div class="workout-item-burn"> ${w.burned}</div>
        <button class="workout-item-edit" onclick="openEditWorkout(${w.id})">锔</button>
        <button class="workout-item-delete" onclick="deleteWorkout(${w.id})">锔</button>
      </div>
      ${w.exercises && w.exercises.length > 0 ? `
        <div class="workout-exercises-detail">
          ${w.exercises.map(ex => `
            <div class="exercise-detail-item">
               <b>${ex.name}</b>
              ${ex.muscles && ex.muscles.length > 0 ? `<span style="color:var(--accent);font-size:11px;"> 路 ${ex.muscles.join(', ')}</span>` : ''}
              ${ex.sets && ex.sets.length > 0 ? `<span> 路 ${ex.sets.map((s,i) => `住 ${i+1}: ${s.reps} 专转${s.weight ? '  ' + s.weight + ' 拽"' : ''}`).join(' | ')}</span>` : ''}
            </div>
          `).join('')}
        </div>
      ` : ''}
    </div>
  `).join('');

  document.getElementById('totalBurned').textContent = totalBurned;
  document.getElementById('totalMins').textContent = totalMins;
  totalsEl.style.display = 'flex';
}

function resetWorkouts() {
  workouts = [];
  localStorage.setItem(`workouts-${currentProfile}`, JSON.stringify(workouts));
  renderWorkouts();
}

// ===== EXERCISES =====
const MUSCLE_GROUPS = ['', '', '转驻', ' - 住驻住', ' - 专住驻住', '', '专 - 拽', '专 - 专', '砖', ' 祝'];
let exerciseIdCounter = 0;

function showSetsSection(workoutType) {
  const setsSection = document.getElementById('setsSection');
  // Show for gym/strength types, hide for cardio
  const strengthTypes = ['gym', 'other'];
  setsSection.style.display = strengthTypes.includes(workoutType) ? 'block' : 'none';
}

function addExerciseRow() {
  const id = ++exerciseIdCounter;
  const container = document.getElementById('exerciseRows');
  const div = document.createElement('div');
  div.className = 'exercise-row';
  div.id = `exercise-${id}`;
  div.innerHTML = `
    <div class="exercise-top">
      <input type="text" class="exercise-name-input" placeholder="砖 转专 (': 爪转 , 住拽...)" id="exName-${id}">
    </div>
    <div>
      <div style="font-size:11px;color:var(--text-dim);margin-bottom:6px;">砖专专 注专:</div>
      <div class="muscle-chips" id="muscles-${id}">
        ${MUSCLE_GROUPS.map(m => `<span class="muscle-chip" onclick="toggleMuscle(this)">${m}</span>`).join('')}
      </div>
    </div>
    <div class="exercise-sets" id="sets-${id}"></div>
    <div class="exercise-actions">
      <button class="add-set-btn" onclick="addSetRow(${id})">锛 住祝 住</button>
      <button class="remove-exercise-btn" onclick="document.getElementById('exercise-${id}').remove()">锔 住专 转专</button>
    </div>
  `;
  container.appendChild(div);
  addSetRow(id); // start with one set
}

function addSetRow(exerciseId) {
  const setsContainer = document.getElementById(`sets-${exerciseId}`);
  const setNum = setsContainer.children.length + 1;
  const setId = `set-${exerciseId}-${setNum}-${Date.now()}`;
  const div = document.createElement('div');
  div.className = 'set-row';
  div.id = setId;
  div.innerHTML = `
    <div class="set-num">${setNum}</div>
    <input type="number" class="set-input" placeholder="专转" min="1" max="200" id="reps-${setId}">
    <span class="set-label">专转</span>
    <span class="set-label" style="margin-right:4px;"></span>
    <input type="number" class="set-input" placeholder='拽"' min="0" max="999" step="0.5" id="weight-${setId}">
    <span class="set-label">拽"</span>
    <button class="set-delete" onclick="document.getElementById('${setId}').remove()"></button>
  `;
  setsContainer.appendChild(div);
}

function toggleMuscle(chip) {
  chip.classList.toggle('selected');
}

function collectExercises() {
  const exercises = [];
  document.querySelectorAll('.exercise-row').forEach(row => {
    const id = row.id.replace('exercise-', '');
    const nameEl = document.getElementById(`exName-${id}`);
    if (!nameEl) return;
    const name = nameEl.value.trim();
    
    // Collect selected muscles
    const muscles = [];
    row.querySelectorAll('.muscle-chip.selected').forEach(c => muscles.push(c.textContent));
    
    // Collect sets
    const sets = [];
    row.querySelectorAll('.set-row').forEach(setRow => {
      const repsEl = setRow.querySelector('[id^="reps-"]');
      const weightEl = setRow.querySelector('[id^="weight-"]');
      const reps = repsEl ? parseInt(repsEl.value) : null;
      const weight = weightEl ? parseFloat(weightEl.value) : null;
      if (reps) sets.push({ reps, weight: weight || 0 });
    });
    
    if (name || sets.length > 0) {
      exercises.push({ name: name || '转专', muscles, sets });
    }
  });
  return exercises;
}

// ===== EDIT WORKOUT =====
let editingWorkoutId = null;
let weightLog = JSON.parse(localStorage.getItem(`weightLog-${currentProfile}`) || '[]');

function openEditWorkout(id) {
  const w = workouts.find(x => x.id === id);
  if (!w) return;
  editingWorkoutId = id;

  // Update modal title
  document.getElementById('workoutModalTitle').textContent = '锔 注专 ';
  document.getElementById('workoutSaveBtn').textContent = ' 注 ';

  // Reset first
  document.querySelectorAll('.workout-type-btn').forEach(b => b.classList.remove('selected'));
  document.querySelectorAll('.intensity-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.dur-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('exerciseRows').innerHTML = '';
  exerciseIdCounter = 0;

  // Set type
  selectedWorkoutType = w.type;
  document.querySelectorAll('.workout-type-btn').forEach(b => {
    if (b.dataset.key === w.type) b.classList.add('selected');
  });

  // Set duration
  selectedDuration = w.duration;
  document.getElementById('durationInput').value = w.duration;
  document.querySelectorAll('.dur-btn').forEach(b => {
    if (parseInt(b.textContent) === w.duration) b.classList.add('active');
  });

  // Set intensity
  const intensityMap = { '拽': 0.8, '转': 1.0, '': 1.25 };
  selectedIntensity = intensityMap[w.intensity] || 1.0;
  document.querySelectorAll('.intensity-btn').forEach(b => {
    const val = parseFloat(b.dataset.val);
    b.classList.toggle('active', val === selectedIntensity);
  });

  // Set note
  document.getElementById('workoutNote').value = w.note || '';

  // Show/hide sets section
  showSetsSection(w.type);

  // Restore exercises
  if (w.exercises && w.exercises.length > 0) {
    w.exercises.forEach(ex => {
      const id = ++exerciseIdCounter;
      const container = document.getElementById('exerciseRows');
      const div = document.createElement('div');
      div.className = 'exercise-row';
      div.id = `exercise-${id}`;
      div.innerHTML = `
        <div class="exercise-top">
          <input type="text" class="exercise-name-input" placeholder="砖 转专..." id="exName-${id}" value="${ex.name || ''}">
        </div>
        <div>
          <div style="font-size:11px;color:var(--text-dim);margin-bottom:6px;">砖专专 注专:</div>
          <div class="muscle-chips" id="muscles-${id}">
            ${MUSCLE_GROUPS.map(m => `<span class="muscle-chip${ex.muscles && ex.muscles.includes(m) ? ' selected' : ''}" onclick="toggleMuscle(this)">${m}</span>`).join('')}
          </div>
        </div>
        <div class="exercise-sets" id="sets-${id}"></div>
        <div class="exercise-actions">
          <button class="add-set-btn" onclick="addSetRow(${id})">锛 住祝 住</button>
          <button class="remove-exercise-btn" onclick="document.getElementById('exercise-${id}').remove()">锔 住专 转专</button>
        </div>
      `;
      container.appendChild(div);

      // Restore sets
      if (ex.sets && ex.sets.length > 0) {
        ex.sets.forEach(s => {
          const setsContainer = document.getElementById(`sets-${id}`);
          const setNum = setsContainer.children.length + 1;
          const setId = `set-${id}-${setNum}-${Date.now()}`;
          const setDiv = document.createElement('div');
          setDiv.className = 'set-row';
          setDiv.id = setId;
          setDiv.innerHTML = `
            <div class="set-num">${setNum}</div>
            <input type="number" class="set-input" placeholder="专转" min="1" max="200" id="reps-${setId}" value="${s.reps || ''}">
            <span class="set-label">专转</span>
            <span class="set-label" style="margin-right:4px;"></span>
            <input type="number" class="set-input" placeholder='拽"' min="0" max="999" step="0.5" id="weight-${setId}" value="${s.weight || ''}">
            <span class="set-label">拽"</span>
            <button class="set-delete" onclick="document.getElementById('${setId}').remove()"></button>
          `;
          setsContainer.appendChild(setDiv);
        });
      } else {
        addSetRow(id);
      }
    });
  }

  calcBurn();
  document.getElementById('workoutModal').classList.add('open');
}

// ===== WEIGHT TRACKER =====
function openWeightEntry() {
  const today = new Date();
  const dateKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
  document.getElementById('weightDate').value = dateKey;
  // Pre-fill with last known weight
  if (weightLog.length > 0) {
    document.getElementById('weightInput').value = weightLog[0].weight;
  } else {
    document.getElementById('weightInput').value = '';
  }
  document.getElementById('weightNote').value = '';
  document.getElementById('weightModal').classList.add('open');
}

function closeWeightModal() {
  document.getElementById('weightModal').classList.remove('open');
}

function closeWeightOnBg(e) {
  if (e.target === document.getElementById('weightModal')) closeWeightModal();
}

function adjustWeight(delta) {
  const input = document.getElementById('weightInput');
  const val = parseFloat(input.value) || 80;
  input.value = Math.round((val + delta) * 10) / 10;
}

function saveWeight() {
  const weight = parseFloat(document.getElementById('weightInput').value);
  if (!weight || weight < 20 || weight > 300) { showToast('锔 住 砖拽 转拽'); return; }
  const dateKey = document.getElementById('weightDate').value;
  if (!dateKey) { showToast('锔 专 转专'); return; }
  const note = document.getElementById('weightNote').value.trim();
  const d = new Date(dateKey + 'T12:00:00');
  const dateStr = d.toLocaleDateString('he-IL', { weekday: 'short', day: 'numeric', month: 'long' });

  // Remove existing entry for same date
  weightLog = weightLog.filter(w => w.dateKey !== dateKey);
  weightLog.unshift({ weight, dateKey, dateStr, note });
  // Sort by date desc
  weightLog.sort((a, b) => b.dateKey.localeCompare(a.dateKey));
  // Keep last 60 entries
  if (weightLog.length > 60) weightLog = weightLog.slice(0, 60);

  localStorage.setItem(`weightLog-${currentProfile}`, JSON.stringify(weightLog));
  renderWeight();
  closeWeightModal();
  showToast(`锔 砖拽 注: ${weight} 拽"`);
}

function deleteWeightEntry(dateKey) {
  weightLog = weightLog.filter(w => w.dateKey !== dateKey);
  localStorage.setItem(`weightLog-${currentProfile}`, JSON.stringify(weightLog));
  renderWeight();
}

function renderWeight() {
  const display = document.getElementById('weightDisplay');
  if (weightLog.length === 0) {
    display.innerHTML = '<div class="weight-empty"><span style="font-size:28px">锔</span><div style="font-size:13px;color:var(--text-dim);margin-top:6px;">注  转 砖拽</div></div>';
    return;
  }

  const latest = weightLog[0];
  const prev = weightLog[1];
  let changeHTML = '';
  if (prev) {
    const diff = Math.round((latest.weight - prev.weight) * 10) / 10;
    if (diff < 0) changeHTML = `<span class="weight-change down"> ${Math.abs(diff)} 拽"</span>`;
    else if (diff > 0) changeHTML = `<span class="weight-change up"> ${diff} 拽"</span>`;
    else changeHTML = `<span class="weight-change same">=  砖</span>`;
  }

  // Mini bar chart (last 7 entries)
  const chartData = [...weightLog].reverse().slice(-7);
  let chartHTML = '';
  if (chartData.length >= 2) {
    const minW = Math.min(...chartData.map(w => w.weight));
    const maxW = Math.max(...chartData.map(w => w.weight));
    const range = maxW - minW || 1;
    chartHTML = `<div class="weight-chart">` +
      chartData.map(w => {
        const h = Math.max(8, Math.round(((w.weight - minW) / range) * 48 + 4));
        return `<div class="weight-bar-col">
          <div class="weight-bar-inner" style="height:${h}px;" title="${w.weight} 拽"></div>
          <div class="weight-bar-label">${w.weight}</div>
        </div>`;
      }).join('') + `</div>`;
  }

  // Total change
  const oldest = weightLog[weightLog.length - 1];
  const totalChange = Math.round((latest.weight - oldest.weight) * 10) / 10;
  const totalStr = totalChange < 0
    ? `<span style="color:var(--accent);">专 转: ${Math.abs(totalChange)} 拽" </span>`
    : totalChange > 0
    ? `<span style="color:var(--accent2);">注 转: ${totalChange} 拽"</span>`
    : `<span style="color:var(--text-dim);"> 砖 </span>`;

  // Log rows (last 10)
  const logRows = weightLog.slice(0, 10).map((w, i) => {
    const next = weightLog[i+1];
    let chg = '';
    if (next) {
      const d = Math.round((w.weight - next.weight) * 10) / 10;
      chg = d < 0 ? `<span class="weight-log-change" style="color:var(--accent);">${Math.abs(d)}</span>`
           : d > 0 ? `<span class="weight-log-change" style="color:var(--accent2);">${d}</span>` : '';
    }
    return `<div class="weight-log-item">
      <div>
        <div class="weight-log-date">${w.dateStr}${w.note ? ' 路 ' + w.note : ''}</div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        ${chg}
        <span class="weight-log-val">${w.weight} 拽"</span>
        <button class="weight-log-del" onclick="deleteWeightEntry('${w.dateKey}')">锔</button>
      </div>
    </div>`;
  }).join('');

  display.innerHTML = `
    <div class="weight-current">
      <div>
        <div style="font-size:11px;color:var(--text-dim);margin-bottom:2px;">砖拽 </div>
        <span class="weight-current-val">${latest.weight}</span>
        <span class="weight-current-unit">拽"</span>
      </div>
      ${changeHTML}
      <div style="margin-right:auto;font-size:12px;">${totalStr}</div>
    </div>
    ${chartHTML}
    <div class="weight-log">${logRows}</div>
  `;
}

// ===== COPY PAST WORKOUTS =====
function openAddWorkout(showCopy = false) {
  // Check for past workouts from history
  const allPastWorkouts = [];
  dayHistory.filter(d => d.profile === currentProfile && d.workouts && d.workouts.length > 0)
    .forEach(day => day.workouts.forEach(w => {
      if (!allPastWorkouts.find(p => p.name === w.name && p.type === w.type)) {
        allPastWorkouts.push({ ...w, fromDate: day.date });
      }
    }));

  // Also check today's workouts
  workouts.forEach(w => {
    if (!allPastWorkouts.find(p => p.name === w.name && p.type === w.type)) {
      allPastWorkouts.push({ ...w, fromDate: '' });
    }
  });

  const copySection = document.getElementById('copyPastSection');
  const pastList = document.getElementById('pastWorkoutsList');

  if (allPastWorkouts.length > 0) {
    copySection.style.display = 'block';
    pastList.innerHTML = allPastWorkouts.slice(0, 8).map(w => `
      <div class="past-workout-item" onclick="loadPastWorkout(${JSON.stringify(w).replace(/"/g, '&quot;')})">
        <div>
          <div class="past-workout-item-name">${w.icon} ${w.name} 路 ${w.duration} 拽转</div>
          <div class="past-workout-item-detail">${w.intensity} 路 砖专驻转 ${w.burned} 拽拽" 路 ${w.fromDate}</div>
        </div>
        <span style="color:var(--accent);font-size:12px;">注 </span>
      </div>
    `).join('');
  } else {
    copySection.style.display = 'none';
  }

  // Build type grid dynamically
  const grid = document.getElementById('workoutTypeGrid');
  grid.innerHTML = Object.entries(WORKOUT_TYPES).map(([k,v]) => `
    <button class="workout-type-btn" data-key="${k}" onclick="selectWorkoutType('${k}')">
      <span style="font-size:24px">${v.icon}</span>
      <span>${v.name}</span>
    </button>
  `).join('');

  // Reset rest of form
  selectedWorkoutType = null;
  selectedIntensity = 0.8;
  selectedDuration = null;
  document.getElementById('durationInput').value = '';
  document.getElementById('workoutNote').value = '';
  document.getElementById('burnPreview').style.display = 'none';
  document.querySelectorAll('.workout-type-btn').forEach(b => b.classList.remove('selected'));
  document.querySelectorAll('.intensity-btn').forEach((b,i) => b.classList.toggle('active', i===0));
  document.querySelectorAll('.dur-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('exerciseRows').innerHTML = '';
  document.getElementById('setsSection').style.display = 'none';
  exerciseIdCounter = 0;
  editingWorkoutId = null;
  document.getElementById('workoutModalTitle').textContent = ' 住祝 ';
  document.getElementById('workoutSaveBtn').textContent = ' 砖专 ';
  document.getElementById('workoutModal').classList.add('open');
}

function loadPastWorkout(w) {
  // Fill form with past workout data - user can then modify
  selectWorkoutType(w.type);
  const intensityMap = { '拽': 0.8, '转': 1.0, '': 1.25 };
  const intVal = intensityMap[w.intensity] || 1.0;
  selectedIntensity = intVal;
  document.querySelectorAll('.intensity-btn').forEach(b => {
    b.classList.toggle('active', parseFloat(b.dataset.val) === intVal);
  });
  setDuration(w.duration);
  document.getElementById('workoutNote').value = w.note || '';

  // Load exercises if any
  if (w.exercises && w.exercises.length > 0) {
    document.getElementById('exerciseRows').innerHTML = '';
    exerciseIdCounter = 0;
    showSetsSection(w.type);
    w.exercises.forEach(ex => {
      addExerciseRow();
      const id = exerciseIdCounter;
      document.getElementById(`exName-${id}`).value = ex.name || '';
      if (ex.muscles) {
        document.querySelectorAll(`#muscles-${id} .muscle-chip`).forEach(chip => {
          if (ex.muscles.includes(chip.textContent)) chip.classList.add('selected');
        });
      }
      if (ex.sets) {
        document.getElementById(`sets-${id}`).innerHTML = '';
        ex.sets.forEach(s => {
          const setsContainer = document.getElementById(`sets-${id}`);
          const setNum = setsContainer.children.length + 1;
          const setId = `set-${id}-${setNum}-${Date.now()}`;
          const setDiv = document.createElement('div');
          setDiv.className = 'set-row';
          setDiv.id = setId;
          setDiv.innerHTML = `
            <div class="set-num">${setNum}</div>
            <input type="number" class="set-input" placeholder="专转" min="1" max="200" id="reps-${setId}" value="${s.reps || ''}">
            <span class="set-label">专转</span>
            <span class="set-label" style="margin-right:4px;"></span>
            <input type="number" class="set-input" placeholder='拽"' min="0" max="999" step="0.5" id="weight-${setId}" value="${s.weight || ''}">
            <span class="set-label">拽"</span>
            <button class="set-delete" onclick="document.getElementById('${setId}').remove()"></button>
          `;
          setsContainer.appendChild(setDiv);
        });
      }
    });
  }

  showToast('  注  转 注专 驻 爪专');
}

// ===== COFFEE =====
function changeCoffee(delta) {
  const newVal = coffeeCups + delta;
  if (newVal < 0) return;
  if (newVal > MAX_COFFEE) {
    showToast('锔 注转 转 拽驻 转! (5 住转)');
    return;
  }

  // If adding coffee - add to meal log
  if (delta > 0) {
    const meal = {
      ...COFFEE_MEAL,
      id: Date.now(),
      time: new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' })
    };
    meals.push(meal);
    localStorage.setItem(`meals-${currentProfile}`, JSON.stringify(meals));
    renderMeals();
    updateDailySummary();
    showToast(' 拽驻 住祝 专砖!');
  } else {
    // Removing coffee - remove last coffee entry from meals
    const lastCoffeeIdx = meals.map((m, i) => ({m, i}))
      .filter(({m}) => m.name === COFFEE_MEAL.name)
      .pop();
    if (lastCoffeeIdx !== undefined) {
      meals.splice(lastCoffeeIdx.i, 1);
      localStorage.setItem(`meals-${currentProfile}`, JSON.stringify(meals));
      renderMeals();
      updateDailySummary();
    }
  }

  coffeeCups = newVal;
  localStorage.setItem(`coffee-${currentProfile}`, coffeeCups);
  renderCoffee();
}

function renderCoffee() {
  document.getElementById('coffeeCount').textContent = coffeeCups;

  // Status
  const status = document.getElementById('coffeeStatus');
  const plusBtn = document.getElementById('coffeePlusBtn');
  if (coffeeCups >= MAX_COFFEE) {
    status.textContent = ' 转 拽驻!';
    status.className = 'coffee-status limit';
    plusBtn.disabled = true;
  } else if (coffeeCups >= 3) {
    status.textContent = `锔 注 ${MAX_COFFEE - coffeeCups} 转专`;
    status.className = 'coffee-status ok';
    plusBtn.disabled = false;
  } else {
    status.textContent = coffeeCups > 0 ? ` ${MAX_COFFEE - coffeeCups} 转专` : '';
    status.className = 'coffee-status ok';
    plusBtn.disabled = false;
  }

  // Cup icons
  const cups = document.getElementById('coffeeCups');
  cups.innerHTML = Array.from({length: MAX_COFFEE}, (_, i) =>
    `<span class="coffee-cup ${i < coffeeCups ? '' : 'empty'}"></span>`
  ).join('');
}

function resetCoffee() {
  coffeeCups = 0;
  localStorage.setItem(`coffee-${currentProfile}`, 0);
  renderCoffee();
}

// ===== WATER =====
function changeWater(delta) {
  waterCups = Math.max(0, waterCups + delta);
  localStorage.setItem(`water-${currentProfile}`, waterCups);
  renderWater();
}

function renderWater() {
  const ml = waterCups * 160;
  const pct = Math.min((ml / 2000) * 100, 100);
  
  document.getElementById('waterCount').textContent = waterCups;
  document.getElementById('waterMl').textContent = `${ml.toLocaleString('he-IL')} " 转 1,5002,000 "`;
  
  const fill = document.getElementById('waterBarFill');
  fill.style.width = pct + '%';
  fill.classList.toggle('great', ml >= 2000);
  
  // Status badge
  const status = document.getElementById('waterStatus');
  if (ml === 0) {
    status.textContent = '';
    status.className = 'water-status';
  } else if (ml < 1500) {
    status.textContent = '锔 砖转 注!';
    status.className = 'water-status low';
  } else if (ml <= 2000) {
    status.textContent = '  !';
    status.className = 'water-status ok';
  } else {
    status.textContent = ' 爪!';
    status.className = 'water-status great';
  }
  
  // Cup icons
  const target = 13; // 13 cups = 2080ml  2 liters
  const cups = document.getElementById('waterCups');
  cups.innerHTML = Array.from({length: target}, (_, i) =>
    `<span class="water-cup ${i < waterCups ? '' : 'empty'}"></span>`
  ).join('');
}

function resetWater() {
  waterCups = 0;
  localStorage.setItem(`water-${currentProfile}`, 0);
  renderWater();
}

// ===== HELPERS =====
function fmt(val) {
  if (!val && val !== 0) return '0';
  const n = parseFloat(val);
  if (isNaN(n)) return '0';
  // If whole number - show without decimals, otherwise max 2 decimal places
  return Number.isInteger(n) ? n.toString() : parseFloat(n.toFixed(2)).toString();
}

// ===== INIT =====
function init() {
  updateProfileUI();
  renderMeals();
  updateDailySummary();
  loadSettingsInputs();
  renderHistory();
  initWifeVisibility();
  renderWater();
  renderCoffee();
  renderWorkouts();
  renderWeight();
}

// ===== SETTINGS =====
function toggleSettings() { document.getElementById('settingsPanel').classList.toggle('open'); }

function loadSettingsInputs() {
  ['me', 'wife'].forEach(p => {
    document.getElementById(`${p}-cal`).value = settings[p]?.cal ?? defaultSettings[p].cal;
    document.getElementById(`${p}-protein`).value = settings[p]?.protein ?? defaultSettings[p].protein;
    document.getElementById(`${p}-carbs`).value = settings[p]?.carbs ?? defaultSettings[p].carbs;
    document.getElementById(`${p}-sugar`).value = settings[p]?.sugar ?? defaultSettings[p].sugar;
  });

}

function saveSettings() {
  ['me', 'wife'].forEach(p => {
    settings[p] = { ...settings[p], cal: +document.getElementById(`${p}-cal`).value, protein: +document.getElementById(`${p}-protein`).value, carbs: +document.getElementById(`${p}-carbs`).value, sugar: +document.getElementById(`${p}-sugar`).value };
  });
  localStorage.setItem('nutritionSettings', JSON.stringify(settings));

  updateDailySummary();
  toggleSettings();
  showToast(' 专转 砖专!');
}



function toggleWifeProfile(show) {
  localStorage.setItem('showWife', show ? '1' : '0');
  applyWifeVisibility(show);
}

function applyWifeVisibility(show) {
  // Profile button
  const wifeBtns = document.querySelectorAll('.profile-btn');
  if (wifeBtns[1]) wifeBtns[1].style.display = show ? '' : 'none';
  // Wife settings section
  const wifeSections = document.querySelectorAll('.settings-section');
  if (wifeSections[1]) wifeSections[1].style.display = show ? '' : 'none';
  // If currently on wife profile and hiding, switch to me
  if (!show && currentProfile === 'wife') switchProfile('me');
  // Update toggle checkbox state
  const toggle = document.getElementById('showWifeToggle');
  if (toggle) toggle.checked = show;
}

function initWifeVisibility() {
  const show = localStorage.getItem('showWife') !== '0'; // default = show
  applyWifeVisibility(show);
}

// ===== PROFILE =====
function switchProfile(profile) {
  currentProfile = profile;
  localStorage.setItem('currentProfile', profile);
  meals = JSON.parse(localStorage.getItem(`meals-${profile}`)) || [];
  waterCups = parseInt(localStorage.getItem(`water-${profile}`) || '0');
  coffeeCups = parseInt(localStorage.getItem(`coffee-${profile}`) || '0');
  workouts = JSON.parse(localStorage.getItem(`workouts-${profile}`) || '[]');
  weightLog = JSON.parse(localStorage.getItem(`weightLog-${profile}`) || '[]');
  document.querySelectorAll('.profile-btn').forEach((btn, i) => {
    btn.classList.toggle('active', (i === 0 && profile === 'me') || (i === 1 && profile === 'wife'));
  });
  updateProfileUI();
  renderMeals();
  updateDailySummary();
  renderWater();
  renderCoffee();
  renderWorkouts();
  renderWeight();
}

function updateProfileUI() {
  const s = settings[currentProfile] || defaultSettings[currentProfile];
  document.getElementById('profileName').textContent = s.name || (currentProfile === 'me' ? '注' : '');
  document.getElementById('target-cal').textContent = s.cal;
  document.getElementById('target-protein').textContent = s.protein;
  document.getElementById('target-carbs').textContent = s.carbs;
  document.getElementById('target-sugar').textContent = s.sugar;
}

// ===== TABS =====
function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab-btn').forEach((btn, i) => btn.classList.toggle('active', (i === 0 && tab === 'text') || (i === 1 && tab === 'image')));
  document.querySelectorAll('.tab-content').forEach((c, i) => c.classList.toggle('active', (i === 0 && tab === 'text') || (i === 1 && tab === 'image')));
}

// ===== IMAGE =====
function openCamera() {
  document.getElementById('cameraFile').click();
}

function openGallery() {
  document.getElementById('imageFile').click();
}

function handleImageSelect(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    selectedImageBase64 = e.target.result.split(',')[1];
    document.getElementById('previewImg').src = e.target.result;
    document.getElementById('imagePreview').style.display = 'block';
    document.getElementById('imageDrop').style.display = 'none';
  };
  reader.readAsDataURL(file);
}

function removeImage() {
  selectedImageBase64 = null;
  document.getElementById('imageFile').value = '';
  document.getElementById('cameraFile').value = '';
  document.getElementById('imagePreview').style.display = 'none';
  document.getElementById('imageDrop').style.display = 'block';
}

// ===== ANALYZE =====
// ===== AI HELPER =====
async function callAI(bodyObj) {
  const inClaudeAI = window.location.hostname.includes('claude.ai') || window.location.hostname.includes('anthropic');
  if (inClaudeAI) {
    return fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(bodyObj)
    });
  } else {
    return fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(bodyObj)
    });
  }
}

async function analyzeFood() {
  const btn = document.getElementById('analyzeBtn');
  const spinner = document.getElementById('spinner');
  const btnText = document.getElementById('analyzeBtnText');
  const loadingMsg = document.getElementById('loadingMsg');
  let userDescription = '';
  let hasImage = false;

  if (currentTab === 'text') {
    userDescription = document.getElementById('foodText').value.trim();
    if (!userDescription) { showToast('锔  住 转专 砖 '); return; }
  } else {
    if (!selectedImageBase64) { showToast('锔  专 转'); return; }
    hasImage = true;
    userDescription = document.getElementById('imageNote').value.trim();
  }

  btn.disabled = true;
  spinner.style.display = 'block';
  btnText.textContent = '转...';
  loadingMsg.classList.add('visible');
  document.getElementById('resultCard').classList.remove('visible');

  const systemPrompt = `转  转 砖专. 注 驻专 JSON  ( markdown):
{"name":"砖 ","portions":"转专 转","calories":住驻专,"protein":住驻专,"carbs":住驻专,"fat":住驻专,"sugar":住驻专,"notes":"注专转 拽爪专转 注专转"}
 注专 专. 拽专转 拽拽".
砖 : 砖 "sugar" 爪 住专 住祝  (added sugar)   住专 注 驻专转, 专拽转,  . : 转驻, 转驻, , 注,   sugar=0. 砖, 住专 , 专, 砖拽, 爪 转拽  sugar 驻 转 转转.`;



  try {
    const messages = [];
    if (hasImage) {
      messages.push({ role: 'user', content: [{ type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: selectedImageBase64 } }, { type: 'text', text: `转 注专 转转 砖  转.${userDescription ? ' 注专转: ' + userDescription : ''}` }] });
    } else {
      messages.push({ role: 'user', content: `转 注专 转转: ${userDescription}` });
    }

    const response = await callAI({ model: 'claude-sonnet-4-20250514', max_tokens: 1000, system: systemPrompt, messages });

    const data = await response.json();
    const text = data.content?.[0]?.text || '';
    const jsonMatch = text.match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error(' 爪转 转 转 转砖');
    pendingResult = JSON.parse(jsonMatch[0]);
    showResult(pendingResult);
  } catch (err) {
    showToast(' 砖: ' + err.message);
  } finally {
    btn.disabled = false;
    spinner.style.display = 'none';
    btnText.textContent = ' 转 注专 转转';
    loadingMsg.classList.remove('visible');
  }
}

function showResult(result) {
  document.getElementById('resultMealName').textContent = result.name || '专';
  document.getElementById('resultPortions').textContent = result.portions || '';
  document.getElementById('r-cal').textContent = fmt(result.calories);
  document.getElementById('r-protein').textContent = fmt(result.protein);
  document.getElementById('r-carbs').textContent = fmt(result.carbs);
  document.getElementById('r-fat').textContent = fmt(result.fat);
  document.getElementById('r-sugar').textContent = fmt(result.sugar);
  document.getElementById('resultNotes').textContent = result.notes || '';
  document.getElementById('resultCard').classList.add('visible');
  document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function addToDay() {
  if (!pendingResult) return;
  meals.push({ ...pendingResult, id: Date.now(), time: new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }) });
  localStorage.setItem(`meals-${currentProfile}`, JSON.stringify(meals));
  renderMeals();
  updateDailySummary();
  discardResult();
  document.getElementById('foodText').value = '';
  removeImage();
  document.getElementById('imageNote').value = '';
  showToast(' 专 住驻 !');
}

function discardResult() {
  pendingResult = null;
  document.getElementById('resultCard').classList.remove('visible');
}

// ===== MEALS LOG =====
function renderMeals() {
  const log = document.getElementById('mealLog');
  if (meals.length === 0) {
    log.innerHTML = `<div class="empty-log"><div class="empty-icon">斤</div><div>注  住驻转 专转 </div><div style="margin-top:4px;font-size:12px">转  抓 "住祝  砖"</div></div>`;
    return;
  }
  log.innerHTML = meals.map((meal, i) => `
    <div class="meal-item">
      <div class="meal-info">
        <div class="meal-name">${meal.name} <span style="color:var(--text-dim);font-size:11px;font-weight:400">${meal.time}</span></div>
        <div class="meal-macros-mini">
          <span>ォ ${fmt(meal.protein)} 专 </span>
          <span> ${fmt(meal.carbs)} 专 驻'</span>
          <span> ${fmt(meal.sugar)} 专 住专</span>
          <span> ${fmt(meal.fat)} 专 砖</span>
        </div>
      </div>
      <div class="meal-cal">${fmt(meal.calories)} 拽拽"</div>
      <button class="delete-meal" onclick="deleteMeal(${i})">锔</button>
    </div>
  `).join('');
}

function deleteMeal(index) {
  meals.splice(index, 1);
  localStorage.setItem(`meals-${currentProfile}`, JSON.stringify(meals));
  renderMeals();
  updateDailySummary();
}

function transferMeals() {
  if (meals.length === 0) { showToast('锔  专转 注专'); return; }
  const targetProfile = currentProfile === 'me' ? 'wife' : 'me';
  const targetName = (settings[targetProfile] || defaultSettings[targetProfile]).name;
  const sourceName = (settings[currentProfile] || defaultSettings[currentProfile]).name;

  showConfirm(`注专 转  专转 ${sourceName}  ${targetName}?`, () => {
    // Load target meals
    const targetMeals = JSON.parse(localStorage.getItem(`meals-${targetProfile}`) || '[]');
    // Add current meals to target (merge)
    const merged = [...targetMeals, ...meals];
    localStorage.setItem(`meals-${targetProfile}`, JSON.stringify(merged));
    // Clear current profile
    meals = [];
    localStorage.setItem(`meals-${currentProfile}`, JSON.stringify(meals));
    renderMeals();
    updateDailySummary();
    showToast(` 专转 注专 ${targetName}!`);
  });
}

function resetDay() {
  showConfirm(" 驻住 转  专转 砖 ?", () => {
    meals = [];
    localStorage.setItem(`meals-${currentProfile}`, JSON.stringify(meals));
    renderMeals();
    updateDailySummary();
    resetWater();
    resetCoffee();
    resetWorkouts();
    showToast("  驻住!");
  });
}


// ===== DAILY SUMMARY =====
function getTotals() {
  return meals.reduce((acc, meal) => ({
    cal: acc.cal + (meal.calories || 0),
    protein: acc.protein + (meal.protein || 0),
    carbs: acc.carbs + (meal.carbs || 0),
    fat: acc.fat + (meal.fat || 0),
    sugar: acc.sugar + (meal.sugar || 0),
  }), { cal: 0, protein: 0, carbs: 0, fat: 0, sugar: 0 });
}

function updateDailySummary() {
  const s = settings[currentProfile] || defaultSettings[currentProfile];
  const totals = getTotals();
  const totalBurnedToday = workouts.reduce((sum, w) => sum + w.burned, 0);
  const netCal = totals.cal - totalBurnedToday;

  document.getElementById('total-cal').textContent = fmt(totals.cal);
  document.getElementById('total-protein').textContent = fmt(totals.protein);
  document.getElementById('total-carbs').textContent = fmt(totals.carbs);
  document.getElementById('total-fat').textContent = fmt(totals.fat);
  document.getElementById('total-sugar').textContent = fmt(totals.sugar);

  const calPct = Math.min((totals.cal / s.cal) * 100, 100);
  const calProgress = document.getElementById('cal-progress');
  calProgress.style.width = calPct + '%';
  calProgress.classList.toggle('over', totals.cal > s.cal);

  const proteinPct = Math.min((totals.protein / s.protein) * 100, 100);
  document.getElementById('protein-progress').style.width = proteinPct + '%';
  document.getElementById('protein-pct').textContent = Math.round(proteinPct);

  document.getElementById('target-cal').textContent = s.cal;
  document.getElementById('target-protein').textContent = s.protein;
  document.getElementById('target-carbs').textContent = s.carbs;
  document.getElementById('target-sugar').textContent = s.sugar;

  // Workout calories row
  const workoutSection = document.getElementById('workout-cal-section');
  if (totalBurnedToday > 0) {
    workoutSection.style.display = 'block';
    document.getElementById('summary-burned').textContent = fmt(totalBurnedToday);
    document.getElementById('summary-net').textContent = fmt(netCal) + ' 拽拽"';
    const diff = netCal - s.cal;
    const diffEl = document.getElementById('summary-net-diff');
    if (diff > 0) {
      diffEl.textContent = `+${fmt(diff)} 注 注`;
      diffEl.style.color = 'var(--accent2)';
    } else {
      diffEl.textContent = `${fmt(Math.abs(diff))} 转转 注 `;
      diffEl.style.color = 'var(--accent)';
    }
  } else {
    workoutSection.style.display = 'none';
  }

  const alertsList = [];
  // Use net calories for alerts when there's a workout
  const calForAlert = totalBurnedToday > 0 ? netCal : totals.cal;
  if (calForAlert > s.cal) alertsList.push(`<div class="alert warning">锔 专转 住 拽专转! (${fmt(calForAlert - s.cal)} 拽拽" 注${totalBurnedToday > 0 ? ' ' : ''})</div>`);
  else if (calForAlert >= s.cal * 0.9) alertsList.push(`<div class="alert info"> 拽专 住  砖专 ${fmt(s.cal - calForAlert)} 拽拽"${totalBurnedToday > 0 ? ' ' : ''}</div>`);
  if (totals.protein >= s.protein) alertsList.push(`<div class="alert success"> 注转 注 ! (${fmt(totals.protein)}/${s.protein} 专)</div>`);
  else if (meals.length > 0) alertsList.push(`<div class="alert info"> 注 ${fmt(s.protein - totals.protein)} 专  注</div>`);
  if (totals.sugar > s.sugar) alertsList.push(`<div class="alert warning"> 专转 住专 ! (${fmt(totals.sugar)}/${s.sugar} 专)</div>`);
  if (totals.carbs > s.carbs) alertsList.push(`<div class="alert warning"> 专转 驻转 转! (${fmt(totals.carbs)}/${s.carbs} 专)</div>`);
  if (totalBurnedToday > 0) alertsList.push(`<div class="alert info"> 砖专驻转 ${fmt(totalBurnedToday)} 拽拽"    ${fmt(netCal)} 拽拽"</div>`);
  document.getElementById('alerts').innerHTML = alertsList.join('');
}

// ===== CHAT =====
function buildContextForChat() {
  const s = settings[currentProfile] || defaultSettings[currentProfile];
  const totals = getTotals();
  const profileName = s.name;
  const isMe = currentProfile === 'me';

  let context = `转 注抓 转  砖. 砖转砖 驻注  ${profileName}.`;
  if (isMe) context += ` ${profileName}  住专转 住 2, 砖  转住 专转 住专 转 .`;
  else context += ` ${profileName} 注砖  专 砖拽.`;

  context += `\n\n注  砖 ${profileName}:
- 拽专转 拽住: ${s.cal} 拽拽"
-  : ${s.protein} 专
- 驻转 拽住: ${s.carbs} 专
- 住专 拽住: ${s.sugar} 专`;

  context += `\n\n ${profileName} 专 / :`;
  if (meals.length === 0) {
    context += '\n注  /  .';
  } else {
    meals.forEach(m => { context += `\n- ${m.name}: ${m.calories} 拽拽", ${m.protein} 专 , ${m.carbs} 专 驻转, ${m.sugar} 专 住专`; });
    context += `\n\n住" 注 注砖: ${totals.cal} 拽拽", ${totals.protein} 专 , ${totals.carbs} 专 驻转, ${totals.sugar} 专 住专`;
    context += `\n砖专 注 注 : ${Math.max(0, s.protein - totals.protein)} 专`;
    context += `\n砖专 注 住转 拽专转: ${Math.max(0, s.cal - totals.cal)} 拽拽"`;
  }

  context += '\n\n注 转 注专转, 爪专 转转 注砖转. 转 爪转 住驻爪驻转 注 转 专.';
  return context;
}

async function sendChatMessage() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  input.style.height = '42px';
  await processChat(msg);
}

async function sendSuggestion(text) {
  await processChat(text);
}

async function processChat(userMsg) {
  const sendBtn = document.getElementById('chatSendBtn');
  sendBtn.disabled = true;

  // Hide welcome
  const welcome = document.getElementById('chatWelcome');
  if (welcome) welcome.style.display = 'none';

  // Add user message
  appendMessage('user', userMsg);
  chatHistory.push({ role: 'user', content: userMsg });

  // Show typing
  const typingEl = appendTyping();

  try {
    const response = await callAI({ model: 'claude-sonnet-4-20250514', max_tokens: 1000, system: buildContextForChat(), messages: chatHistory });

    const data = await response.json();
    const reply = data.content?.[0]?.text || '爪注专,  爪转 注转.';

    typingEl.remove();
    appendMessage('ai', reply);
    chatHistory.push({ role: 'assistant', content: reply });

    // Keep history manageable
    if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);

  } catch (err) {
    typingEl.remove();
    appendMessage('ai', ' 砖 专.  住 砖.');
  } finally {
    sendBtn.disabled = false;
  }
}

function appendMessage(role, text) {
  const chatMessages = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  div.innerHTML = `
    <div class="msg-avatar">${role === 'user' ? '' : ''}</div>
    <div class="msg-bubble">${escapeHtml(text)}</div>
  `;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return div;
}

function appendTyping() {
  const chatMessages = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'msg ai msg-typing';
  div.innerHTML = `<div class="msg-avatar"></div><div class="msg-bubble"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return div;
}

function escapeHtml(text) {
  return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}

function clearChat() {
  chatHistory = [];
  const chatMessages = document.getElementById('chatMessages');
  chatMessages.innerHTML = `<div class="chat-welcome" id="chatWelcome">
    <div class="welcome-icon"></div>
    <h3>砖!  注抓 转转 砖</h3>
    <p> 注  转   注 砖.<br>砖 转  砖   砖,  住祝,  转 住专转 注.</p>
    <div class="chat-suggestions">
      <button class="suggestion-chip" onclick="sendSuggestion('    专转 注专  注 注 ?')">   专转 注专?</button>
      <button class="suggestion-chip" onclick="sendSuggestion('  砖专  注 注 ?')">   砖专 ?</button>
      <button class="suggestion-chip" onclick="sendSuggestion('爪注  专转 拽专 注砖专  转 住专 住专转')"> 专转 拽专 住专转</button>
      <button class="suggestion-chip" onclick="sendSuggestion(' 专爪  注祝 注 专拽转,   抓 住专转?')"> 转 注祝 注 专拽转</button>
      <button class="suggestion-chip" onclick="sendSuggestion('    砖砖  专 ?')"> 砖砖 </button>
      <button class="suggestion-chip" onclick="sendSuggestion('转  转驻专  砖 注 97 专  住专转')"> 转驻专  砖</button>
    </div>
  </div>`;
}

function handleChatKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChatMessage(); }
}

function autoResize(el) {
  el.style.height = '42px';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}


// ===== CONFIRM DIALOG =====
function showConfirm(message, onConfirm) {
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9998;display:flex;align-items:center;justify-content:center;';
  overlay.innerHTML = `
    <div style="background:#1a1d27;border:1px solid rgba(255,255,255,0.1);border-radius:20px;padding:28px;max-width:320px;width:90%;text-align:center;font-family:Heebo,sans-serif;">
      <div style="font-size:32px;margin-bottom:12px;">锔</div>
      <div style="font-size:16px;color:#e8eaf0;margin-bottom:8px;font-weight:700;">砖专</div>
      <div style="font-size:14px;color:#8892a4;margin-bottom:24px;">${message}</div>
      <div style="display:flex;gap:10px;">
        <button onclick="this.closest('[style]').remove()" style="flex:1;padding:10px;background:transparent;border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#8892a4;cursor:pointer;font-family:Heebo,sans-serif;font-size:14px;"></button>
        <button id="confirmOkBtn" style="flex:1;padding:10px;background:#ff6b6b;border:none;border-radius:10px;color:#000;font-weight:700;cursor:pointer;font-family:Heebo,sans-serif;font-size:14px;">驻住</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  overlay.querySelector('#confirmOkBtn').onclick = () => { overlay.remove(); onConfirm(); };
  overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
}

// ===== BACKUP / RESTORE =====
function exportData() {
  const data = {
    version: 1,
    exportDate: new Date().toISOString(),
    nutritionSettings: localStorage.getItem('nutritionSettings'),
    dayHistory: localStorage.getItem('dayHistory'),
    currentProfile: localStorage.getItem('currentProfile'),
    showWife: localStorage.getItem('showWife'),
    'meals-me': localStorage.getItem('meals-me'),
    'meals-wife': localStorage.getItem('meals-wife'),
    'water-me': localStorage.getItem('water-me'),
    'water-wife': localStorage.getItem('water-wife'),
    'coffee-me': localStorage.getItem('coffee-me'),
    'coffee-wife': localStorage.getItem('coffee-wife'),
    'workouts-me': localStorage.getItem('workouts-me'),
    'workouts-wife': localStorage.getItem('workouts-wife'),
    'weightLog-me': localStorage.getItem('weightLog-me'),
    'weightLog-wife': localStorage.getItem('weightLog-wife'),
  };
  const json = JSON.stringify(data);

  // Try clipboard API first
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(json).then(() => {
      showToast(' 转 注转拽 ! 注砖 拽 驻拽爪 砖');
    }).catch(() => showExportModal(json));
  } else {
    showExportModal(json);
  }
}

function showExportModal(json) {
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px;';
  overlay.innerHTML = `
    <div style="background:#1a1d27;border:1px solid rgba(255,255,255,0.1);border-radius:20px;padding:24px;width:100%;max-width:500px;max-height:80vh;display:flex;flex-direction:column;gap:12px;">
      <div style="font-size:16px;font-weight:700;color:#e8eaf0;"> 注转拽 转 转</div>
      <div style="font-size:12px;color:#8892a4;">住   注转拽  砖专 爪</div>
      <textarea style="flex:1;min-height:200px;background:#22263a;border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#e8eaf0;font-size:11px;padding:10px;font-family:monospace;resize:none;" readonly onclick="this.select()">${json}</textarea>
      <div style="display:flex;gap:10px;">
        <button onclick="this.closest('[style]').remove()" style="flex:1;padding:10px;background:transparent;border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#8892a4;cursor:pointer;font-family:'Heebo',sans-serif;">住专</button>
        <button onclick="navigator.clipboard.writeText(document.querySelector('textarea').value);this.textContent=' 注转拽!'" style="flex:1;padding:10px;background:#00d4aa;border:none;border-radius:10px;color:#000;font-weight:700;cursor:pointer;font-family:'Heebo',sans-serif;"> 注转拽 </button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
}

function openImportModal() {
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px;';
  overlay.innerHTML = `
    <div style="background:#1a1d27;border:1px solid rgba(255,255,255,0.1);border-radius:20px;padding:24px;width:100%;max-width:500px;max-height:80vh;display:flex;flex-direction:column;gap:12px;">
      <div style="font-size:16px;font-weight:700;color:#e8eaf0;"> 拽 转</div>
      <div style="font-size:12px;color:#8892a4;">拽  转 -JSON 砖注转拽转 驻拽爪 砖</div>
      <textarea id="importTextarea" style="flex:1;min-height:200px;background:#22263a;border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#e8eaf0;font-size:11px;padding:10px;font-family:monospace;resize:none;" placeholder="拽 ..."></textarea>
      <div style="display:flex;gap:10px;">
        <button onclick="this.closest('[style]').remove()" style="flex:1;padding:10px;background:transparent;border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#8892a4;cursor:pointer;font-family:'Heebo',sans-serif;"></button>
        <button onclick="importData(document.getElementById('importTextarea').value);this.closest('[style]').remove()" style="flex:1;padding:10px;background:#ffd93d;border:none;border-radius:10px;color:#000;font-weight:700;cursor:pointer;font-family:'Heebo',sans-serif;"> 砖专 转</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
}

function importData(json) {
  try {
    const data = JSON.parse(json);
    if (!data.version || !data.dayHistory) {
      showToast(' 转  转拽');
      return;
    }
    const keys = ['nutritionSettings','dayHistory','currentProfile','showWife',
      'meals-me','meals-wife','water-me','water-wife',
      'coffee-me','coffee-wife','workouts-me','workouts-wife',
      'weightLog-me','weightLog-wife'];
    keys.forEach(key => { if (data[key]) localStorage.setItem(key, data[key]); });
    showToast(' 转 砖专! 注 砖...');
    setTimeout(() => location.reload(), 1500);
  } catch(err) {
    showToast(' 砖  拽 砖拽住 转拽');
  }
}

// ===== TOAST =====
function showToast(msg) {
  const toast = document.createElement('div');
  toast.style.cssText = `position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--accent);color:var(--text);padding:12px 24px;border-radius:12px;font-size:14px;z-index:9999;box-shadow:0 8px 30px rgba(0,0,0,0.4);font-family:'Heebo',sans-serif;`;
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

init();
</script>

</body>
</html>
